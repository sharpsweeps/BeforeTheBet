<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>BeforeTheBet ‚Äì Demo MVP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      :root {
        color-scheme: dark;
        --bg: #020617;
        --card: #020617;
        --border: #1e293b;
        --text: #e2e8f0;
        --muted: #64748b;

        /* bias colors */
        --bias-blue: #3b82f6;
        --bias-green: #22c55e;

        /* ui */
        --danger: #ef4444;
      }

      [data-theme="light"] {
        color-scheme: light;
        --bg: #f8fafc;
        --card: #ffffff;
        --border: #e2e8f0;
        --text: #0f172a;
        --muted: #475569;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #0f172a 0, #020617 55%);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      [data-theme="light"] body {
        background: radial-gradient(circle at top, #e2e8f0 0, #f8fafc 60%);
      }

      .app-shell {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header,
      footer {
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        border-bottom: 1px solid var(--border);
        backdrop-filter: blur(10px);
        background: linear-gradient(
          to bottom,
          rgba(15, 23, 42, 0.9),
          rgba(15, 23, 42, 0.4)
        );
        z-index: 10;
      }

      [data-theme="light"] header,
      [data-theme="light"] footer {
        background: linear-gradient(
          to bottom,
          rgba(248, 250, 252, 0.95),
          rgba(248, 250, 252, 0.7)
        );
      }

      footer {
        border-top: 1px solid var(--border);
        border-bottom: none;
        background: linear-gradient(
          to top,
          rgba(15, 23, 42, 0.9),
          rgba(15, 23, 42, 0.4)
        );
        justify-content: center;
        font-size: 11px;
        color: var(--muted);
      }

      [data-theme="light"] footer {
        background: linear-gradient(
          to top,
          rgba(248, 250, 252, 0.95),
          rgba(248, 250, 252, 0.7)
        );
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .logo-group {
        position: relative;
        display: flex;
        align-items: center;
      }

      .logo-button {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: transparent;
        cursor: pointer;
      }

      .logo-button:hover {
        border-color: #1f2937;
        background: rgba(15, 23, 42, 0.85);
      }

      [data-theme="light"] .logo-button:hover {
        border-color: #cbd5e1;
        background: rgba(241, 245, 249, 0.9);
      }

      .logo {
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .logo-caret {
        font-size: 10px;
        color: var(--muted);
      }

      .sports-menu {
        position: absolute;
        top: 110%;
        left: 0;
        background: var(--card);
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
        padding: 8px 0;
        min-width: 240px;
        display: none;
        z-index: 60;
      }

      .sports-menu.open {
        display: block;
      }

      .sports-menu-item {
        padding: 8px 12px;
        font-size: 12px;
        color: var(--text);
        cursor: default;
      }

      .sports-menu-item:hover {
        background: rgba(15, 23, 42, 0.45);
      }

      [data-theme="light"] .sports-menu-item:hover {
        background: rgba(226, 232, 240, 0.8);
      }

      .sports-menu-item-title {
        font-weight: 600;
        margin-bottom: 6px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-size: 11px;
        color: var(--muted);
      }

      .sports-games-submenu {
        padding-left: 8px;
        border-left: 1px solid var(--border);
        margin-left: 4px;
      }

      .game-item {
        font-size: 11px;
        color: var(--muted);
        padding: 5px 0;
        cursor: pointer;
        user-select: none;
      }

      .game-item:hover {
        color: var(--text);
      }

      #back-to-sports {
        display: none;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.95);
        color: var(--muted);
        font-size: 11px;
        padding: 4px 10px;
        cursor: pointer;
      }

      [data-theme="light"] #back-to-sports {
        background: rgba(241, 245, 249, 0.95);
      }

      #back-to-sports:hover {
        border-color: #334155;
        color: var(--text);
      }

      .user-menu-wrapper {
        position: relative;
      }

      .menu-placeholder {
        font-size: 11px;
        color: var(--muted);
        cursor: pointer;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: transparent;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .menu-placeholder:hover {
        border-color: #1f2937;
        color: var(--text);
        background: rgba(15, 23, 42, 0.8);
      }

      [data-theme="light"] .menu-placeholder:hover {
        border-color: #cbd5e1;
        background: rgba(241, 245, 249, 0.9);
      }

      .user-dropdown {
        position: absolute;
        right: 0;
        top: 110%;
        background: var(--card);
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
        min-width: 200px;
        padding: 6px 0;
        display: none;
        z-index: 60;
      }

      .user-dropdown.open {
        display: block;
      }

      .user-dropdown-item {
        padding: 8px 12px;
        font-size: 12px;
        cursor: pointer;
        color: var(--text);
        user-select: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .user-dropdown-item:hover {
        background: rgba(15, 23, 42, 0.45);
      }

      [data-theme="light"] .user-dropdown-item:hover {
        background: rgba(226, 232, 240, 0.8);
      }

      .user-dropdown-separator {
        border-top: 1px solid var(--border);
        margin: 6px 0;
      }

      .toggle-pill {
        height: 18px;
        width: 34px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.65);
        position: relative;
        flex: none;
      }

      [data-theme="light"] .toggle-pill {
        background: rgba(226, 232, 240, 0.9);
      }

      .toggle-dot {
        height: 14px;
        width: 14px;
        border-radius: 999px;
        background: var(--text);
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        left: 2px;
        transition: left 0.18s ease;
      }

      .toggle-pill.on .toggle-dot {
        left: 18px;
      }

      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: center;
        padding: 24px 16px;
      }

      .content {
        max-width: 960px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 24px;
        align-items: stretch;
      }

      .title-block {
        text-align: center;
      }

      .title-block h1 {
        font-size: 28px;
        margin: 0 0 8px;
      }

      .title-block p {
        margin: 0;
        font-size: 14px;
        color: var(--muted);
      }

      .title-block .directions {
        margin-top: 6px;
        font-size: 12px;
        color: var(--muted);
      }

      @media (min-width: 768px) {
        .title-block h1 {
          font-size: 32px;
        }
        .title-block .directions {
          font-size: 13px;
        }
      }

      /* card stack */
      .card-container {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .card-click-area {
        position: relative;
        width: 100%;
        max-width: 380px;
        aspect-ratio: 2.5 / 3.5;
        perspective: 1200px;
        cursor: pointer;
      }

      @media (min-width: 1024px) {
        .card-click-area {
          max-width: 420px;
        }
      }

      .card,
      .stack-card {
        position: absolute;
        inset: 0;
        border-radius: 24px;
        border: 1px solid var(--border);
        background: radial-gradient(circle at top, var(--card), var(--card));
        box-shadow: 0 22px 40px rgba(0, 0, 0, 0.35);
        overflow: hidden;
      }

      .card-main {
        transform-style: preserve-3d;
        transition: transform 0.5s ease;
        z-index: 3;
      }

      .stack-card {
        pointer-events: none;
        opacity: 0.55;
        z-index: 0;
      }

      .stack-card.stack-1 {
        transform: translateY(10px) translateX(6px) scale(0.97);
      }

      .stack-card.stack-2 {
        transform: translateY(18px) translateX(10px) scale(0.94);
        opacity: 0.4;
      }

      .stack-card.stack-3 {
        transform: translateY(26px) translateX(14px) scale(0.9);
        opacity: 0.25;
      }

      .card-face {
        position: absolute;
        inset: 0;
        padding: 18px 16px 14px;
        display: flex;
        flex-direction: column;
        backface-visibility: hidden;
      }

      .card-front {
        align-items: center;
        text-align: center;
        justify-content: center;
        gap: 12px;
        transform: rotateY(0deg);
        transition: transform 0.5s ease;
      }

      .card-back {
        transform: rotateY(180deg);
        justify-content: flex-start;
        transition: transform 0.5s ease;
      }

      .card-main.flipped .card-front {
        transform: rotateY(-180deg);
      }

      .card-main.flipped .card-back {
        transform: rotateY(0deg);
      }

      /* logo + labels */
      .sport-logo-circle {
        width: 120px;
        height: 120px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 42px;
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.35);
      }

      .sport-logo-nba {
        background: radial-gradient(circle at top left, #38bdf8, #0ea5e9);
      }
      .sport-logo-nfl {
        background: radial-gradient(circle at top left, #4ade80, #22c55e);
      }
      .sport-logo-hub {
        background: radial-gradient(circle at top left, #60a5fa, #2563eb);
      }
      .sport-logo-locks {
        background: radial-gradient(circle at top left, #22c55e, #16a34a);
      }
      .sport-logo-archive {
        background: radial-gradient(circle at top left, #94a3b8, #475569);
      }

      .sport-front-name {
        font-size: 18px;
        font-weight: 600;
        margin-top: 10px;
      }

      .sport-front-code {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: var(--muted);
        margin-top: 4px;
      }

      .tap-hint {
        position: absolute;
        bottom: 10px;
        right: 14px;
        font-size: 10px;
        color: #6b7280;
        pointer-events: none;
      }

      .index-indicator {
        position: absolute;
        bottom: 10px;
        left: 14px;
        font-size: 10px;
        color: #6b7280;
      }

      /* back content */
      .back-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 8px;
        margin-bottom: 8px;
      }

      .back-title {
        font-size: 16px;
        font-weight: 700;
      }

      .back-sub {
        font-size: 11px;
        color: var(--muted);
        text-align: right;
      }

      .matchups-list {
        margin-top: 6px;
        flex: 1;
        overflow-y: auto;
        padding-right: 4px;
      }

      .matchup-card {
        border-radius: 18px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.55);
        padding: 10px 10px 8px;
        margin-bottom: 8px;
        position: relative;
        transition: transform 0.18s ease, opacity 0.18s ease;
        user-select: none;
      }

      [data-theme="light"] .matchup-card {
        background: rgba(248, 250, 252, 0.98);
      }

      .matchup-card.swiped {
        opacity: 0.55;
        pointer-events: none;
      }

      .matchup-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 6px;
        margin-bottom: 6px;
      }

      .matchup-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text);
      }

      .matchup-line {
        font-size: 11px;
        color: var(--muted);
        margin-top: 2px;
      }

      .matchup-tag {
        font-size: 11px;
        color: var(--muted);
        text-align: right;
        white-space: nowrap;
      }

      /* bias bar */
      .bias-bar-container {
        margin-top: 6px;
      }

      .bias-bar-bg {
        height: 9px;
        border-radius: 999px;
        background: rgba(2, 6, 23, 0.55);
        overflow: hidden;
        border: 1px solid var(--border);
      }

      .bias-bar-fill {
        height: 100%;
        border-radius: 999px;
        transition: width 0.25s ease;
      }

      .bias-labels {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        margin-top: 3px;
      }

      .bias-labels span:first-child {
        color: var(--muted);
        font-weight: 600;
      }

      .bias-labels span:last-child {
        color: var(--muted);
        font-weight: 600;
      }

      .bias-helper {
        margin-top: 4px;
        font-size: 10px;
        color: var(--muted);
      }

      .back-footer-note {
        margin-top: 8px;
        font-size: 11px;
        color: var(--muted);
      }

      .category-header {
        margin: 10px 2px 6px;
        font-size: 11px;
        color: #9ca3af;
        text-transform: uppercase;
        letter-spacing: 0.16em;
      }

      /* toast */
      .swipe-toast {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: rgba(15, 23, 42, 0.96);
        border-radius: 999px;
        border: 1px solid var(--border);
        padding: 8px 14px;
        font-size: 12px;
        color: var(--text);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease, transform 0.2s ease;
        z-index: 90;
        white-space: nowrap;
      }

      [data-theme="light"] .swipe-toast {
        background: rgba(15, 23, 42, 0.92);
        color: #fff;
      }

      .swipe-toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      /* buttons */
      .sportsbook-cta-btn {
        width: 100%;
        margin-top: 6px;
        padding: 8px 10px;
        border-radius: 999px;
        border: none;
        font-size: 12px;
        font-weight: 800;
        cursor: pointer;
        background: var(--bias-green);
        color: #020617;
      }

      .sportsbook-cta-btn:disabled {
        opacity: 0.7;
        cursor: default;
      }

      /* AUTH overlay */
      #auth-overlay {
        position: fixed;
        inset: 0;
        background: radial-gradient(
          circle at top,
          rgba(15, 23, 42, 0.9),
          rgba(2, 6, 23, 0.98)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 120;
      }

      #auth-overlay.hidden {
        display: none !important;
      }

      .auth-card {
        width: 100%;
        max-width: 380px;
        background: var(--card);
        border-radius: 24px;
        border: 1px solid var(--border);
        padding: 20px 18px 16px;
        box-shadow: 0 26px 60px rgba(0, 0, 0, 0.45);
      }

      .auth-title {
        font-size: 18px;
        font-weight: 800;
        margin-bottom: 6px;
      }

      .auth-subtitle {
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 12px;
        line-height: 1.35;
      }

      .auth-field {
        margin-bottom: 10px;
      }

      .auth-field label {
        display: block;
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 4px;
      }

      .auth-field input {
        width: 100%;
        padding: 9px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text);
        font-size: 12px;
      }

      .auth-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
      }

      .auth-primary,
      .auth-secondary {
        flex: 1;
        padding: 10px 12px;
        border-radius: 999px;
        border: none;
        font-size: 12px;
        cursor: pointer;
        font-weight: 800;
      }

      .auth-primary {
        background: var(--bias-green);
        color: #020617;
      }

      .auth-secondary {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--muted);
      }

      .auth-msg {
        margin-top: 10px;
        font-size: 11px;
        color: var(--muted);
        line-height: 1.35;
        min-height: 16px;
      }

      .auth-msg.error {
        color: #fecaca;
      }

      [data-theme="light"] .auth-msg.error {
        color: #b91c1c;
      }

      /* In-app modal (NOT system alert) */
      #modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.55);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 130;
      }

      #modal-overlay.open {
        display: flex;
      }

      .modal-card {
        width: min(420px, 92vw);
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 14px 14px 12px;
        box-shadow: 0 28px 70px rgba(0, 0, 0, 0.5);
      }

      .modal-title {
        font-weight: 900;
        font-size: 13px;
        margin-bottom: 6px;
      }

      .modal-sub {
        font-size: 11px;
        color: var(--muted);
        line-height: 1.35;
        margin-bottom: 10px;
      }

      .modal-actions {
        display: flex;
        gap: 8px;
      }

      .modal-btn {
        flex: 1;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text);
        font-weight: 900;
        font-size: 12px;
        cursor: pointer;
      }

      .modal-btn.primary {
        background: var(--bias-green);
        color: #020617;
        border: none;
      }

      .modal-btn.danger {
        background: var(--danger);
        color: #fff;
        border: none;
      }

      /* Small screen tweaks */
      @media (max-width: 480px) {
        .card-click-area {
          max-width: 340px;
        }
        .sport-logo-circle {
          width: 104px;
          height: 104px;
          font-size: 36px;
        }
        .swipe-toast {
          font-size: 11px;
          max-width: 90%;
          white-space: normal;
          text-align: center;
        }
      }
    </style>
  </head>

  <body>
    <div class="app-shell">
      <header>
        <div class="header-left">
          <div class="logo-group" id="logo-group">
            <button id="app-logo-button" class="logo-button" type="button">
              <span class="logo">BEFORETHEBET</span>
              <span class="logo-caret">‚ñæ</span>
            </button>
            <div id="sports-menu" class="sports-menu"></div>
          </div>
          <button id="back-to-sports" type="button">‚Üê Back</button>
        </div>

        <div class="user-menu-wrapper" id="user-menu-wrapper">
          <button class="menu-placeholder" id="user-menu-button" type="button">
            <span id="user-menu-label">My Hub</span>
            <span>‚ñæ</span>
          </button>
          <div class="user-dropdown" id="user-dropdown"></div>
        </div>
      </header>

      <main>
        <div class="content">
          <div class="title-block">
            <h1 id="main-title">Select Your Sport</h1>
            <p id="subtitle">Flip the card to preview matchups.</p>
            <div class="directions" id="directions">
              Tap <strong>center</strong> to flip. Use the <strong>left edge</strong> /
              <strong>right edge</strong> to switch sports or games. Double-tap
              center to open the sport or open all lines.
              <br />
              <span style="opacity: 0.85">
                Swiping lines requires login.
              </span>
            </div>
          </div>

          <div class="card-container">
            <div class="card-click-area" id="card-click-area">
              <div class="stack-card stack-3"></div>
              <div class="stack-card stack-2"></div>
              <div class="stack-card stack-1"></div>

              <div class="card card-main" id="sport-card">
                <!-- FRONT -->
                <div class="card-face card-front" id="card-front">
                  <div class="sport-logo-circle" id="sport-logo"></div>
                  <div class="sport-front-name" id="sport-name"></div>
                  <div class="sport-front-code" id="sport-code"></div>
                  <div class="tap-hint" id="tap-hint-front">Tap center to flip ‚Üª</div>
                  <div class="index-indicator" id="index-indicator"></div>
                </div>

                <!-- BACK -->
                <div class="card-face card-back" id="card-back">
                  <div class="back-header">
                    <div class="back-title" id="back-title"></div>
                    <div class="back-sub" id="back-sub"></div>
                  </div>

                  <div class="matchups-list" id="matchups-list"></div>

                  <div class="back-footer-note" id="back-footer-note">
                    <span style="color: var(--muted)">
                      Swipe right = <strong>Confident</strong> ‚úÖ ‚Ä¢ Swipe left =
                      <strong>Doubt it</strong> ü§î
                    </span>
                  </div>

                  <div class="tap-hint" id="tap-hint-back">Double-tap center to flip ‚Ü∫</div>
                  <div class="index-indicator" id="index-indicator-back"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <footer>BeforeTheBet ‚Ä¢ Demo MVP</footer>
    </div>

    <!-- AUTH OVERLAY (LOGIN REQUIRED TO SWIPE) -->
    <div id="auth-overlay">
      <div class="auth-card">
        <div class="auth-title">Sign in to swipe</div>
        <div class="auth-subtitle">
          Swiping is locked until you‚Äôre authenticated. (We‚Äôll add phone + 2-step next.)
        </div>

        <div class="auth-field">
          <label for="auth-email">Email</label>
          <input id="auth-email" type="email" placeholder="you@email.com" />
        </div>

        <div class="auth-field">
          <label for="auth-password">Password</label>
          <input id="auth-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>

        <div class="auth-actions">
          <button class="auth-secondary" id="btn-signup" type="button">Create Account</button>
          <button class="auth-primary" id="btn-signin" type="button">Sign In</button>
        </div>

        <div class="auth-msg" id="auth-msg"></div>
      </div>
    </div>

    <!-- IN-APP MODAL -->
    <div id="modal-overlay">
      <div class="modal-card">
        <div class="modal-title" id="modal-title">Action</div>
        <div class="modal-sub" id="modal-sub">Details‚Ä¶</div>
        <div class="modal-actions" id="modal-actions"></div>
      </div>
    </div>

    <div class="swipe-toast" id="swipe-toast"></div>

    <!-- SUPABASE -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      /**************************************************************
       * NOTE (CTO):
       * To persist Locks/Bias across devices, you need a Supabase table.
       * This code will TRY to read/write to "btb_swipes". If it doesn't exist,
       * it falls back to localStorage (per-user).
       *
       * Suggested columns:
       *  - user_id (text)
       *  - key (text) UNIQUE per user (or composite unique)
       *  - status (text)  // inbox | lock | archived
       *  - vote (text)    // confident | doubt
       *  - payload (jsonb)
       *  - updated_at (timestamptz)
       **************************************************************/

      // ---------- App constants ----------
      const APP_NAME = "BeforeTheBet";
      const SWIPES_TO_UNLOCK_COMMUNITY = 5;

      const CATEGORY_LABELS = {
        spread: "Spreads",
        total: "Totals",
        points: "Points",
        props: "Props",
        alt: "Alternates",
        moneyline: "Moneylines",
        other: "Other",
      };

      const CATEGORY_ORDER = ["spread", "total", "moneyline", "points", "props", "alt", "other"];

      // ---------- Demo Sports data (MLB removed) ----------
      const SPORTS = [
        {
          id: "nfl",
          name: "NFL",
          code: "National Football League",
          logoClass: "sport-logo-nfl",
          emoji: "üèà",
          matchups: [
            {
              name: "Chiefs @ Bills",
              lines: [
                { label: "Mahomes o1.5 Passing TDs", confident: 68, doubt: 32, category: "props", book: "FanDuel" },
                { label: "Allen o36.5 Rush Yards", confident: 57, doubt: 43, category: "props", book: "BetMGM" },
                { label: "Total 51.5", confident: 54, doubt: 46, category: "total", book: "ESPN BET" },
                { label: "Chiefs -2.5", confident: 52, doubt: 48, category: "spread", book: "PointsBet" },
              ],
            },
            {
              name: "Eagles @ Cowboys",
              lines: [
                { label: "Hurts o44.5 Rush Yards", confident: 55, doubt: 45, category: "props", book: "FanDuel" },
                { label: "Eagles +3.5", confident: 58, doubt: 42, category: "spread", book: "BetMGM" },
                { label: "Total 48.5", confident: 51, doubt: 49, category: "total", book: "Caesars" },
              ],
            },
          ],
        },
        {
          id: "nba",
          name: "NBA",
          code: "National Basketball Association",
          logoClass: "sport-logo-nba",
          emoji: "üèÄ",
          matchups: [
            {
              name: "Lakers @ Warriors",
              lines: [
                { label: "LeBron o26.5 Points", confident: 61, doubt: 39, category: "points", book: "FanDuel" },
                { label: "Curry o4.5 3PM", confident: 64, doubt: 36, category: "points", book: "DraftKings" },
                { label: "Total 236.5", confident: 52, doubt: 48, category: "total", book: "Caesars" },
                { label: "Warriors -3.5", confident: 49, doubt: 51, category: "spread", book: "ESPN BET" },
              ],
            },
            {
              name: "Celtics @ Knicks",
              lines: [
                { label: "Brunson o24.5 Pts", confident: 56, doubt: 44, category: "points", book: "DraftKings" },
                { label: "Total 224.5", confident: 51, doubt: 49, category: "total", book: "Caesars" },
                { label: "Celtics -4.5", confident: 58, doubt: 42, category: "spread", book: "ESPN BET" },
              ],
            },
          ],
        },
      ];

      // ---------- State ----------
      let mode = "sports"; // sports | matchups | allLines | lineDetails | mybias | mylocks | myarchives
      let currentSportIndex = 0;
      let currentMatchupIndex = 0;
      let flipped = false;

      let previousModeBeforeLineDetails = null;
      let currentLineDetailMeta = null;

      const DOUBLE_CLICK_DELAY = 250;
      let clickTimeout = null;

      // per-user store (inbox = MyBias)
      // key -> item
      const swipeStore = {};

      // auth
      let supa = null;
      let sessionUser = null;

      // theme
      let theme = localStorage.getItem("btb_theme") || "dark";

      // ---------- Elements ----------
      const cardEl = document.getElementById("sport-card");
      const cardClickArea = document.getElementById("card-click-area");

      const logoEl = document.getElementById("sport-logo");
      const nameEl = document.getElementById("sport-name");
      const codeEl = document.getElementById("sport-code");
      const tapHintFrontEl = document.getElementById("tap-hint-front");
      const tapHintBackEl = document.getElementById("tap-hint-back");

      const indexIndicatorFront = document.getElementById("index-indicator");
      const indexIndicatorBack = document.getElementById("index-indicator-back");

      const backTitleEl = document.getElementById("back-title");
      const backSubEl = document.getElementById("back-sub");
      const matchupsListEl = document.getElementById("matchups-list");
      const backFooterNoteEl = document.getElementById("back-footer-note");

      const titleEl = document.getElementById("main-title");
      const subtitleEl = document.getElementById("subtitle");
      const directionsEl = document.getElementById("directions");
      const backToSportsBtn = document.getElementById("back-to-sports");

      const sportsMenuEl = document.getElementById("sports-menu");
      const appLogoButton = document.getElementById("app-logo-button");
      const logoGroup = document.getElementById("logo-group");

      const userMenuButton = document.getElementById("user-menu-button");
      const userMenuLabel = document.getElementById("user-menu-label");
      const userDropdown = document.getElementById("user-dropdown");
      const userMenuWrapper = document.getElementById("user-menu-wrapper");

      const authOverlay = document.getElementById("auth-overlay");
      const authMsg = document.getElementById("auth-msg");
      const authEmailInput = document.getElementById("auth-email");
      const authPasswordInput = document.getElementById("auth-password");
      const btnSignIn = document.getElementById("btn-signin");
      const btnSignUp = document.getElementById("btn-signup");

      const modalOverlay = document.getElementById("modal-overlay");
      const modalTitle = document.getElementById("modal-title");
      const modalSub = document.getElementById("modal-sub");
      const modalActions = document.getElementById("modal-actions");

      const swipeToastEl = document.getElementById("swipe-toast");

      // ---------- Helpers ----------
      function setTheme(next) {
        theme = next;
        localStorage.setItem("btb_theme", theme);
        document.documentElement.setAttribute("data-theme", theme);
      }

      function toast(text) {
        swipeToastEl.textContent = text;
        swipeToastEl.classList.add("show");
        clearTimeout(swipeToastEl._t);
        swipeToastEl._t = setTimeout(() => swipeToastEl.classList.remove("show"), 1200);
      }

      function openModal({ title, sub, buttons }) {
        modalTitle.textContent = title || "Action";
        modalSub.textContent = sub || "";
        modalActions.innerHTML = "";
        (buttons || []).forEach((b) => {
          const btn = document.createElement("button");
          btn.className = "modal-btn" + (b.kind ? " " + b.kind : "");
          btn.type = "button";
          btn.textContent = b.label;
          btn.addEventListener("click", () => {
            try { b.onClick && b.onClick(); } finally { closeModal(); }
          });
          modalActions.appendChild(btn);
        });
        modalOverlay.classList.add("open");
      }

      function closeModal() {
        modalOverlay.classList.remove("open");
      }

      modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) closeModal();
      });

      function getNextIndex(length, current) {
        return (current + 1) % length;
      }
      function getPrevIndex(length, current) {
        return current === 0 ? length - 1 : current - 1;
      }
      function currentSport() {
        return SPORTS[currentSportIndex];
      }
      function currentMatchup() {
        return currentSport().matchups[currentMatchupIndex];
      }

      function requireAuthOrPrompt() {
        if (sessionUser) return true;
        openModal({
          title: "Login required",
          sub: "Sign in to start swiping lines.",
          buttons: [
            { label: "OK", kind: "primary", onClick: () => authOverlay.classList.remove("hidden") },
          ],
        });
        return false;
      }

      function getUserKeyPrefix() {
        return sessionUser ? `btb_${sessionUser.id}` : "btb_guest";
      }

      function getSwipeCount() {
        if (!sessionUser) return 0;
        const n = Number(localStorage.getItem(`${getUserKeyPrefix()}_swipeCount`) || "0");
        return Number.isFinite(n) ? n : 0;
      }

      function incSwipeCount() {
        if (!sessionUser) return;
        const next = getSwipeCount() + 1;
        localStorage.setItem(`${getUserKeyPrefix()}_swipeCount`, String(next));
      }

      function communityUnlocked() {
        return getSwipeCount() >= SWIPES_TO_UNLOCK_COMMUNITY;
      }

      function renderCardFlipState() {
        if (flipped) cardEl.classList.add("flipped");
        else cardEl.classList.remove("flipped");
      }

      // stable key for a line
      function lineKey(meta) {
        const sport = SPORTS[meta.sportIndex]?.id || "sport";
        const matchup = SPORTS[meta.sportIndex]?.matchups?.[meta.matchupIndex]?.name || meta.matchupName || "matchup";
        const book = meta.book || "Best Available";
        return `${sport}|${matchup}|${meta.label}|${book}`;
      }

      function getInboxItems() {
        return Object.values(swipeStore).filter((i) => i.status === "inbox");
      }
      function getLockItems() {
        return Object.values(swipeStore).filter((i) => i.status === "lock");
      }
      function getArchiveItems() {
        return Object.values(swipeStore).filter((i) => i.status === "archived");
      }

      // ---------- Persistence ----------
      function persistLocal() {
        if (!sessionUser) return;
        localStorage.setItem(`${getUserKeyPrefix()}_store`, JSON.stringify(swipeStore));
      }

      function loadLocal() {
        if (!sessionUser) return;
        try {
          const raw = localStorage.getItem(`${getUserKeyPrefix()}_store`);
          if (!raw) return;
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === "object") {
            Object.keys(parsed).forEach((k) => (swipeStore[k] = parsed[k]));
          }
        } catch (_) {}
      }

      async function persistCloudItem(item) {
        // If your Supabase table doesn't exist, this will error and we just use local.
        if (!supa || !sessionUser) return;
        try {
          const payload = { ...item };
          await supa
            .from("btb_swipes")
            .upsert({
              user_id: sessionUser.id,
              key: item.key,
              status: item.status,
              vote: item.yourLastVote,
              payload,
              updated_at: new Date().toISOString(),
            });
        } catch (e) {
          // silent; local fallback handles it
        }
      }

      async function deleteCloudItem(itemKey) {
        if (!supa || !sessionUser) return;
        try {
          await supa.from("btb_swipes").delete().eq("user_id", sessionUser.id).eq("key", itemKey);
        } catch (e) {}
      }

      async function loadCloudStore() {
        if (!supa || !sessionUser) return false;
        try {
          const { data, error } = await supa.from("btb_swipes").select("payload").eq("user_id", sessionUser.id).limit(2000);
          if (error) return false;
          if (Array.isArray(data)) {
            data.forEach((row) => {
              if (row?.payload?.key) swipeStore[row.payload.key] = row.payload;
            });
            return true;
          }
        } catch (e) {}
        return false;
      }

      // ---------- Bias UI ----------
      function buildBiasUI(meta, communityConfident, communityDoubt) {
        const wrapper = document.createElement("div");
        wrapper.className = "bias-bar-container";

        const barBg = document.createElement("div");
        barBg.className = "bias-bar-bg";

        const barFill = document.createElement("div");
        barFill.className = "bias-bar-fill";

        // BEFORE unlock: show 50/50 BLUE
        // AFTER unlock: show COMMUNITY GREEN
        const unlocked = communityUnlocked();

        const confidentPct = unlocked ? clampPct(communityConfident) : 50;
        const doubtPct = 100 - confidentPct;

        barFill.style.width = confidentPct + "%";
        barFill.style.background = unlocked ? `linear-gradient(90deg, var(--bias-green), #16a34a)` : `linear-gradient(90deg, var(--bias-blue), #2563eb)`;

        barBg.appendChild(barFill);

        const labels = document.createElement("div");
        labels.className = "bias-labels";

        // LEFT = Doubt it, RIGHT = Confident (per your requirement)
        const leftLabel = document.createElement("span");
        leftLabel.textContent = `Doubt it ${doubtPct}%`;
        const rightLabel = document.createElement("span");
        rightLabel.textContent = `Confident ${confidentPct}%`;

        labels.appendChild(leftLabel);
        labels.appendChild(rightLabel);

        const helper = document.createElement("div");
        helper.className = "bias-helper";
        helper.textContent = unlocked
          ? "Community bias unlocked (shown in green)."
          : `Make ${SWIPES_TO_UNLOCK_COMMUNITY - getSwipeCount()} more swipes to unlock community bias.`;

        wrapper.appendChild(barBg);
        wrapper.appendChild(labels);
        wrapper.appendChild(helper);

        return wrapper;
      }

      function clampPct(n) {
        const x = Number(n);
        if (!Number.isFinite(x)) return 50;
        return Math.max(0, Math.min(100, Math.round(x)));
      }

      // ---------- Placeholder line details ----------
      function buildLineDetails(meta) {
        // Placeholder stats layout (same-size screen ‚Äî uses same card back list)
        const block = document.createElement("div");
        block.className = "matchup-card";

        const t = document.createElement("div");
        t.className = "matchup-label";
        t.textContent = "Line Details (Placeholder)";

        const p = document.createElement("div");
        p.className = "matchup-line";
        p.textContent = "This is where live stats + splits + history will go once you specify the exact data model.";

        const r1 = document.createElement("div");
        r1.className = "matchup-line";
        r1.style.marginTop = "8px";
        r1.textContent = "‚Ä¢ Sample: Season hit rate: 62%";

        const r2 = document.createElement("div");
        r2.className = "matchup-line";
        r2.textContent = "‚Ä¢ Sample: Last 10 games: 7/10";

        const r3 = document.createElement("div");
        r3.className = "matchup-line";
        r3.textContent = "‚Ä¢ Sample: Avg vs line: +0.8";

        block.appendChild(t);
        block.appendChild(p);
        block.appendChild(r1);
        block.appendChild(r2);
        block.appendChild(r3);

        return block;
      }

      // ---------- Swipe/hold wiring for each line card ----------
      function attachLineInteractions(card, meta, context) {
        // dblclick -> line details
        card.addEventListener("dblclick", (e) => {
          e.stopPropagation();
          openLineDetails(meta);
        });

        // swipe (pointer)
        let startX = null;
        let down = false;
        let holdTimer = null;
        let held = false;

        function startHold() {
          held = false;
          clearTimeout(holdTimer);
          holdTimer = setTimeout(() => {
            held = true;
            showHoldActions(meta, context);
          }, 650);
        }

        function clearHold() {
          clearTimeout(holdTimer);
          holdTimer = null;
        }

        card.addEventListener("pointerdown", (e) => {
          down = true;
          startX = e.clientX;
          startHold();
        });

        card.addEventListener("pointerup", (e) => {
          if (!down) return;
          down = false;
          clearHold();

          if (held) return; // long-press action handled

          const dx = e.clientX - startX;
          const threshold = 40;
          if (Math.abs(dx) < threshold) return;

          e.stopPropagation();

          const vote = dx > 0 ? "confident" : "doubt"; // RIGHT = Confident, LEFT = Doubt it

          // Swiping requires login
          if (!requireAuthOrPrompt()) return;

          handleSwipe(meta, vote, context, card);
        });

        card.addEventListener("pointercancel", () => {
          down = false;
          clearHold();
        });
      }

      function showHoldActions(meta, context) {
        const key = lineKey(meta);
        const item = swipeStore[key];

        // If not logged in, just prompt login
        if (!sessionUser) {
          openModal({
            title: "Login required",
            sub: "Sign in to manage your bias / locks.",
            buttons: [{ label: "OK", kind: "primary", onClick: () => authOverlay.classList.remove("hidden") }],
          });
          return;
        }

        // LOCK: only allow remove from locks
        if (item?.status === "lock") {
          openModal({
            title: "Remove from MyLocks?",
            sub: item.lineLabel || meta.label,
            buttons: [
              {
                label: "Remove",
                kind: "danger",
                onClick: async () => {
                  item.status = "inbox"; // back to MyBias
                  item.lastUpdated = Date.now();
                  persistLocal();
                  persistCloudItem(item);
                  toast("Removed from MyLocks ‚Üí MyBias");
                  renderScreen();
                },
              },
              { label: "Cancel", kind: "", onClick: () => {} },
            ],
          });
          return;
        }

        // ARCHIVED: allow restore
        if (item?.status === "archived") {
          openModal({
            title: "Restore to MyBias?",
            sub: item.lineLabel || meta.label,
            buttons: [
              {
                label: "Restore",
                kind: "primary",
                onClick: async () => {
                  item.status = "inbox";
                  item.lastUpdated = Date.now();
                  persistLocal();
                  persistCloudItem(item);
                  toast("Restored ‚Üí MyBias");
                  renderScreen();
                },
              },
              { label: "Cancel", onClick: () => {} },
            ],
          });
          return;
        }

        // INBOX (MyBias) or first-time: allow flip bias
        openModal({
          title: "Change your bias?",
          sub: meta.label,
          buttons: [
            {
              label: "Flip bias",
              kind: "primary",
              onClick: async () => {
                // flip only this one line
                if (!swipeStore[key]) {
                  // create if missing
                  createOrUpdateStore(meta, "confident", "inbox");
                } else {
                  swipeStore[key].yourLastVote = swipeStore[key].yourLastVote === "confident" ? "doubt" : "confident";
                  swipeStore[key].lastUpdated = Date.now();
                }
                persistLocal();
                persistCloudItem(swipeStore[key]);
                toast("Bias flipped");
                renderScreen();
              },
            },
            { label: "Cancel", onClick: () => {} },
          ],
        });
      }

      function createOrUpdateStore(meta, vote, status) {
        const sport = SPORTS[meta.sportIndex];
        const matchup = sport.matchups[meta.matchupIndex];
        const key = lineKey(meta);
        const ts = Date.now();

        if (!swipeStore[key]) {
          swipeStore[key] = {
            key,
            sportId: sport.id,
            sportName: sport.name,
            sportIndex: meta.sportIndex,
            matchupIndex: meta.matchupIndex,
            matchupName: matchup.name,
            lineLabel: meta.label,
            category: meta.category || "other",
            book: meta.book || "Best Available",
            // community bias placeholders
            communityConfident: clampPct(meta.communityConfident ?? meta.confident ?? 55),
            communityDoubt: 100 - clampPct(meta.communityConfident ?? meta.confident ?? 55),
            status: status || "inbox",
            yourLastVote: vote,
            yourTotalSwipes: 1,
            createdAt: ts,
            lastUpdated: ts,
          };
        } else {
          swipeStore[key].yourLastVote = vote;
          swipeStore[key].yourTotalSwipes += 1;
          swipeStore[key].lastUpdated = ts;
          if (status) swipeStore[key].status = status;
        }
        return swipeStore[key];
      }

      async function handleSwipe(meta, vote, context, domCard) {
        // Update store
        const key = lineKey(meta);
        const item = createOrUpdateStore(meta, vote, "inbox");

        // Count toward unlock (first swipe per action)
        incSwipeCount();

        // Context rules:
        // - In MyBias: swipe RIGHT -> MyLocks, LEFT -> MyArchives
        if (context === "mybias") {
          item.status = vote === "confident" ? "lock" : "archived";
        }

        // In main browsing modes: keep in MyBias (inbox) after swipe
        // (User can later promote in MyBias)
        item.lastUpdated = Date.now();

        // Persist
        persistLocal();
        persistCloudItem(item);

        // UI: grey out and drop to bottom (do NOT flip card back)
        if (domCard) {
          domCard.classList.add("swiped");
          // move to bottom in current list
          if (domCard.parentNode) domCard.parentNode.appendChild(domCard);
        }

        // Toast
        toast(vote === "confident" ? "‚úÖ Confident" : "ü§î Doubt it");

        // If MyBias swipe moved it out, re-render that screen so it disappears from MyBias
        if (context === "mybias") {
          renderScreen();
        } else {
          // community unlock changes bias visuals immediately
          if (communityUnlocked()) {
            // update any visible bars on screen by rerendering current list only, without flipping state
            const wasFlipped = flipped;
            renderScreen();
            flipped = wasFlipped;
            renderCardFlipState();
          }
        }
      }

      // ---------- Rendering ----------
      function renderSportsFront() {
        const sport = currentSport();
        logoEl.className = "sport-logo-circle " + sport.logoClass;
        logoEl.textContent = sport.emoji;
        nameEl.textContent = sport.name;
        codeEl.textContent = sport.code;

        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";

        const idx = `${currentSportIndex + 1} / ${SPORTS.length}`;
        indexIndicatorFront.textContent = idx;
        indexIndicatorBack.textContent = idx;
      }

      function renderSportsBack() {
        const sport = currentSport();
        backTitleEl.textContent = `${sport.name} ‚Äì This Week's Matchups`;
        backSubEl.textContent = "Double-tap a matchup to open all lines.";
        backFooterNoteEl.style.display = "block";

        matchupsListEl.innerHTML = "";

        sport.matchups.forEach((matchup, mIndex) => {
          const topLine = matchup.lines[0] || { label: "Lines loading‚Ä¶", confident: 50, doubt: 50, category: "other", book: "Consensus" };

          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = matchup.name;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = topLine.label;

          left.appendChild(label);
          left.appendChild(line);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = topLine.book || "Consensus";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);

          // SideBias UI: blue 50/50 until unlock, then green community
          card.appendChild(buildBiasUI(
            { sportIndex: currentSportIndex, matchupIndex: mIndex, label: topLine.label, category: topLine.category, book: topLine.book },
            topLine.confident ?? 55,
            topLine.doubt ?? 45
          ));

          // allow swipe on the matchup preview card too, but login required
          attachLineInteractions(
            card,
            {
              sportIndex: currentSportIndex,
              matchupIndex: mIndex,
              label: topLine.label,
              category: topLine.category || "other",
              book: topLine.book,
              confident: topLine.confident,
            },
            "sportsPreview"
          );

          card.addEventListener("dblclick", (e) => {
            e.stopPropagation();
            mode = "allLines";
            currentMatchupIndex = mIndex;
            flipped = false; // IMPORTANT: do not auto-show all lines until double click flip
            renderScreen();
          });

          matchupsListEl.appendChild(card);
        });
      }

      function renderMatchupsFront() {
        const sport = currentSport();
        const matchup = currentMatchup();

        logoEl.className = "sport-logo-circle " + sport.logoClass;
        logoEl.textContent = sport.emoji;
        nameEl.textContent = matchup.name;
        codeEl.textContent = sport.name;

        tapHintFrontEl.textContent = "Double-tap center to flip (show lines)";

        const idx = `${currentMatchupIndex + 1} / ${sport.matchups.length}`;
        indexIndicatorFront.textContent = idx;
        indexIndicatorBack.textContent = idx;
      }

      function renderMatchupsBack() {
        const sport = currentSport();
        const matchup = currentMatchup();

        backTitleEl.textContent = `${sport.name} ‚Äì Top Lines`;
        backSubEl.textContent = "Swipe right = Confident ‚Ä¢ left = Doubt it. Double-tap a line for details.";
        backFooterNoteEl.style.display = "block";

        matchupsListEl.innerHTML = "";

        const linesToShow = matchup.lines.slice(0, 5);

        linesToShow.forEach((ln) => {
          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");

          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = ln.label;

          const gameLine = document.createElement("div");
          gameLine.className = "matchup-line";
          gameLine.textContent = matchup.name;

          left.appendChild(label);
          left.appendChild(gameLine);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = ln.book || "Consensus";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);

          card.appendChild(buildBiasUI(
            { sportIndex: currentSportIndex, matchupIndex: currentMatchupIndex, label: ln.label, category: ln.category, book: ln.book },
            ln.confident ?? 55,
            ln.doubt ?? 45
          ));

          // If already swiped by user, grey it and prevent swipe
          const key = lineKey({ sportIndex: currentSportIndex, matchupIndex: currentMatchupIndex, label: ln.label, book: ln.book });
          if (swipeStore[key]) card.classList.add("swiped");

          attachLineInteractions(
            card,
            { sportIndex: currentSportIndex, matchupIndex: currentMatchupIndex, label: ln.label, category: ln.category || "other", book: ln.book, confident: ln.confident },
            "matchupsTop"
          );

          matchupsListEl.appendChild(card);
        });
      }

      function renderAllLinesBack() {
        const sport = currentSport();
        const matchup = currentMatchup();

        backTitleEl.textContent = `${sport.name} ‚Äì All Lines`;
        backSubEl.textContent = matchup.name;
        backFooterNoteEl.style.display = "block";

        matchupsListEl.innerHTML = "";

        const baseLines = matchup.lines || [];
        let extended = baseLines.slice();

        // add some demo alts so it scrolls
        let altCounter = 1;
        while (extended.length < 14 && baseLines.length > 0) {
          const template = baseLines[extended.length % baseLines.length];
          const cat =
            template.category === "spread" || template.category === "total" || template.category === "points"
              ? "alt"
              : template.category || "alt";
          extended.push({
            ...template,
            label: `${template.label} (Alt ${altCounter})`,
            category: cat,
          });
          altCounter++;
        }

        const grouped = {};
        extended.forEach((ln) => {
          const cat = ln.category || "other";
          if (!grouped[cat]) grouped[cat] = [];
          grouped[cat].push(ln);
        });

        CATEGORY_ORDER.forEach((catKey) => {
          const linesInCat = grouped[catKey];
          if (!linesInCat || linesInCat.length === 0) return;

          const header = document.createElement("div");
          header.className = "category-header";
          header.textContent = CATEGORY_LABELS[catKey] || CATEGORY_LABELS.other;
          matchupsListEl.appendChild(header);

          linesInCat.forEach((ln) => {
            const card = document.createElement("div");
            card.className = "matchup-card";

            const top = document.createElement("div");
            top.className = "matchup-top";

            const left = document.createElement("div");
            const label = document.createElement("div");
            label.className = "matchup-label";
            label.textContent = ln.label;

            const gameLine = document.createElement("div");
            gameLine.className = "matchup-line";
            gameLine.textContent = matchup.name;

            left.appendChild(label);
            left.appendChild(gameLine);

            const right = document.createElement("div");
            right.className = "matchup-tag";
            right.textContent = ln.book || "Consensus";

            top.appendChild(left);
            top.appendChild(right);

            card.appendChild(top);

            card.appendChild(buildBiasUI(
              { sportIndex: currentSportIndex, matchupIndex: currentMatchupIndex, label: ln.label, category: ln.category, book: ln.book },
              ln.confident ?? 55,
              ln.doubt ?? 45
            ));

            // If already swiped by user, grey it and prevent swipe
            const key = lineKey({ sportIndex: currentSportIndex, matchupIndex: currentMatchupIndex, label: ln.label, book: ln.book });
            if (swipeStore[key]) card.classList.add("swiped");

            attachLineInteractions(
              card,
              { sportIndex: currentSportIndex, matchupIndex: currentMatchupIndex, label: ln.label, category: ln.category || "other", book: ln.book, confident: ln.confident },
              "allLines"
            );

            matchupsListEl.appendChild(card);
          });
        });
      }

      function renderLineDetailsFront() {
        const sport = SPORTS[currentLineDetailMeta.sportIndex];
        logoEl.className = "sport-logo-circle " + sport.logoClass;
        logoEl.textContent = sport.emoji;

        nameEl.textContent = currentLineDetailMeta.label;
        codeEl.textContent = `${sport.name} ‚Ä¢ ${SPORTS[currentLineDetailMeta.sportIndex].matchups[currentLineDetailMeta.matchupIndex].name}`;
        tapHintFrontEl.textContent = "Double-tap center to go back ‚Ü∫";

        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderLineDetailsBack() {
        backTitleEl.textContent = "Line Details";
        backSubEl.textContent = "Double-tap center to return.";
        backFooterNoteEl.style.display = "none";

        matchupsListEl.innerHTML = "";
        matchupsListEl.appendChild(buildLineDetails(currentLineDetailMeta));
      }

      function renderMyBiasFront() {
        logoEl.className = "sport-logo-circle sport-logo-hub";
        logoEl.textContent = "üß†";
        nameEl.textContent = "MyBias";
        codeEl.textContent = "Your swiped lines (promote to Locks / Archives)";
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderMyBiasBack() {
        backTitleEl.textContent = "MyBias";
        backSubEl.textContent =
          "Swipe right ‚Üí MyLocks. Swipe left ‚Üí MyArchives. Hold to flip your bias on ONE line.";
        backFooterNoteEl.style.display = "none";

        matchupsListEl.innerHTML = "";

        const items = getInboxItems().sort((a, b) => (b.lastUpdated || 0) - (a.lastUpdated || 0));

        if (items.length === 0) {
          const empty = document.createElement("div");
          empty.className = "matchup-card";
          const t = document.createElement("div");
          t.className = "matchup-label";
          t.textContent = "No lines in MyBias yet";
          const p = document.createElement("div");
          p.className = "matchup-line";
          p.textContent = "Go swipe a few lines in games, then come back here to lock or archive them.";
          empty.appendChild(t);
          empty.appendChild(p);
          matchupsListEl.appendChild(empty);
          return;
        }

        items.forEach((item) => {
          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = item.lineLabel;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = `${item.matchupName} ‚Ä¢ ${item.sportName} ‚Ä¢ ${item.book}`;

          const your = document.createElement("div");
          your.className = "matchup-line";
          your.textContent = `Your bias: ${item.yourLastVote === "confident" ? "Confident ‚úÖ" : "Doubt it ü§î"}`;

          left.appendChild(label);
          left.appendChild(line);
          left.appendChild(your);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = "Hold to edit";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);

          card.appendChild(buildBiasUI(
            { sportIndex: item.sportIndex, matchupIndex: item.matchupIndex, label: item.lineLabel, category: item.category, book: item.book },
            item.communityConfident ?? 55,
            100 - (item.communityConfident ?? 55)
          ));

          attachLineInteractions(
            card,
            { sportIndex: item.sportIndex, matchupIndex: item.matchupIndex, label: item.lineLabel, category: item.category, book: item.book, confident: item.communityConfident ?? 55 },
            "mybias"
          );

          matchupsListEl.appendChild(card);
        });
      }

      function renderMyLocksFront() {
        logoEl.className = "sport-logo-circle sport-logo-locks";
        logoEl.textContent = "üîí";
        nameEl.textContent = "MyLocks";
        codeEl.textContent = "Locked lines stay with your account";
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderMyLocksBack() {
        backTitleEl.textContent = "MyLocks";
        backSubEl.textContent = "Hold any lock to remove it (moves back to MyBias).";
        backFooterNoteEl.style.display = "none";

        matchupsListEl.innerHTML = "";

        const locks = getLockItems().sort((a, b) => (b.lastUpdated || 0) - (a.lastUpdated || 0));
        if (locks.length === 0) {
          const empty = document.createElement("div");
          empty.className = "matchup-card";
          const t = document.createElement("div");
          t.className = "matchup-label";
          t.textContent = "No locks yet";
          const p = document.createElement("div");
          p.className = "matchup-line";
          p.textContent = "Promote a line from MyBias with a right swipe to lock it.";
          empty.appendChild(t);
          empty.appendChild(p);
          matchupsListEl.appendChild(empty);
          return;
        }

        // Group by book
        const byBook = {};
        locks.forEach((i) => {
          const b = i.book || "Best Available";
          if (!byBook[b]) byBook[b] = [];
          byBook[b].push(i);
        });

        Object.keys(byBook).sort().forEach((book) => {
          const header = document.createElement("div");
          header.className = "category-header";
          header.textContent = book;
          matchupsListEl.appendChild(header);

          byBook[book].forEach((item) => {
            const card = document.createElement("div");
            card.className = "matchup-card";

            const top = document.createElement("div");
            top.className = "matchup-top";

            const left = document.createElement("div");
            const label = document.createElement("div");
            label.className = "matchup-label";
            label.textContent = item.lineLabel;

            const line = document.createElement("div");
            line.className = "matchup-line";
            line.textContent = `${item.matchupName} ‚Ä¢ ${item.sportName}`;

            const your = document.createElement("div");
            your.className = "matchup-line";
            your.textContent = `Your lock bias: ${item.yourLastVote === "confident" ? "Confident ‚úÖ" : "Doubt it ü§î"}`;

            left.appendChild(label);
            left.appendChild(line);
            left.appendChild(your);

            const right = document.createElement("div");
            right.className = "matchup-tag";
            right.textContent = "Hold to remove";

            top.appendChild(left);
            top.appendChild(right);
            card.appendChild(top);

            card.appendChild(buildBiasUI(
              { sportIndex: item.sportIndex, matchupIndex: item.matchupIndex, label: item.lineLabel, category: item.category, book: item.book },
              item.communityConfident ?? 55,
              100 - (item.communityConfident ?? 55)
            ));

            // Hold actions work because item.status === "lock"
            attachLineInteractions(
              card,
              { sportIndex: item.sportIndex, matchupIndex: item.matchupIndex, label: item.lineLabel, category: item.category, book: item.book, confident: item.communityConfident ?? 55 },
              "mylocks"
            );

            matchupsListEl.appendChild(card);
          });

          const btn = document.createElement("button");
          btn.className = "sportsbook-cta-btn";
          btn.type = "button";
          btn.textContent = `Place bets in ${book} (affiliate soon)`;
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            toast(`Affiliate link for ${book} coming soon`);
          });
          matchupsListEl.appendChild(btn);
        });
      }

      function renderMyArchivesFront() {
        logoEl.className = "sport-logo-circle sport-logo-archive";
        logoEl.textContent = "üóÉÔ∏è";
        nameEl.textContent = "MyArchives";
        codeEl.textContent = "Archived lines (hold to restore)";
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderMyArchivesBack() {
        backTitleEl.textContent = "MyArchives";
        backSubEl.textContent = "Hold any archived line to restore it to MyBias.";
        backFooterNoteEl.style.display = "none";

        matchupsListEl.innerHTML = "";

        const archived = getArchiveItems().sort((a, b) => (b.lastUpdated || 0) - (a.lastUpdated || 0));
        if (archived.length === 0) {
          const empty = document.createElement("div");
          empty.className = "matchup-card";
          const t = document.createElement("div");
          t.className = "matchup-label";
          t.textContent = "No archived lines";
          const p = document.createElement("div");
          p.className = "matchup-line";
          p.textContent = "If you swipe left in MyBias, lines will appear here.";
          empty.appendChild(t);
          empty.appendChild(p);
          matchupsListEl.appendChild(empty);
          return;
        }

        archived.forEach((item) => {
          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = item.lineLabel;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = `${item.matchupName} ‚Ä¢ ${item.sportName} ‚Ä¢ ${item.book}`;

          left.appendChild(label);
          left.appendChild(line);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = "Hold to restore";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);

          card.appendChild(buildBiasUI(
            { sportIndex: item.sportIndex, matchupIndex: item.matchupIndex, label: item.lineLabel, category: item.category, book: item.book },
            item.communityConfident ?? 55,
            100 - (item.communityConfident ?? 55)
          ));

          attachLineInteractions(
            card,
            { sportIndex: item.sportIndex, matchupIndex: item.matchupIndex, label: item.lineLabel, category: item.category, book: item.book, confident: item.communityConfident ?? 55 },
            "myarchives"
          );

          matchupsListEl.appendChild(card);
        });
      }

      function openLineDetails(meta) {
        previousModeBeforeLineDetails = mode;
        currentLineDetailMeta = meta;
        mode = "lineDetails";
        flipped = true; // show details on back
        renderScreen();
      }

      function renderScreen() {
        if (mode === "sports") {
          titleEl.textContent = "Select Your Sport";
          subtitleEl.textContent = "Flip the card to preview matchups.";
          directionsEl.innerHTML =
            'Tap <strong>center</strong> to flip. Use <strong>left/right edge</strong> to switch sports. Double-tap center to open a sport.';
          backToSportsBtn.style.display = "none";

          renderSportsFront();
          renderSportsBack();
        } else if (mode === "matchups") {
          const sport = currentSport();
          titleEl.textContent = `${sport.name} Matchups`;
          subtitleEl.textContent = "Double-tap center to flip (show lines).";
          directionsEl.innerHTML =
            'Single tap <strong>edges</strong> switches games. Double-tap <strong>center</strong> to flip and show lines. Swiping lines requires login.';
          backToSportsBtn.style.display = "inline-flex";

          renderMatchupsFront();
          renderMatchupsBack();
        } else if (mode === "allLines") {
          const sport = currentSport();
          const matchup = currentMatchup();
          titleEl.textContent = `${sport.name} ‚Äì All Lines`;
          subtitleEl.textContent = matchup.name;
          directionsEl.innerHTML =
            'IMPORTANT: <strong>Single tap edges</strong> changes the game. <strong>Double-tap center</strong> flips to show lines. (Swiping requires login.)';
          backToSportsBtn.style.display = "inline-flex";

          // Front shows matchup; back shows lines
          renderMatchupsFront();
          renderAllLinesBack();
        } else if (mode === "lineDetails") {
          titleEl.textContent = "Line Details";
          subtitleEl.textContent = "Placeholder stats screen";
          directionsEl.innerHTML =
            'Double-tap <strong>center</strong> to go back.';

          backToSportsBtn.style.display = "inline-flex";
          renderLineDetailsFront();
          renderLineDetailsBack();
        } else if (mode === "mybias") {
          titleEl.textContent = "MyBias";
          subtitleEl.textContent = "Your swiped lines";
          directionsEl.innerHTML =
            'Swipe right ‚Üí <strong>MyLocks</strong>, swipe left ‚Üí <strong>MyArchives</strong>. Hold a line to flip your bias on that line only. Double-tap for details.';
          backToSportsBtn.style.display = "inline-flex";

          renderMyBiasFront();
          renderMyBiasBack();
          flipped = true;
        } else if (mode === "mylocks") {
          titleEl.textContent = "MyLocks";
          subtitleEl.textContent = "Locked lines (persist by login)";
          directionsEl.innerHTML =
            'Hold a lock to remove it (returns to MyBias). Double-tap for details.';
          backToSportsBtn.style.display = "inline-flex";

          renderMyLocksFront();
          renderMyLocksBack();
          flipped = true;
        } else if (mode === "myarchives") {
          titleEl.textContent = "MyArchives";
          subtitleEl.textContent = "Archived lines";
          directionsEl.innerHTML =
            'Hold an archived line to restore it to MyBias. Double-tap for details.';
          backToSportsBtn.style.display = "inline-flex";

          renderMyArchivesFront();
          renderMyArchivesBack();
          flipped = true;
        }

        renderCardFlipState();
        buildSportsMenu();
        buildUserDropdown();
      }

      function handleGlobalBack() {
        if (mode === "lineDetails" && previousModeBeforeLineDetails) {
          mode = previousModeBeforeLineDetails;
          flipped = true;
        } else if (mode === "allLines") {
          mode = "matchups";
          // IMPORTANT: do not auto-flip. user chooses.
          flipped = false;
        } else if (mode === "matchups") {
          mode = "sports";
          flipped = false;
        } else if (mode === "mybias" || mode === "mylocks" || mode === "myarchives") {
          mode = "sports";
          flipped = false;
        } else {
          return;
        }
        renderScreen();
      }

      backToSportsBtn.addEventListener("click", () => handleGlobalBack());

      // ---------- Card click rules (YOUR REQUIREMENTS) ----------
      function handleSingleClick(e) {
        const rect = cardClickArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const zone = x / rect.width;

        // In My* screens: center toggles flip only
        if (mode === "mybias" || mode === "mylocks" || mode === "myarchives") {
          if (zone >= 0.2 && zone <= 0.8) {
            flipped = !flipped;
            renderCardFlipState();
          }
          return;
        }

        // In ALL LINES: single click edges changes game; do NOT force flip
        if (mode === "allLines") {
          if (zone < 0.2) {
            currentMatchupIndex = getPrevIndex(currentSport().matchups.length, currentMatchupIndex);
            renderScreen(); // keep flipped state
            return;
          }
          if (zone > 0.8) {
            currentMatchupIndex = getNextIndex(currentSport().matchups.length, currentMatchupIndex);
            renderScreen(); // keep flipped state
            return;
          }
          // center single click does nothing in allLines (prevents accidental flips)
          return;
        }

        if (zone < 0.2) {
          if (mode === "sports") {
            currentSportIndex = getPrevIndex(SPORTS.length, currentSportIndex);
            flipped = false;
          } else if (mode === "matchups") {
            currentMatchupIndex = getPrevIndex(currentSport().matchups.length, currentMatchupIndex);
            // do not force flip
          }
          renderScreen();
        } else if (zone > 0.8) {
          if (mode === "sports") {
            currentSportIndex = getNextIndex(SPORTS.length, currentSportIndex);
            flipped = false;
          } else if (mode === "matchups") {
            currentMatchupIndex = getNextIndex(currentSport().matchups.length, currentMatchupIndex);
          }
          renderScreen();
        } else {
          // center single click flips ONLY for sports/matchups
          flipped = !flipped;
          renderCardFlipState();
        }
      }

      function handleDoubleClick(e) {
        const rect = cardClickArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const zone = x / rect.width;

        if (mode === "lineDetails") {
          handleGlobalBack();
          return;
        }

        // Center dblclick flips in sports/matchups/allLines
        if (zone >= 0.2 && zone <= 0.8) {
          if (mode === "sports") {
            mode = "matchups";
            currentMatchupIndex = 0;
            flipped = false;
            renderScreen();
            return;
          }
          if (mode === "matchups") {
            // open allLines but DO NOT auto flip (you said only double click shows)
            mode = "allLines";
            flipped = false;
            renderScreen();
            return;
          }
          if (mode === "allLines") {
            // now actually flip to show lines
            flipped = !flipped;
            renderCardFlipState();
            return;
          }
        }

        handleSingleClick(e);
      }

      cardClickArea.addEventListener("click", (e) => {
        if (clickTimeout) {
          clearTimeout(clickTimeout);
          clickTimeout = null;
          handleDoubleClick(e);
        } else {
          clickTimeout = setTimeout(() => {
            handleSingleClick(e);
            clickTimeout = null;
          }, DOUBLE_CLICK_DELAY);
        }
      });

      // ---------- Menus ----------
      function buildSportsMenu() {
        sportsMenuEl.innerHTML = "";

        SPORTS.forEach((sport, sIndex) => {
          const wrap = document.createElement("div");
          wrap.className = "sports-menu-item";

          const title = document.createElement("div");
          title.className = "sports-menu-item-title";
          title.textContent = sport.name;
          wrap.appendChild(title);

          const gamesSub = document.createElement("div");
          gamesSub.className = "sports-games-submenu";

          sport.matchups.forEach((matchup, mIndex) => {
            const gameItem = document.createElement("div");
            gameItem.className = "game-item";
            gameItem.textContent = matchup.name;
            gameItem.addEventListener("click", (e) => {
              e.stopPropagation();
              currentSportIndex = sIndex;
              currentMatchupIndex = mIndex;
              mode = "allLines";
              flipped = false; // IMPORTANT: user must double-click to reveal lines
              sportsMenuEl.classList.remove("open");
              renderScreen();
            });
            gamesSub.appendChild(gameItem);
          });

          wrap.appendChild(gamesSub);
          sportsMenuEl.appendChild(wrap);
        });
      }

      appLogoButton.addEventListener("click", (e) => {
        e.stopPropagation();
        sportsMenuEl.classList.toggle("open", !sportsMenuEl.classList.contains("open"));
      });

      function buildUserDropdown() {
        userDropdown.innerHTML = "";

        // MyBias
        const hub = document.createElement("div");
        hub.className = "user-dropdown-item";
        hub.textContent = "MyBias";
        hub.addEventListener("click", () => {
          mode = "mybias";
          flipped = true;
          userDropdown.classList.remove("open");
          renderScreen();
        });
        userDropdown.appendChild(hub);

        // MyLocks
        const locks = document.createElement("div");
        locks.className = "user-dropdown-item";
        locks.textContent = "MyLocks";
        locks.addEventListener("click", () => {
          mode = "mylocks";
          flipped = true;
          userDropdown.classList.remove("open");
          renderScreen();
        });
        userDropdown.appendChild(locks);

        // MyArchives
        const arch = document.createElement("div");
        arch.className = "user-dropdown-item";
        arch.textContent = "MyArchives";
        arch.addEventListener("click", () => {
          mode = "myarchives";
          flipped = true;
          userDropdown.classList.remove("open");
          renderScreen();
        });
        userDropdown.appendChild(arch);

        // separator
        const sep = document.createElement("div");
        sep.className = "user-dropdown-separator";
        userDropdown.appendChild(sep);

        // Theme toggle
        const themeItem = document.createElement("div");
        themeItem.className = "user-dropdown-item";
        themeItem.innerHTML = `<span>Light Mode</span>`;
        const pill = document.createElement("div");
        pill.className = "toggle-pill" + (theme === "light" ? " on" : "");
        const dot = document.createElement("div");
        dot.className = "toggle-dot";
        pill.appendChild(dot);
        themeItem.appendChild(pill);

        themeItem.addEventListener("click", () => {
          setTheme(theme === "light" ? "dark" : "light");
          buildUserDropdown();
        });

        userDropdown.appendChild(themeItem);

        // Sign out
        const authItem = document.createElement("div");
        authItem.className = "user-dropdown-item";
        authItem.textContent = sessionUser ? "Sign out" : "Sign in";
        authItem.addEventListener("click", async () => {
          userDropdown.classList.remove("open");
          if (!sessionUser) {
            authOverlay.classList.remove("hidden");
            return;
          }
          try {
            await supa.auth.signOut();
          } catch (_) {}
          sessionUser = null;
          authOverlay.classList.remove("hidden");
          toast("Signed out");
          renderScreen();
        });
        userDropdown.appendChild(authItem);
      }

      userMenuButton.addEventListener("click", (e) => {
        e.stopPropagation();
        userDropdown.classList.toggle("open", !userDropdown.classList.contains("open"));
      });

      document.addEventListener("click", (e) => {
        const t = e.target;
        const clickedUserMenu = userMenuWrapper.contains(t);
        const clickedLogoMenu = logoGroup.contains(t);
        if (!clickedLogoMenu) sportsMenuEl.classList.remove("open");
        if (!clickedUserMenu) userDropdown.classList.remove("open");
      });

      // ---------- Auth ----------
      function setAuthMsg(text, isError) {
        authMsg.textContent = text || "";
        authMsg.classList.toggle("error", !!isError);
      }

      async function attemptSignIn() {
        setAuthMsg("");
        const email = (authEmailInput.value || "").trim();
        const password = authPasswordInput.value || "";
        if (!email || !password) return setAuthMsg("Enter email + password.", true);

        const { data, error } = await supa.auth.signInWithPassword({ email, password });
        if (error) return setAuthMsg(error.message, true);

        const u = data?.user;
        sessionUser = u || null;

        authOverlay.classList.add("hidden");
        setAuthMsg("");

        // Load store (cloud preferred, local fallback)
        Object.keys(swipeStore).forEach((k) => delete swipeStore[k]);
        const cloudOk = await loadCloudStore();
        if (!cloudOk) loadLocal();

        toast("Signed in");
        renderScreen();
      }

      async function attemptSignUp() {
        setAuthMsg("");
        const email = (authEmailInput.value || "").trim();
        const password = authPasswordInput.value || "";
        if (!email || !password) return setAuthMsg("Enter email + password.", true);

        const { data, error } = await supa.auth.signUp({
          email,
          password,
          options: {
            // helps some setups with email confirmation links
            emailRedirectTo: window.location.href,
          },
        });

        if (error) return setAuthMsg(error.message, true);

        // If confirmation is enabled, Supabase often returns user but session may be null.
        // We do NOT break the UX; we guide them.
        setAuthMsg("Account created. If email confirmation is enabled, confirm the email then sign in.", false);
        toast("Account created");
      }

      btnSignIn.addEventListener("click", () => attemptSignIn());
      btnSignUp.addEventListener("click", () => attemptSignUp());

      // ---------- Init / Supabase boot ----------
      function bootSupabase() {
        // IMPORTANT: this is your project URL + anon key from your earlier file.
        supa = supabase.createClient(
          "https://kmgrpyvcxonfjswxusbt.supabase.co",
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttZ3JweXZjeG9uZmpzd3h1c2J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NjE4NTIsImV4cCI6MjA4MTIzNzg1Mn0.teDypPoT-TMPkIDGemYVRfCNdmK0uAbOCDaiHfNmgac",
          { auth: { persistSession: true, autoRefreshToken: true } }
        );
        window.supabaseClient = supa;
      }

      async function initAuthState() {
        const { data } = await supa.auth.getSession();
        if (data?.session?.user) {
          sessionUser = data.session.user;
          authOverlay.classList.add("hidden");

          // load store
          const cloudOk = await loadCloudStore();
          if (!cloudOk) loadLocal();
        } else {
          sessionUser = null;
          authOverlay.classList.remove("hidden");
        }
      }

      // ---------- LIVE NFL ODDS (kept, safe) ----------
      const NFL_API_KEY = "05e71f5146e8488d9ff3c537b89f4ffc"; // your key

      async function fetchJsonSafe(url) {
        try {
          const r = await fetch(url);
          if (!r.ok) return null;
          return await r.json();
        } catch (e) {
          return null;
        }
      }

      async function loadLiveNflOdds() {
        if (!NFL_API_KEY) return;

        const seasonUrl = `https://api.sportsdata.io/v3/nfl/scores/json/CurrentSeason?key=${NFL_API_KEY}`;
        const weekUrl = `https://api.sportsdata.io/v3/nfl/scores/json/CurrentWeek?key=${NFL_API_KEY}`;

        const seasonRaw = await fetchJsonSafe(seasonUrl);
        const weekRaw = await fetchJsonSafe(weekUrl);

        const season = Number(seasonRaw);
        const week = Number(weekRaw);

        if (!season || !week) return;

        const oddsUrl = `https://api.sportsdata.io/v3/nfl/odds/json/GameOddsByWeek/${season}/${week}?key=${NFL_API_KEY}`;
        const oddsData = await fetchJsonSafe(oddsUrl);
        if (!Array.isArray(oddsData) || oddsData.length === 0) return;

        applyLiveNflOdds(oddsData);

        // refresh menu + screen
        buildSportsMenu();
        renderScreen();
      }

      function applyLiveNflOdds(oddsData) {
        const nflSport = SPORTS.find((s) => s.id === "nfl");
        if (!nflSport) return;

        const mapped = [];

        oddsData.forEach((game) => {
          const home = game.HomeTeamName || game.HomeTeam || game.HomeTeamKey || "HOME";
          const away = game.AwayTeamName || game.AwayTeam || game.AwayTeamKey || "AWAY";
          const matchupName = `${away} @ ${home}`;

          const pre = game.PregameOdds || [];
          if (!pre.length) return;

          const lines = [];

          pre.forEach((odd) => {
            const book = odd.SportsbookName || odd.Sportsbook || `Book ${odd.SportsbookId || ""}`.trim();

            // Spread
            if (typeof odd.Spread === "number" && odd.FavoredTeam) {
              lines.push({
                label: `${odd.FavoredTeam} ${odd.Spread > 0 ? "+" : ""}${odd.Spread}`,
                category: "spread",
                confident: 55,
                doubt: 45,
                book,
              });
            }

            // Total
            if (typeof odd.OverUnder === "number") {
              lines.push({
                label: `Total ${odd.OverUnder}`,
                category: "total",
                confident: 53,
                doubt: 47,
                book,
              });
            }

            // Moneylines
            if (typeof odd.HomeTeamMoneyLine === "number") {
              const v = odd.HomeTeamMoneyLine;
              lines.push({
                label: `${home} ${v > 0 ? "+" : ""}${v} ML`,
                category: "moneyline",
                confident: 52,
                doubt: 48,
                book,
              });
            }
            if (typeof odd.AwayTeamMoneyLine === "number") {
              const v = odd.AwayTeamMoneyLine;
              lines.push({
                label: `${away} ${v > 0 ? "+" : ""}${v} ML`,
                category: "moneyline",
                confident: 52,
                doubt: 48,
                book,
              });
            }
          });

          if (!lines.length) return;
          mapped.push({ name: matchupName, lines: lines.slice(0, 22) });
        });

        if (mapped.length) nflSport.matchups = mapped;
      }

      // ---------- Boot ----------
      document.addEventListener("DOMContentLoaded", async () => {
        setTheme(theme);
        bootSupabase();
        await initAuthState();

        buildSportsMenu();
        buildUserDropdown();
        renderScreen();

        // load NFL live odds (does not break if fails)
        loadLiveNflOdds();
      });

      // Keyboard support
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeModal();
      });
    </script>
  </body>
</html>
