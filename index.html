<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>BeforeTheBet ‚Äì Demo MVP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      /* =========================
         THEME (Light default)
         ========================= */
      :root {
        --bg: #f6f7fb;
        --card: #ffffff;
        --border: #e5e7eb;
        --text: #0f172a;
        --muted: #64748b;

        --brand: #2563eb;
        --ok: #16a34a;

        --bias-blue: #2563eb;
        --bias-green: #16a34a;

        --shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
        --shadow-strong: 0 22px 60px rgba(15, 23, 42, 0.18);

        color-scheme: light;
      }

      body.dark {
        --bg: #020617;
        --card: #020617;
        --border: #1e293b;
        --text: #e2e8f0;
        --muted: #94a3b8;

        --brand: #60a5fa;
        --ok: #22c55e;

        --bias-blue: #60a5fa;
        --bias-green: #22c55e;

        --shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
        --shadow-strong: 0 26px 70px rgba(0, 0, 0, 0.55);

        color-scheme: dark;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, rgba(37, 99, 235, 0.12) 0, var(--bg) 55%);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .app-shell {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header,
      footer {
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        border-bottom: 1px solid var(--border);
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.7);
        z-index: 10;
      }

      body.dark header,
      body.dark footer {
        background: rgba(2, 6, 23, 0.6);
      }

      footer {
        border-top: 1px solid var(--border);
        border-bottom: none;
        justify-content: center;
        font-size: 11px;
        color: var(--muted);
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo-group {
        position: relative;
        display: flex;
        align-items: center;
      }

      .logo-button {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: transparent;
        cursor: pointer;
      }

      .logo-button:hover {
        border-color: var(--border);
        background: rgba(100, 116, 139, 0.08);
      }

      .logo {
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .logo-caret {
        font-size: 10px;
        color: var(--muted);
      }

      .sports-menu {
        position: absolute;
        top: 115%;
        left: 0;
        background: var(--card);
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-strong);
        padding: 8px 0;
        min-width: 240px;
        display: none;
        z-index: 60;
        max-height: 60vh;
        overflow: auto;
      }

      .sports-menu.open {
        display: block;
      }

      .sports-menu-item {
        padding: 8px 12px;
        font-size: 12px;
        color: var(--text);
        cursor: default;
        position: relative;
      }

      .sports-menu-item:hover {
        background: rgba(100, 116, 139, 0.08);
      }

      .sports-menu-item-title {
        font-weight: 700;
        font-size: 12px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
        margin-bottom: 6px;
      }

      .sports-games-submenu {
        margin-top: 2px;
        margin-left: 4px;
        padding-left: 10px;
        border-left: 1px solid var(--border);
      }

      .game-item {
        font-size: 12px;
        color: var(--text);
        padding: 6px 0;
        cursor: pointer;
      }

      .game-item:hover {
        color: var(--brand);
      }

      #back-to-sports {
        display: none;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(100, 116, 139, 0.08);
        color: var(--text);
        font-size: 11px;
        padding: 6px 10px;
        cursor: pointer;
      }

      #back-to-sports:hover {
        border-color: rgba(100, 116, 139, 0.35);
      }

      .user-menu-wrapper {
        position: relative;
      }

      .menu-placeholder {
        font-size: 11px;
        color: var(--text);
        cursor: pointer;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(100, 116, 139, 0.06);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .menu-placeholder:hover {
        background: rgba(100, 116, 139, 0.1);
      }

      .user-dropdown {
        position: absolute;
        right: 0;
        top: 115%;
        background: var(--card);
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-strong);
        min-width: 220px;
        padding: 6px 0;
        display: none;
        z-index: 60;
      }

      .user-dropdown.open {
        display: block;
      }

      .user-dropdown-item {
        padding: 8px 12px;
        font-size: 12px;
        cursor: pointer;
        color: var(--text);
      }

      .user-dropdown-item:hover {
        background: rgba(100, 116, 139, 0.08);
      }

      .user-dropdown-separator {
        border-top: 1px solid var(--border);
        margin: 6px 0;
      }

      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: center;
        padding: 24px 16px;
      }

      .content {
        max-width: 960px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 22px;
        align-items: stretch;
      }

      .title-block {
        text-align: center;
      }

      .title-block h1 {
        font-size: 28px;
        margin: 0 0 8px;
      }

      .title-block p {
        margin: 0;
        font-size: 14px;
        color: var(--muted);
      }

      .title-block .directions {
        margin-top: 6px;
        font-size: 12px;
        color: var(--muted);
      }

      @media (min-width: 768px) {
        .title-block h1 {
          font-size: 32px;
        }
        .title-block .directions {
          font-size: 13px;
        }
      }

      /* =========================
         CARD STACK
         ========================= */
      .card-container {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .card-click-area {
        position: relative;
        width: 100%;
        max-width: 390px;
        aspect-ratio: 2.5 / 3.5;
        perspective: 1200px;
        cursor: pointer;
      }

      @media (min-width: 1024px) {
        .card-click-area {
          max-width: 430px;
        }
      }

      .card,
      .stack-card {
        position: absolute;
        inset: 0;
        border-radius: 24px;
        border: 1px solid var(--border);
        background: var(--card);
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      body.dark .card,
      body.dark .stack-card {
        background: radial-gradient(circle at top, rgba(255, 255, 255, 0.02), var(--card));
      }

      .card-main {
        transform-style: preserve-3d;
        transition: transform 0.5s ease;
        z-index: 3;
      }

      .stack-card {
        pointer-events: none;
        opacity: 0.55;
        z-index: 0;
      }

      .stack-card.stack-1 {
        transform: translateY(10px) translateX(6px) scale(0.97);
      }

      .stack-card.stack-2 {
        transform: translateY(18px) translateX(10px) scale(0.94);
        opacity: 0.4;
      }

      .stack-card.stack-3 {
        transform: translateY(26px) translateX(14px) scale(0.9);
        opacity: 0.25;
      }

      .card-face {
        position: absolute;
        inset: 0;
        padding: 18px 16px 14px;
        display: flex;
        flex-direction: column;
        backface-visibility: hidden;
      }

      .card-front {
        align-items: center;
        text-align: center;
        justify-content: center;
        gap: 12px;
        transform: rotateY(0deg);
        transition: transform 0.5s ease;
      }

      .card-back {
        transform: rotateY(180deg);
        justify-content: flex-start;
        transition: transform 0.5s ease;
      }

      .card-main.flipped .card-front {
        transform: rotateY(-180deg);
      }

      .card-main.flipped .card-back {
        transform: rotateY(0deg);
      }

      /* =========================
         FRONT LOGO
         ========================= */
      .sport-logo-circle {
        width: 116px;
        height: 116px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 42px;
        box-shadow: var(--shadow);
        border: 1px solid rgba(100, 116, 139, 0.18);
      }

      .sport-logo-nba {
        background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.22), rgba(37, 99, 235, 0.08));
      }
      .sport-logo-nfl {
        background: radial-gradient(circle at top left, rgba(22, 163, 74, 0.22), rgba(22, 163, 74, 0.08));
      }
      .sport-logo-nhl {
        background: radial-gradient(circle at top left, rgba(14, 165, 233, 0.20), rgba(14, 165, 233, 0.08));
      }
      .sport-logo-cfb {
        background: radial-gradient(circle at top left, rgba(249, 115, 22, 0.22), rgba(249, 115, 22, 0.08));
      }
      .sport-logo-mls {
        background: radial-gradient(circle at top left, rgba(168, 85, 247, 0.22), rgba(168, 85, 247, 0.08));
      }

      .sport-front-name {
        font-size: 18px;
        font-weight: 700;
        margin-top: 10px;
      }

      .sport-front-code {
        font-size: 12px;
        letter-spacing: 0.12em;
        color: var(--muted);
        margin-top: 4px;
      }

      .tap-hint {
        position: absolute;
        bottom: 10px;
        right: 14px;
        font-size: 10px;
        color: var(--muted);
        pointer-events: none;
      }

      .index-indicator {
        position: absolute;
        bottom: 10px;
        left: 14px;
        font-size: 10px;
        color: var(--muted);
      }

      /* =========================
         BACK CONTENT
         ========================= */
      .back-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 8px;
        margin-bottom: 8px;
      }

      .back-title {
        font-size: 16px;
        font-weight: 800;
      }

      .back-sub {
        font-size: 11px;
        color: var(--muted);
        text-align: right;
      }

      .matchups-list {
        margin-top: 6px;
        flex: 1;
        overflow-y: auto;
        padding-right: 6px;
      }

      .matchup-card {
        border-radius: 18px;
        border: 1px solid var(--border);
        background: rgba(100, 116, 139, 0.05);
        padding: 10px 10px 10px;
        margin-bottom: 10px;
        position: relative;
        transition: transform 0.2s ease, opacity 0.2s ease;
        touch-action: pan-y;
        user-select: none;
      }

      body.dark .matchup-card {
        background: rgba(15, 23, 42, 0.72);
      }

      .matchup-card.is-dimmed {
        opacity: 0.55;
        filter: grayscale(0.2);
        cursor: default;
      }

      .matchup-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 8px;
      }

      .matchup-label {
        font-size: 13px;
        font-weight: 800;
        color: var(--text);
      }

      .matchup-line {
        font-size: 11px;
        color: var(--muted);
        margin-top: 2px;
      }

      .matchup-tag {
        font-size: 11px;
        color: var(--muted);
        text-align: right;
        white-space: nowrap;
      }

      /* =========================
         SideBias / MyBias bar
         - LEFT = Doubt it
         - RIGHT = Confident
         ========================= */
      .bias-wrap {
        margin-top: 6px;
      }

      .bias-bg {
        height: 10px;
        border-radius: 999px;
        background: rgba(100, 116, 139, 0.10);
        overflow: hidden;
        border: 1px solid rgba(100, 116, 139, 0.22);
      }

      .bias-fill {
        height: 100%;
        border-radius: 999px;
        background: linear-gradient(90deg, var(--bias-blue), rgba(37, 99, 235, 0.55));
        transition: width 0.25s ease;
      }

      .bias-fill.community {
        background: linear-gradient(90deg, var(--bias-green), rgba(22, 163, 74, 0.60));
      }

      .bias-labels {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        margin-top: 4px;
      }

      .bias-labels span:first-child {
        color: var(--muted);
        font-weight: 700;
      }

      .bias-labels span:last-child {
        color: var(--muted);
        font-weight: 700;
      }

      .helper-note {
        margin-top: 8px;
        font-size: 11px;
        color: var(--muted);
      }

      /* =========================
         Buttons
         ========================= */
      .cta-btn {
        width: 100%;
        margin-top: 8px;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(100, 116, 139, 0.08);
        color: var(--text);
        font-size: 12px;
        font-weight: 800;
        cursor: pointer;
      }

      .cta-btn.primary {
        background: var(--brand);
        border-color: transparent;
        color: #fff;
      }

      .cta-btn:hover {
        opacity: 0.95;
      }

      /* =========================
         Toast
         ========================= */
      .swipe-toast {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: rgba(15, 23, 42, 0.94);
        color: #fff;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        padding: 9px 14px;
        font-size: 12px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease, transform 0.2s ease;
        z-index: 90;
        white-space: nowrap;
        max-width: 92vw;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .swipe-toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      /* =========================
         In-app modal (no system alerts)
         ========================= */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(2, 6, 23, 0.55);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 120;
        padding: 18px;
      }
      .modal-overlay.open {
        display: flex;
      }
      .modal {
        width: 100%;
        max-width: 420px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 22px;
        box-shadow: var(--shadow-strong);
        padding: 16px;
      }
      .modal h3 {
        margin: 0 0 6px;
        font-size: 16px;
      }
      .modal p {
        margin: 0 0 12px;
        color: var(--muted);
        font-size: 12px;
        line-height: 1.45;
      }
      .modal-actions {
        display: flex;
        gap: 10px;
      }
      .modal-actions button {
        flex: 1;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(100, 116, 139, 0.08);
        cursor: pointer;
        font-weight: 800;
        color: var(--text);
      }
      .modal-actions button.primary {
        background: var(--brand);
        border-color: transparent;
        color: #fff;
      }

      /* =========================
         Auth overlay (required)
         ========================= */
      #auth-overlay {
        position: fixed;
        inset: 0;
        background: radial-gradient(circle at top, rgba(37, 99, 235, 0.22), rgba(2, 6, 23, 0.70));
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 200;
        padding: 18px;
      }
      #auth-card {
        width: 100%;
        max-width: 420px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 22px;
        box-shadow: var(--shadow-strong);
        padding: 18px 16px 14px;
      }
      #auth-card h2 {
        margin: 0 0 4px;
        font-size: 18px;
      }
      #auth-card .sub {
        margin: 0 0 14px;
        color: var(--muted);
        font-size: 12px;
      }
      .auth-field {
        margin-bottom: 10px;
      }
      .auth-field label {
        display: block;
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 5px;
      }
      .auth-field input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(100, 116, 139, 0.06);
        color: var(--text);
        font-size: 12px;
        outline: none;
      }
      .auth-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .auth-actions button {
        flex: 1;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(100, 116, 139, 0.08);
        cursor: pointer;
        font-weight: 900;
        color: var(--text);
      }
      .auth-actions button.primary {
        background: var(--brand);
        border-color: transparent;
        color: #fff;
      }
      .auth-note {
        margin-top: 10px;
        font-size: 11px;
        color: var(--muted);
        line-height: 1.4;
      }

      @media (max-width: 480px) {
        .card-click-area {
          max-width: 350px;
        }
        .sport-logo-circle {
          width: 104px;
          height: 104px;
          font-size: 36px;
        }
        .swipe-toast {
          white-space: normal;
          text-align: center;
        }
      }
    </style>
  </head>

  <body>
    <div class="app-shell">
      <header>
        <div class="header-left">
          <div class="logo-group" id="logo-group">
            <button id="app-logo-button" class="logo-button" type="button">
              <span class="logo">BEFORETHEBET</span>
              <span class="logo-caret">‚ñæ</span>
            </button>
            <div id="sports-menu" class="sports-menu"></div>
          </div>
          <button id="back-to-sports" type="button">‚Üê Back</button>
        </div>

        <div class="user-menu-wrapper" id="user-menu-wrapper">
          <button class="menu-placeholder" id="user-menu-button" type="button">
            <span id="user-menu-label">Hub</span>
            <span>‚ñæ</span>
          </button>
          <div class="user-dropdown" id="user-dropdown"></div>
        </div>
      </header>

      <main>
        <div class="content">
          <div class="title-block">
            <h1 id="main-title">Select Your Sport</h1>
            <p id="subtitle">One card at a time. Flip to preview matchups.</p>
            <div class="directions" id="directions">
              Tap the <strong>center</strong> to flip. Tap the <strong>right edge</strong> for next, <strong>left edge</strong> for previous. Double-tap center to open.
            </div>
          </div>

          <div class="card-container">
            <div class="card-click-area" id="card-click-area">
              <div class="stack-card stack-3"></div>
              <div class="stack-card stack-2"></div>
              <div class="stack-card stack-1"></div>

              <div class="card card-main" id="sport-card">
                <!-- FRONT -->
                <div class="card-face card-front" id="card-front">
                  <div class="sport-logo-circle" id="sport-logo"></div>
                  <div class="sport-front-name" id="sport-name"></div>
                  <div class="sport-front-code" id="sport-code"></div>
                  <div class="tap-hint" id="tap-hint-front">Double-tap to open ‚Üª</div>
                  <div class="index-indicator" id="index-indicator"></div>
                </div>

                <!-- BACK -->
                <div class="card-face card-back" id="card-back">
                  <div class="back-header">
                    <div class="back-title" id="back-title"></div>
                    <div class="back-sub" id="back-sub"></div>
                  </div>

                  <div class="matchups-list" id="matchups-list"></div>

                  <div class="helper-note" id="back-footer-note"></div>
                  <div class="tap-hint" id="tap-hint-back">Double-tap to close ‚Ü∫</div>
                  <div class="index-indicator" id="index-indicator-back"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <footer>BeforeTheBet ‚Ä¢ Demo</footer>
    </div>

    <!-- REQUIRED AUTH OVERLAY -->
    <div id="auth-overlay">
      <div id="auth-card">
        <h2>Sign in to start</h2>
        <div class="sub">Swiping is locked until you‚Äôre logged in.</div>

        <div class="auth-field">
          <label for="auth-email">Email</label>
          <input id="auth-email" type="email" placeholder="you@email.com" autocomplete="email" />
        </div>

        <div class="auth-field">
          <label for="auth-password">Password</label>
          <input id="auth-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
        </div>

        <div class="auth-actions">
          <button id="auth-signin" class="primary" type="button">Sign In</button>
          <button id="auth-signup" type="button">Create Account</button>
        </div>

        <div class="auth-note" id="auth-note">
          If email confirmations are enabled in Supabase, you‚Äôll need to confirm before signing in.
        </div>
      </div>
    </div>

    <!-- In-app modal -->
    <div class="modal-overlay" id="modal-overlay">
      <div class="modal">
        <h3 id="modal-title">Confirm</h3>
        <p id="modal-text">‚Ä¶</p>
        <div class="modal-actions">
          <button id="modal-cancel" type="button">Cancel</button>
          <button id="modal-ok" class="primary" type="button">Yes</button>
        </div>
      </div>
    </div>

    <div class="swipe-toast" id="swipe-toast"></div>

    <!-- SUPABASE -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      /*************************************************************
       * 0) SUPABASE CLIENT (keep your existing project)
       *************************************************************/
      window.supabase = supabase.createClient(
        "https://kmgrpyvcxonfjswxusbt.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttZ3JweXZjeG9uZmpzd3h1c2J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NjE4NTIsImV4cCI6MjA4MTIzNzg1Mn0.teDypPoT-TMPkIDGemYVRfCNdmK0uAbOCDaiHfNmgac",
        { auth: { persistSession: true, autoRefreshToken: true } }
      );

      /*************************************************************
       * 1) CONSTANTS + SAMPLE DATA
       *************************************************************/
      const APP_NAME = "BeforeTheBet";

      // SideBias rename: UI labels are Doubt it (left) vs Confident (right)
      const LABEL_LEFT = "Doubt it";
      const LABEL_RIGHT = "Confident";

      // Before showing community bias, user must swipe at least 5 times (per account)
      const MIN_SWIPES_TO_UNLOCK_COMMUNITY = 5;

      // Table name for persistence (we‚Äôll wire real schema in Supabase later).
      // This code will try to save/load. If table doesn‚Äôt exist, it falls back to localStorage.
      const DB_TABLE = "btb_items"; // (later you‚Äôll create it)

      // Sports (no baseball)
      const SPORTS = [
        {
          id: "nfl",
          name: "NFL",
          code: "National Football League",
          logoClass: "sport-logo-nfl",
          emoji: "üèà",
          matchups: [
            {
              name: "Chiefs @ Bills",
              lines: [
                { label: "Mahomes o1.5 Passing TDs", confident: 68, doubt: 32, book: "FanDuel" },
                { label: "Allen o36.5 Rush Yards", confident: 57, doubt: 43, book: "BetMGM" },
                { label: "Total 51.5", confident: 54, doubt: 46, book: "ESPN BET" },
                { label: "Chiefs -2.5", confident: 52, doubt: 48, book: "PointsBet" },
              ],
            },
            {
              name: "Eagles @ Cowboys",
              lines: [
                { label: "Hurts o44.5 Rush Yards", confident: 55, doubt: 45, book: "FanDuel" },
                { label: "Lamb o7.5 Targets", confident: 60, doubt: 40, book: "DraftKings" },
                { label: "Eagles +3.5", confident: 58, doubt: 42, book: "BetMGM" },
                { label: "Total 48.5", confident: 51, doubt: 49, book: "Caesars" },
              ],
            },
          ],
        },
        {
          id: "nba",
          name: "NBA",
          code: "National Basketball Association",
          logoClass: "sport-logo-nba",
          emoji: "üèÄ",
          matchups: [
            {
              name: "Lakers @ Warriors",
              lines: [
                { label: "LeBron o26.5 Points", confident: 61, doubt: 39, book: "FanDuel" },
                { label: "Curry o4.5 3PM", confident: 64, doubt: 36, book: "DraftKings" },
                { label: "Total 236.5", confident: 52, doubt: 48, book: "Caesars" },
                { label: "Warriors -3.5", confident: 49, doubt: 51, book: "ESPN BET" },
              ],
            },
            {
              name: "Celtics @ Knicks",
              lines: [
                { label: "Tatum o3.5 3PM", confident: 49, doubt: 51, book: "FanDuel" },
                { label: "Brunson o24.5 Pts", confident: 56, doubt: 44, book: "DraftKings" },
                { label: "Total 224.5", confident: 51, doubt: 49, book: "Caesars" },
                { label: "Celtics -4.5", confident: 58, doubt: 42, book: "ESPN BET" },
              ],
            },
          ],
        },
        {
          id: "nhl",
          name: "NHL",
          code: "National Hockey League",
          logoClass: "sport-logo-nhl",
          emoji: "üèí",
          matchups: [
            {
              name: "Rangers @ Bruins",
              lines: [
                { label: "Rangers ML", confident: 53, doubt: 47, book: "FanDuel" },
                { label: "Total 5.5", confident: 49, doubt: 51, book: "DraftKings" },
              ],
            },
          ],
        },
        {
          id: "cfb",
          name: "CFB",
          code: "College Football",
          logoClass: "sport-logo-cfb",
          emoji: "üèüÔ∏è",
          matchups: [
            {
              name: "Michigan @ Ohio State",
              lines: [
                { label: "Ohio State -3.5", confident: 57, doubt: 43, book: "BetMGM" },
                { label: "Total 46.5", confident: 51, doubt: 49, book: "Caesars" },
              ],
            },
          ],
        },
        {
          id: "mls",
          name: "MLS",
          code: "Major League Soccer",
          logoClass: "sport-logo-mls",
          emoji: "‚öΩ",
          matchups: [
            {
              name: "LAFC @ Galaxy",
              lines: [
                { label: "LAFC ML", confident: 55, doubt: 45, book: "FanDuel" },
                { label: "Total 3.0", confident: 52, doubt: 48, book: "DraftKings" },
              ],
            },
          ],
        },
      ];

      /*************************************************************
       * 2) UI ELEMENTS
       *************************************************************/
      const cardEl = document.getElementById("sport-card");
      const cardClickArea = document.getElementById("card-click-area");

      const logoEl = document.getElementById("sport-logo");
      const nameEl = document.getElementById("sport-name");
      const codeEl = document.getElementById("sport-code");
      const tapHintFrontEl = document.getElementById("tap-hint-front");
      const tapHintBackEl = document.getElementById("tap-hint-back");

      const indexIndicatorFront = document.getElementById("index-indicator");
      const indexIndicatorBack = document.getElementById("index-indicator-back");

      const backTitleEl = document.getElementById("back-title");
      const backSubEl = document.getElementById("back-sub");
      const matchupsListEl = document.getElementById("matchups-list");
      const backFooterNoteEl = document.getElementById("back-footer-note");

      const titleEl = document.getElementById("main-title");
      const subtitleEl = document.getElementById("subtitle");
      const directionsEl = document.getElementById("directions");
      const backToSportsBtn = document.getElementById("back-to-sports");

      const sportsMenuEl = document.getElementById("sports-menu");
      const appLogoButton = document.getElementById("app-logo-button");
      const logoGroup = document.getElementById("logo-group");

      const userMenuButton = document.getElementById("user-menu-button");
      const userMenuLabel = document.getElementById("user-menu-label");
      const userDropdown = document.getElementById("user-dropdown");
      const userMenuWrapper = document.getElementById("user-menu-wrapper");

      const swipeToastEl = document.getElementById("swipe-toast");

      const authOverlay = document.getElementById("auth-overlay");
      const authEmailInput = document.getElementById("auth-email");
      const authPasswordInput = document.getElementById("auth-password");
      const authSignInBtn = document.getElementById("auth-signin");
      const authSignUpBtn = document.getElementById("auth-signup");
      const authNoteEl = document.getElementById("auth-note");

      const modalOverlay = document.getElementById("modal-overlay");
      const modalTitle = document.getElementById("modal-title");
      const modalText = document.getElementById("modal-text");
      const modalCancel = document.getElementById("modal-cancel");
      const modalOk = document.getElementById("modal-ok");

      /*************************************************************
       * 3) APP STATE
       *************************************************************/
      let mode = "sports"; // sports | matchups | allLines | lineDetails | mybias | mylocks | myarchives
      let currentSportIndex = 0;
      let currentMatchupIndex = 0;
      let flipped = false;

      let previousModeBeforeLineDetails = null;
      let currentLineDetailMeta = null;

      const DOUBLE_CLICK_DELAY = 250;
      let clickTimeout = null;

      let currentUser = null; // supabase user object

      // Local in-memory store. Persisted per user after login.
      // item_key -> { ...data, status: mybias|mylocks|myarchives, yourVote, swipedAt, book, ... }
      let itemStore = {};

      // Track user swipes count (for ‚Äúunlock community bias after 5 swipes‚Äù)
      let userSwipeCount = 0;

      // For long-press per line
      const HOLD_MS = 700;

      // If DB table not present, we fallback to localStorage per user id
      let persistenceWarned = false;

      /*************************************************************
       * 4) HELPERS
       *************************************************************/
      function showToast(msg) {
        swipeToastEl.textContent = msg;
        swipeToastEl.classList.add("show");
        clearTimeout(swipeToastEl._hideTimeout);
        swipeToastEl._hideTimeout = setTimeout(() => {
          swipeToastEl.classList.remove("show");
        }, 1200);
      }

      function openModal({ title, text, okText = "Yes" }) {
        modalTitle.textContent = title || "Confirm";
        modalText.textContent = text || "";
        modalOk.textContent = okText;
        modalOverlay.classList.add("open");

        return new Promise((resolve) => {
          function cleanup() {
            modalOverlay.classList.remove("open");
            modalCancel.removeEventListener("click", onCancel);
            modalOk.removeEventListener("click", onOk);
            modalOverlay.removeEventListener("click", onBg);
          }
          function onCancel() {
            cleanup();
            resolve(false);
          }
          function onOk() {
            cleanup();
            resolve(true);
          }
          function onBg(e) {
            if (e.target === modalOverlay) onCancel();
          }

          modalCancel.addEventListener("click", onCancel);
          modalOk.addEventListener("click", onOk);
          modalOverlay.addEventListener("click", onBg);
        });
      }

      function getNextIndex(length, current) {
        return (current + 1) % length;
      }
      function getPrevIndex(length, current) {
        return current === 0 ? length - 1 : current - 1;
      }
      function currentSport() {
        return SPORTS[currentSportIndex];
      }
      function currentMatchup() {
        return currentSport().matchups[currentMatchupIndex];
      }

      function makeItemKey(meta) {
        const sport = SPORTS[meta.sportIndex];
        const matchup = sport.matchups[meta.matchupIndex];
        const book = meta.book || "Best Available";
        return `${sport.id}|${matchup.name}|${meta.label}|${book}`;
      }

      function isCommunityUnlocked() {
        return userSwipeCount >= MIN_SWIPES_TO_UNLOCK_COMMUNITY;
      }

      function biasBarColorClass() {
        return isCommunityUnlocked() ? "community" : "";
      }

      function getDisplayedBias(meta, fallbackConf, fallbackDoubt) {
        // Before unlock: show 50/50 blue.
        if (!isCommunityUnlocked()) {
          return { confident: 50, doubt: 50, community: false };
        }
        // After unlock: show community bias (green).
        const conf = typeof fallbackConf === "number" ? fallbackConf : 55;
        const doubt = typeof fallbackDoubt === "number" ? fallbackDoubt : (100 - conf);
        return { confident: conf, doubt: doubt, community: true };
      }

      function renderCardFlipState() {
        if (flipped) cardEl.classList.add("flipped");
        else cardEl.classList.remove("flipped");
      }

      function clampPct(n) {
        n = Number(n);
        if (!Number.isFinite(n)) return 50;
        return Math.max(0, Math.min(100, n));
      }

      function localKeyForUser() {
        const uid = currentUser?.id || "anon";
        return `btb_store_${uid}`;
      }

      function saveLocalFallback() {
        try {
          localStorage.setItem(localKeyForUser(), JSON.stringify({ itemStore, userSwipeCount, theme: getTheme() }));
        } catch {}
      }

      function loadLocalFallback() {
        try {
          const raw = localStorage.getItem(localKeyForUser());
          if (!raw) return;
          const parsed = JSON.parse(raw);
          if (parsed?.itemStore) itemStore = parsed.itemStore;
          if (typeof parsed?.userSwipeCount === "number") userSwipeCount = parsed.userSwipeCount;
          if (parsed?.theme) setTheme(parsed.theme);
        } catch {}
      }

      function getTheme() {
        return document.body.classList.contains("dark") ? "dark" : "light";
      }
      function setTheme(theme) {
        const t = theme === "dark" ? "dark" : "light";
        document.body.classList.toggle("dark", t === "dark");
      }

      /*************************************************************
       * 5) PERSISTENCE (Supabase attempts; fallback to localStorage)
       *************************************************************/
      async function dbUpsertItem(item) {
        if (!currentUser) return false;

        try {
          const payload = {
            user_id: currentUser.id,
            item_key: item.key,
            status: item.status,
            data: item,
            updated_at: new Date().toISOString(),
          };

          const { error } = await window.supabase.from(DB_TABLE).upsert(payload, {
            onConflict: "user_id,item_key",
          });

          if (error) {
            if (!persistenceWarned) {
              persistenceWarned = true;
              console.warn("DB upsert error (fallback to localStorage):", error);
              showToast("Saving locally (DB not connected yet)");
            }
            return false;
          }
          return true;
        } catch (e) {
          if (!persistenceWarned) {
            persistenceWarned = true;
            console.warn("DB upsert exception (fallback to localStorage):", e);
            showToast("Saving locally (DB not connected yet)");
          }
          return false;
        }
      }

      async function dbLoadAll() {
        if (!currentUser) return false;

        try {
          const { data, error } = await window.supabase
            .from(DB_TABLE)
            .select("data")
            .eq("user_id", currentUser.id);

          if (error) {
            console.warn("DB load error (fallback to localStorage):", error);
            return false;
          }

          const nextStore = {};
          (data || []).forEach((row) => {
            const it = row?.data;
            if (it?.key) nextStore[it.key] = it;
          });
          itemStore = nextStore;

          // derive swipe count (persist later properly)
          userSwipeCount = Object.values(itemStore).reduce((acc, it) => acc + (it?.yourSwipes || 0), 0);

          return true;
        } catch (e) {
          console.warn("DB load exception:", e);
          return false;
        }
      }

      async function persistEverythingFallback() {
        // fallback only (local)
        saveLocalFallback();
      }

      /*************************************************************
       * 6) CORE: RECORD + UPDATE ITEMS
       *************************************************************/
      function ensureItem(meta, communityConf, communityDoubt) {
        const key = makeItemKey(meta);
        let item = itemStore[key];

        if (!item) {
          item = {
            key,
            sportId: SPORTS[meta.sportIndex].id,
            sportName: SPORTS[meta.sportIndex].name,
            sportIndex: meta.sportIndex,
            matchupIndex: meta.matchupIndex,
            matchupName: SPORTS[meta.sportIndex].matchups[meta.matchupIndex].name,
            lineLabel: meta.label,
            book: meta.book || "Best Available",
            // community bias values (green after unlock)
            communityConfident: clampPct(communityConf ?? 55),
            communityDoubt: clampPct(communityDoubt ?? 45),
            status: "mybias",
            yourVote: null, // "confident" | "doubt"
            swipedAt: null,
            yourSwipes: 0,
          };
          itemStore[key] = item;
        }

        return item;
      }

      async function setItemStatus(item, status) {
        item.status = status;
        item.updatedAt = Date.now();

        // Try DB; fallback local
        const ok = await dbUpsertItem(item);
        if (!ok) await persistEverythingFallback();
      }

      async function recordVote(meta, vote, communityConf, communityDoubt) {
        const item = ensureItem(meta, communityConf, communityDoubt);

        // one swipe per line; if already voted, don‚Äôt allow another swipe
        if (item.yourVote) return;

        item.yourVote = vote; // "confident" or "doubt"
        item.swipedAt = Date.now();
        item.yourSwipes += 1;

        userSwipeCount += 1;

        // stays in MyBias unless we are swiping inside MyBias screen (then promote)
        if (mode === "mybias") {
          const target = vote === "confident" ? "mylocks" : "myarchives";
          await setItemStatus(item, target);
        } else {
          await setItemStatus(item, "mybias");
        }

        // Persist swipe count locally at least
        await persistEverythingFallback();
      }

      async function flipVoteForOneItem(item) {
        if (!item?.yourVote) return;

        const newVote = item.yourVote === "confident" ? "doubt" : "confident";
        item.yourVote = newVote;
        item.updatedAt = Date.now();

        // If in locks and you flip to doubt, move to archives; and vice versa
        if (item.status === "mylocks" && newVote === "doubt") {
          item.status = "myarchives";
        } else if (item.status === "myarchives" && newVote === "confident") {
          item.status = "mylocks";
        } else if (item.status === "mybias") {
          // In MyBias, flipping vote should also move it accordingly
          item.status = newVote === "confident" ? "mylocks" : "myarchives";
        }

        const ok = await dbUpsertItem(item);
        if (!ok) await persistEverythingFallback();
      }

      async function removeFromLocks(item) {
        if (!item) return;
        item.status = "mybias";
        item.updatedAt = Date.now();
        const ok = await dbUpsertItem(item);
        if (!ok) await persistEverythingFallback();
      }

      /*************************************************************
       * 7) BUILD SIDE BIAS UI
       *************************************************************/
      function buildSideBiasUI(meta, communityConf, communityDoubt) {
        const { confident, doubt, community } = getDisplayedBias(meta, communityConf, communityDoubt);

        const wrap = document.createElement("div");
        wrap.className = "bias-wrap";

        const bg = document.createElement("div");
        bg.className = "bias-bg";

        const fill = document.createElement("div");
        fill.className = "bias-fill " + (community ? "community" : "");
        fill.style.width = clampPct(confident) + "%"; // RIGHT side is Confident (we fill by confident %)

        bg.appendChild(fill);

        const labels = document.createElement("div");
        labels.className = "bias-labels";

        // LEFT is Doubt it
        const left = document.createElement("span");
        left.textContent = `${LABEL_LEFT} ${clampPct(doubt)}%`;

        // RIGHT is Confident
        const right = document.createElement("span");
        right.textContent = `${LABEL_RIGHT} ${clampPct(confident)}%`;

        labels.appendChild(left);
        labels.appendChild(right);

        wrap.appendChild(bg);
        wrap.appendChild(labels);

        return wrap;
      }

      /*************************************************************
       * 8) LINE CARD INTERACTION:
       * - swipe once => dims and moves to bottom
       * - dblclick => opens Line Details
       * - long-press => in-app modal to change bias (only that line)
       *************************************************************/
      function attachLineInteractions(card, meta, communityConf, communityDoubt) {
        let startX = null;
        let isDown = false;
        let holdTimer = null;

        const key = makeItemKey(meta);

        function makeDimAndMoveToBottom() {
          card.classList.add("is-dimmed");
          // move to bottom
          if (card.parentNode) card.parentNode.appendChild(card);
        }

        function alreadyVoted() {
          return !!itemStore[key]?.yourVote;
        }

        function onLongPress() {
          // Only for lines the user already swiped
          const item = itemStore[key];
          if (!item?.yourVote) return;

          (async () => {
            const yes = await openModal({
              title: "Change your bias?",
              text: `This will flip only this line.\n\nCurrent: ${item.yourVote === "confident" ? "Confident" : "Doubt it"}`,
              okText: "Flip",
            });
            if (!yes) return;

            await flipVoteForOneItem(item);
            showToast("Updated bias for this line");
            renderScreen();
          })();
        }

        card.addEventListener("dblclick", (e) => {
          e.stopPropagation();
          openLineDetails(meta, communityConf, communityDoubt);
        });

        card.addEventListener("pointerdown", (e) => {
          // No swiping without auth
          if (!currentUser) return;

          isDown = true;
          startX = e.clientX;

          // long press
          clearTimeout(holdTimer);
          holdTimer = setTimeout(() => {
            if (!isDown) return;
            onLongPress();
          }, HOLD_MS);
        });

        card.addEventListener("pointerup", (e) => {
          if (!currentUser) return;
          if (!isDown) return;
          isDown = false;
          clearTimeout(holdTimer);

          // if already swiped, ignore swipe attempts (only long-press allowed)
          if (alreadyVoted()) {
            makeDimAndMoveToBottom();
            return;
          }

          const dx = e.clientX - startX;
          const threshold = 40;
          if (Math.abs(dx) < threshold) return;

          e.stopPropagation();

          // RIGHT = Confident, LEFT = Doubt it
          const vote = dx > 0 ? "confident" : "doubt";

          (async () => {
            await recordVote(meta, vote, communityConf, communityDoubt);

            showToast(vote === "confident" ? `‚úÖ ${LABEL_RIGHT}` : `‚ùì ${LABEL_LEFT}`);

            // Immediately dim and drop to bottom (and cannot be swiped again)
            makeDimAndMoveToBottom();

            // If user just unlocked community bias, re-render so bars turn green
            if (userSwipeCount === MIN_SWIPES_TO_UNLOCK_COMMUNITY) {
              showToast("Community bias unlocked");
              renderScreen();
            }

            // If we're in MyBias, swiping should move item out (to Locks/Archives) and refresh
            if (mode === "mybias") {
              renderScreen();
            }
          })();
        });

        card.addEventListener("pointercancel", () => {
          isDown = false;
          clearTimeout(holdTimer);
        });

        // If already swiped, dim by default
        if (alreadyVoted()) {
          card.classList.add("is-dimmed");
        }
      }

      /*************************************************************
       * 9) LINE DETAILS (placeholder stats, same card size)
       *************************************************************/
      function openLineDetails(meta, communityConf, communityDoubt) {
        previousModeBeforeLineDetails = mode === "lineDetails" ? previousModeBeforeLineDetails : mode;
        currentLineDetailMeta = { ...meta, communityConf, communityDoubt };
        mode = "lineDetails";
        flipped = true;
        renderScreen();
      }

      function renderLineDetailsFront() {
        const meta = currentLineDetailMeta;
        const sport = SPORTS[meta.sportIndex];

        logoEl.className = "sport-logo-circle " + sport.logoClass;
        logoEl.textContent = "üìà";
        nameEl.textContent = "Line Details";
        codeEl.textContent = `${sport.name} ‚Ä¢ ${sport.matchups[meta.matchupIndex].name}`;
        tapHintFrontEl.textContent = "Double-tap to close ‚Ü∫";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderLineDetailsBack() {
        const meta = currentLineDetailMeta;
        const sport = SPORTS[meta.sportIndex];
        const matchup = sport.matchups[meta.matchupIndex];

        backTitleEl.textContent = "Line Details";
        backSubEl.textContent = meta.label;
        backFooterNoteEl.textContent = "Placeholder stats (we‚Äôll wire real data later).";

        matchupsListEl.innerHTML = "";

        const card = document.createElement("div");
        card.className = "matchup-card";
        card.style.cursor = "default";

        const top = document.createElement("div");
        top.className = "matchup-top";

        const left = document.createElement("div");
        const label = document.createElement("div");
        label.className = "matchup-label";
        label.textContent = meta.label;

        const line = document.createElement("div");
        line.className = "matchup-line";
        line.textContent = `${matchup.name} ‚Ä¢ ${meta.book || "Best Available"}`;

        const helper = document.createElement("div");
        helper.className = "matchup-line";
        helper.textContent = "Double-tap anywhere on the card to go back.";

        left.appendChild(label);
        left.appendChild(line);
        left.appendChild(helper);

        const right = document.createElement("div");
        right.className = "matchup-tag";
        right.textContent = "Stats (demo)";

        top.appendChild(left);
        top.appendChild(right);

        card.appendChild(top);

        // Bias bar
        card.appendChild(buildSideBiasUI(meta, meta.communityConf, meta.communityDoubt));

        // Placeholder rows
        const rows = [
          ["Season Avg", (Math.random() * 10 + 10).toFixed(1)],
          ["Last 10 Avg", (Math.random() * 10 + 10).toFixed(1)],
          ["Hit Rate", `${Math.floor(Math.random() * 30 + 55)}%`],
          ["Games Sampled", `${Math.floor(Math.random() * 15 + 10)}`],
        ];

        rows.forEach(([k, v]) => {
          const r = document.createElement("div");
          r.className = "matchup-line";
          r.style.marginTop = "6px";
          r.innerHTML = `<strong style="color: var(--text)">${k}:</strong> ${v}`;
          card.appendChild(r);
        });

        matchupsListEl.appendChild(card);
      }

      /*************************************************************
       * 10) RENDERERS
       *************************************************************/
      function renderSportsFront() {
        const sport = currentSport();
        logoEl.className = "sport-logo-circle " + sport.logoClass;
        logoEl.textContent = sport.emoji;
        nameEl.textContent = sport.name;
        codeEl.textContent = sport.code;
        tapHintFrontEl.textContent = "Double-tap to open ‚Üª";
        const idx = `${currentSportIndex + 1} / ${SPORTS.length}`;
        indexIndicatorFront.textContent = idx;
        indexIndicatorBack.textContent = idx;
      }

      function renderSportsBack() {
        const sport = currentSport();
        backTitleEl.textContent = `${sport.name} ‚Äì Matchups`;
        backSubEl.textContent = "Double-tap a matchup to open all lines.";
        backFooterNoteEl.textContent = `SideBias is ${isCommunityUnlocked() ? "live community bias (green)" : "hidden until 5 swipes (blue 50/50)"}.`;

        matchupsListEl.innerHTML = "";

        sport.matchups.forEach((matchup, mIndex) => {
          const ln = matchup.lines[0] || { label: "No lines yet", confident: 50, doubt: 50, book: "‚Äî" };

          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = matchup.name;

          const sub = document.createElement("div");
          sub.className = "matchup-line";
          sub.textContent = ln.label;

          left.appendChild(label);
          left.appendChild(sub);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = ln.book || "Consensus";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);
          card.appendChild(buildSideBiasUI(
            { sportIndex: currentSportIndex, matchupIndex: mIndex, label: ln.label, book: ln.book },
            ln.confident,
            ln.doubt
          ));

          // Clicking a matchup card doesn't swipe; dblclick opens
          card.addEventListener("dblclick", (e) => {
            e.stopPropagation();
            mode = "allLines";
            currentMatchupIndex = mIndex;
            flipped = false; // IMPORTANT: do not auto-flip; user double-clicks center to flip.
            renderScreen();
          });

          matchupsListEl.appendChild(card);
        });
      }

      function renderMatchupsFront() {
        const sport = currentSport();
        const matchup = currentMatchup();

        logoEl.className = "sport-logo-circle " + sport.logoClass;
        logoEl.textContent = sport.emoji;
        nameEl.textContent = matchup.name;
        codeEl.textContent = sport.name;

        // single click center on allLines front should change game; in matchups front, keep normal hint
        tapHintFrontEl.textContent = "Tap edges to change matchup ‚Ä¢ Double-tap to open ‚Üª";

        const idx = `${currentMatchupIndex + 1} / ${sport.matchups.length}`;
        indexIndicatorFront.textContent = idx;
        indexIndicatorBack.textContent = idx;
      }

      function renderMatchupsBack() {
        const sport = currentSport();
        const matchup = currentMatchup();

        backTitleEl.textContent = `${sport.name} ‚Äì Top Lines`;
        backSubEl.textContent = "Swipe: LEFT = Doubt it, RIGHT = Confident. Double-tap a line for details.";
        backFooterNoteEl.textContent = isCommunityUnlocked()
          ? "Community bias is visible (green)."
          : "Swipe 5 lines to unlock community bias (green).";

        matchupsListEl.innerHTML = "";

        const linesToShow = matchup.lines.slice(0, 6);

        linesToShow.forEach((ln) => {
          const meta = {
            sportIndex: currentSportIndex,
            matchupIndex: currentMatchupIndex,
            label: ln.label,
            book: ln.book || "Best Available",
          };

          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = ln.label;

          const sub = document.createElement("div");
          sub.className = "matchup-line";
          sub.textContent = matchup.name;

          const helper = document.createElement("div");
          helper.className = "matchup-line";
          helper.textContent = "Swipe once to set your bias. Hold to change later.";

          left.appendChild(label);
          left.appendChild(sub);
          left.appendChild(helper);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = ln.book || "Consensus";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);
          card.appendChild(buildSideBiasUI(meta, ln.confident, ln.doubt));

          attachLineInteractions(card, meta, ln.confident, ln.doubt);

          matchupsListEl.appendChild(card);
        });
      }

      function renderAllLinesFront() {
        const sport = currentSport();
        const matchup = currentMatchup();

        logoEl.className = "sport-logo-circle " + sport.logoClass;
        logoEl.textContent = sport.emoji;
        nameEl.textContent = matchup.name;
        codeEl.textContent = `${sport.name} ‚Ä¢ All Lines`;

        // IMPORTANT behavior: single click center changes game; does NOT flip to show lines
        tapHintFrontEl.textContent = "Tap center to change game ‚Ä¢ Double-tap center to view lines ‚Üª";

        const idx = `${currentMatchupIndex + 1} / ${sport.matchups.length}`;
        indexIndicatorFront.textContent = idx;
        indexIndicatorBack.textContent = idx;
      }

      function renderAllLinesBack() {
        const sport = currentSport();
        const matchup = currentMatchup();

        backTitleEl.textContent = `${sport.name} ‚Äì All Lines`;
        backSubEl.textContent = `${matchup.name} ‚Ä¢ Swipe lines (LEFT=Doubt it, RIGHT=Confident).`;
        backFooterNoteEl.textContent = isCommunityUnlocked()
          ? "Community bias is visible (green)."
          : "Swipe 5 lines to unlock community bias (green).";

        matchupsListEl.innerHTML = "";

        matchup.lines.forEach((ln) => {
          const meta = {
            sportIndex: currentSportIndex,
            matchupIndex: currentMatchupIndex,
            label: ln.label,
            book: ln.book || "Best Available",
          };

          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = ln.label;

          const sub = document.createElement("div");
          sub.className = "matchup-line";
          sub.textContent = `${matchup.name} ‚Ä¢ ${ln.book || "Consensus"}`;

          const helper = document.createElement("div");
          helper.className = "matchup-line";
          helper.textContent = "Double-tap for details. Hold to flip your bias later.";

          left.appendChild(label);
          left.appendChild(sub);
          left.appendChild(helper);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = ln.book || "Consensus";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);
          card.appendChild(buildSideBiasUI(meta, ln.confident, ln.doubt));

          attachLineInteractions(card, meta, ln.confident, ln.doubt);

          matchupsListEl.appendChild(card);
        });
      }

      function renderMyBiasFront() {
        logoEl.className = "sport-logo-circle sport-logo-nba";
        logoEl.textContent = "üß†";
        nameEl.textContent = "MyBias";
        codeEl.textContent = "Lines you swiped in the main flow";
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderMyBiasBack() {
        backTitleEl.textContent = "MyBias";
        backSubEl.textContent = "Swipe RIGHT = move to MyLocks ‚Ä¢ Swipe LEFT = move to MyArchives ‚Ä¢ Hold to flip bias.";
        backFooterNoteEl.textContent = "All items are saved to your profile (or locally until DB is wired).";

        matchupsListEl.innerHTML = "";

        const items = Object.values(itemStore)
          .filter((it) => it.status === "mybias")
          .sort((a, b) => (b.swipedAt || 0) - (a.swipedAt || 0));

        if (items.length === 0) {
          const empty = document.createElement("div");
          empty.className = "matchup-card";
          const t = document.createElement("div");
          t.className = "matchup-label";
          t.textContent = "No lines yet";
          const p = document.createElement("div");
          p.className = "matchup-line";
          p.textContent = "Go swipe a few lines in All Lines. Then come back here to lock or archive.";
          empty.appendChild(t);
          empty.appendChild(p);
          matchupsListEl.appendChild(empty);
          return;
        }

        items.forEach((it) => {
          const meta = {
            sportIndex: it.sportIndex,
            matchupIndex: it.matchupIndex,
            label: it.lineLabel,
            book: it.book,
          };

          // Display community bias; per requirements: MyBias shows community bias once unlocked.
          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = it.lineLabel;

          const sub = document.createElement("div");
          sub.className = "matchup-line";
          sub.textContent = `${it.matchupName} ‚Ä¢ ${it.sportName}`;

          const helper = document.createElement("div");
          helper.className = "matchup-line";
          helper.textContent = "Swipe to move it. Hold to flip. Double-tap for details.";

          left.appendChild(label);
          left.appendChild(sub);
          left.appendChild(helper);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = it.book || "Best Available";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);
          card.appendChild(buildSideBiasUI(meta, it.communityConfident, it.communityDoubt));

          // In MyBias, swiping should move to Locks/Archives:
          // We attach interactions, but with community bias meta values.
          attachLineInteractions(card, meta, it.communityConfident, it.communityDoubt);

          // If already voted, dim and drop bottom
          if (it.yourVote) card.classList.add("is-dimmed");

          matchupsListEl.appendChild(card);
        });
      }

      function renderMyLocksFront() {
        logoEl.className = "sport-logo-circle sport-logo-nfl";
        logoEl.textContent = "üîí";
        nameEl.textContent = "MyLocks";
        codeEl.textContent = "Your confident picks grouped by sportsbook";
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderMyLocksBack() {
        backTitleEl.textContent = "MyLocks";
        backSubEl.textContent = "Grouped by sportsbook. Hold a lock to remove (back to MyBias).";
        backFooterNoteEl.textContent = "Locks persist across devices for your login.";

        matchupsListEl.innerHTML = "";

        const locks = Object.values(itemStore)
          .filter((it) => it.status === "mylocks")
          .sort((a, b) => (b.swipedAt || 0) - (a.swipedAt || 0));

        if (locks.length === 0) {
          const empty = document.createElement("div");
          empty.className = "matchup-card";
          const t = document.createElement("div");
          t.className = "matchup-label";
          t.textContent = "No locks yet";
          const p = document.createElement("div");
          p.className = "matchup-line";
          p.textContent = "Go to MyBias and swipe RIGHT on a line to lock it.";
          empty.appendChild(t);
          empty.appendChild(p);
          matchupsListEl.appendChild(empty);
          return;
        }

        const byBook = {};
        locks.forEach((it) => {
          const book = it.book || "Best Available";
          if (!byBook[book]) byBook[book] = [];
          byBook[book].push(it);
        });

        Object.keys(byBook).sort().forEach((book) => {
          const header = document.createElement("div");
          header.className = "matchup-line";
          header.style.margin = "12px 2px 8px";
          header.style.fontWeight = "900";
          header.style.letterSpacing = "0.12em";
          header.style.textTransform = "uppercase";
          header.style.color = "var(--muted)";
          header.textContent = book;
          matchupsListEl.appendChild(header);

          byBook[book].forEach((it) => {
            const meta = {
              sportIndex: it.sportIndex,
              matchupIndex: it.matchupIndex,
              label: it.lineLabel,
              book: it.book,
            };

            const card = document.createElement("div");
            card.className = "matchup-card is-dimmed"; // cannot be swiped again

            const top = document.createElement("div");
            top.className = "matchup-top";

            const left = document.createElement("div");
            const label = document.createElement("div");
            label.className = "matchup-label";
            label.textContent = it.lineLabel;

            const sub = document.createElement("div");
            sub.className = "matchup-line";
            sub.textContent = `${it.matchupName} ‚Ä¢ ${it.sportName}`;

            const helper = document.createElement("div");
            helper.className = "matchup-line";
            helper.textContent = "Hold to remove from locks. Double-tap for details.";

            left.appendChild(label);
            left.appendChild(sub);
            left.appendChild(helper);

            const right = document.createElement("div");
            right.className = "matchup-tag";
            right.textContent = "LOCKED";

            top.appendChild(left);
            top.appendChild(right);

            card.appendChild(top);
            card.appendChild(buildSideBiasUI(meta, it.communityConfident, it.communityDoubt));

            // long press => remove from locks (only this line)
            let isDown = false;
            let holdTimer = null;

            card.addEventListener("dblclick", (e) => {
              e.stopPropagation();
              openLineDetails(meta, it.communityConfident, it.communityDoubt);
            });

            card.addEventListener("pointerdown", (e) => {
              if (!currentUser) return;
              isDown = true;
              clearTimeout(holdTimer);
              holdTimer = setTimeout(async () => {
                if (!isDown) return;
                const yes = await openModal({
                  title: "Remove from MyLocks?",
                  text: "This will move only this line back to MyBias.",
                  okText: "Remove",
                });
                if (!yes) return;
                await removeFromLocks(it);
                showToast("Removed from locks");
                renderScreen();
              }, HOLD_MS);
            });

            card.addEventListener("pointerup", () => {
              isDown = false;
              clearTimeout(holdTimer);
            });

            card.addEventListener("pointercancel", () => {
              isDown = false;
              clearTimeout(holdTimer);
            });

            matchupsListEl.appendChild(card);
          });

          const btn = document.createElement("button");
          btn.className = "cta-btn primary";
          btn.textContent = `PLACE BET IN ${book.toUpperCase()}`;
          btn.addEventListener("click", async (e) => {
            e.stopPropagation();
            // In-app popup only
            await openModal({
              title: "Coming Soon",
              text: "For now, please access your book directly to wager.",
              okText: "Got it",
            });
          });
          matchupsListEl.appendChild(btn);
        });
      }

      function renderMyArchivesFront() {
        logoEl.className = "sport-logo-circle sport-logo-nhl";
        logoEl.textContent = "üóÉÔ∏è";
        nameEl.textContent = "MyArchives";
        codeEl.textContent = "Lines you doubted";
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderMyArchivesBack() {
        backTitleEl.textContent = "MyArchives";
        backSubEl.textContent = "Hold a line to flip bias (it will move to locks if you flip to Confident).";
        backFooterNoteEl.textContent = "Archives persist across devices for your login.";

        matchupsListEl.innerHTML = "";

        const items = Object.values(itemStore)
          .filter((it) => it.status === "myarchives")
          .sort((a, b) => (b.swipedAt || 0) - (a.swipedAt || 0));

        if (items.length === 0) {
          const empty = document.createElement("div");
          empty.className = "matchup-card";
          const t = document.createElement("div");
          t.className = "matchup-label";
          t.textContent = "No archived lines";
          const p = document.createElement("div");
          p.className = "matchup-line";
          p.textContent = "Swipe LEFT on a MyBias line to archive it.";
          empty.appendChild(t);
          empty.appendChild(p);
          matchupsListEl.appendChild(empty);
          return;
        }

        items.forEach((it) => {
          const meta = {
            sportIndex: it.sportIndex,
            matchupIndex: it.matchupIndex,
            label: it.lineLabel,
            book: it.book,
          };

          const card = document.createElement("div");
          card.className = "matchup-card is-dimmed";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = it.lineLabel;

          const sub = document.createElement("div");
          sub.className = "matchup-line";
          sub.textContent = `${it.matchupName} ‚Ä¢ ${it.sportName}`;

          const helper = document.createElement("div");
          helper.className = "matchup-line";
          helper.textContent = "Hold to flip bias. Double-tap for details.";

          left.appendChild(label);
          left.appendChild(sub);
          left.appendChild(helper);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = "ARCHIVED";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);
          card.appendChild(buildSideBiasUI(meta, it.communityConfident, it.communityDoubt));

          // long press => flip bias for only this line
          let isDown = false;
          let holdTimer = null;

          card.addEventListener("dblclick", (e) => {
            e.stopPropagation();
            openLineDetails(meta, it.communityConfident, it.communityDoubt);
          });

          card.addEventListener("pointerdown", () => {
            if (!currentUser) return;
            isDown = true;
            clearTimeout(holdTimer);
            holdTimer = setTimeout(async () => {
              if (!isDown) return;
              const yes = await openModal({
                title: "Change your bias?",
                text: "This flips only this line. If it becomes Confident, it will move to MyLocks.",
                okText: "Flip",
              });
              if (!yes) return;
              await flipVoteForOneItem(it);
              showToast("Updated");
              renderScreen();
            }, HOLD_MS);
          });

          card.addEventListener("pointerup", () => {
            isDown = false;
            clearTimeout(holdTimer);
          });

          card.addEventListener("pointercancel", () => {
            isDown = false;
            clearTimeout(holdTimer);
          });

          matchupsListEl.appendChild(card);
        });
      }

      function renderScreen() {
        if (mode === "sports") {
          titleEl.textContent = "Select Your Sport";
          subtitleEl.textContent = "Flip to preview matchups.";
          directionsEl.innerHTML =
            'Tap the <strong>center</strong> to flip. Tap edges to change sport. Double-tap center to open.';
          backToSportsBtn.style.display = "none";

          renderSportsFront();
          renderSportsBack();
        } else if (mode === "matchups") {
          const sport = currentSport();
          titleEl.textContent = `${sport.name} Matchups`;
          subtitleEl.textContent = "Flip to see top lines.";
          directionsEl.innerHTML =
            'Tap edges to change matchup. Tap center to flip. Double-tap center to open <strong>All Lines</strong>.';
          backToSportsBtn.style.display = "inline-flex";

          renderMatchupsFront();
          renderMatchupsBack();
        } else if (mode === "allLines") {
          const sport = currentSport();
          titleEl.textContent = `${sport.name} ‚Äì All Lines`;
          subtitleEl.textContent = currentMatchup().name;
          directionsEl.innerHTML =
            'Tap center to change game. Double-tap center to show/hide lines. Swipe lines: <strong>LEFT = Doubt it</strong>, <strong>RIGHT = Confident</strong>.';
          backToSportsBtn.style.display = "inline-flex";

          renderAllLinesFront();
          renderAllLinesBack();
        } else if (mode === "lineDetails") {
          titleEl.textContent = "Line Details";
          subtitleEl.textContent = "Placeholder stats view";
          directionsEl.innerHTML = "Double-tap center to return.";
          backToSportsBtn.style.display = "inline-flex";

          renderLineDetailsFront();
          renderLineDetailsBack();
          flipped = true;
        } else if (mode === "mybias") {
          titleEl.textContent = "MyBias";
          subtitleEl.textContent = "Your swiped lines (promote to Locks or Archives)";
          directionsEl.innerHTML =
            'Swipe in this list: <strong>RIGHT = MyLocks</strong>, <strong>LEFT = MyArchives</strong>. Hold to flip a single line.';
          backToSportsBtn.style.display = "inline-flex";

          renderMyBiasFront();
          renderMyBiasBack();
          flipped = true;
        } else if (mode === "mylocks") {
          titleEl.textContent = "MyLocks";
          subtitleEl.textContent = "Grouped by sportsbook";
          directionsEl.innerHTML =
            'Hold a lock to remove it. Use ‚ÄúPLACE BET IN ‚Ä¶‚Äù buttons (affiliate links coming soon).';
          backToSportsBtn.style.display = "inline-flex";

          renderMyLocksFront();
          renderMyLocksBack();
          flipped = true;
        } else if (mode === "myarchives") {
          titleEl.textContent = "MyArchives";
          subtitleEl.textContent = "Archived lines";
          directionsEl.innerHTML =
            'Hold a line to flip bias (it may move to locks). Double-tap for details.';
          backToSportsBtn.style.display = "inline-flex";

          renderMyArchivesFront();
          renderMyArchivesBack();
          flipped = true;
        }

        renderCardFlipState();
      }

      function handleGlobalBack() {
        if (mode === "lineDetails" && previousModeBeforeLineDetails) {
          mode = previousModeBeforeLineDetails;
          flipped = true;
          renderScreen();
          return;
        }

        if (mode === "allLines") {
          mode = "matchups";
          flipped = false;
          renderScreen();
          return;
        }

        if (mode === "matchups" || mode === "mybias" || mode === "mylocks" || mode === "myarchives") {
          mode = "sports";
          flipped = false;
          renderScreen();
          return;
        }
      }

      backToSportsBtn.addEventListener("click", () => handleGlobalBack());

      /*************************************************************
       * 11) CARD CLICK LOGIC
       * - DO NOT auto flip back after swipes.
       * - allLines front: single center click changes game, not flip.
       * - flip only via center click (sports/matchups) or double-click (allLines).
       *************************************************************/
      function zoneFromEvent(e) {
        const rect = cardClickArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        return x / rect.width;
      }

      function handleSingleClick(e) {
        const zone = zoneFromEvent(e);

        // If in All Lines FRONT: center click changes game (no flip)
        if (mode === "allLines" && !flipped) {
          // center -> next matchup
          if (zone >= 0.2 && zone <= 0.8) {
            currentMatchupIndex = getNextIndex(currentSport().matchups.length, currentMatchupIndex);
            // remain not flipped
            renderScreen();
            return;
          }
        }

        // Edge navigation
        if (zone < 0.2) {
          if (mode === "sports") {
            currentSportIndex = getPrevIndex(SPORTS.length, currentSportIndex);
            flipped = false;
          } else if (mode === "matchups" || mode === "allLines") {
            currentMatchupIndex = getPrevIndex(currentSport().matchups.length, currentMatchupIndex);
            // keep flipped state for matchups/allLines? requirement: keep flipped until double click flips back
            // We'll not force flipped=false here.
          }
          renderScreen();
          return;
        }

        if (zone > 0.8) {
          if (mode === "sports") {
            currentSportIndex = getNextIndex(SPORTS.length, currentSportIndex);
            flipped = false;
          } else if (mode === "matchups" || mode === "allLines") {
            currentMatchupIndex = getNextIndex(currentSport().matchups.length, currentMatchupIndex);
          }
          renderScreen();
          return;
        }

        // Center click
        if (mode === "lineDetails") {
          handleGlobalBack();
          return;
        }

        // For allLines, we do NOT flip on single click (only double click)
        if (mode === "allLines") return;

        // For other modes, center click toggles flip
        flipped = !flipped;
        renderCardFlipState();
      }

      function handleDoubleClick(e) {
        const zone = zoneFromEvent(e);

        if (mode === "lineDetails") {
          handleGlobalBack();
          return;
        }

        // Sports: double-click center => open matchups
        if (mode === "sports" && zone >= 0.2 && zone <= 0.8) {
          mode = "matchups";
          currentMatchupIndex = 0;
          flipped = false;
          renderScreen();
          return;
        }

        // Matchups: double-click center => open allLines
        if (mode === "matchups" && zone >= 0.2 && zone <= 0.8) {
          mode = "allLines";
          flipped = false; // important: start front. double-click again to view lines
          renderScreen();
          return;
        }

        // AllLines: double-click center toggles flip (show/hide lines)
        if (mode === "allLines" && zone >= 0.2 && zone <= 0.8) {
          flipped = !flipped;
          renderCardFlipState();
          return;
        }

        // Default fallback
        handleSingleClick(e);
      }

      cardClickArea.addEventListener("click", (e) => {
        if (clickTimeout) {
          clearTimeout(clickTimeout);
          clickTimeout = null;
          handleDoubleClick(e);
        } else {
          clickTimeout = setTimeout(() => {
            handleSingleClick(e);
            clickTimeout = null;
          }, DOUBLE_CLICK_DELAY);
        }
      });

      /*************************************************************
       * 12) MENUS
       *************************************************************/
      function buildSportsMenu() {
        sportsMenuEl.innerHTML = "";
        SPORTS.forEach((sport, sIndex) => {
          const sportItem = document.createElement("div");
          sportItem.className = "sports-menu-item";

          const title = document.createElement("div");
          title.className = "sports-menu-item-title";
          title.textContent = sport.name;
          sportItem.appendChild(title);

          const gamesSub = document.createElement("div");
          gamesSub.className = "sports-games-submenu";

          sport.matchups.forEach((matchup, mIndex) => {
            const gameItem = document.createElement("div");
            gameItem.className = "game-item";
            gameItem.textContent = matchup.name;
            gameItem.addEventListener("click", (e) => {
              e.stopPropagation();
              currentSportIndex = sIndex;
              currentMatchupIndex = mIndex;
              mode = "allLines";
              flipped = false; // start front, per requirement
              sportsMenuEl.classList.remove("open");
              renderScreen();
            });
            gamesSub.appendChild(gameItem);
          });

          sportItem.appendChild(gamesSub);
          sportsMenuEl.appendChild(sportItem);
        });
      }

      appLogoButton.addEventListener("click", (e) => {
        e.stopPropagation();
        const isOpen = sportsMenuEl.classList.contains("open");
        sportsMenuEl.classList.toggle("open", !isOpen);
      });

      function updateUserMenuLabel() {
        userMenuLabel.textContent = "Hub";
      }

      function buildUserDropdown() {
        userDropdown.innerHTML = "";

        const myBias = document.createElement("div");
        myBias.className = "user-dropdown-item";
        myBias.textContent = "MyBias";
        myBias.addEventListener("click", () => {
          mode = "mybias";
          flipped = true;
          userDropdown.classList.remove("open");
          renderScreen();
        });
        userDropdown.appendChild(myBias);

        const myLocks = document.createElement("div");
        myLocks.className = "user-dropdown-item";
        myLocks.textContent = "MyLocks";
        myLocks.addEventListener("click", () => {
          mode = "mylocks";
          flipped = true;
          userDropdown.classList.remove("open");
          renderScreen();
        });
        userDropdown.appendChild(myLocks);

        const myArchives = document.createElement("div");
        myArchives.className = "user-dropdown-item";
        myArchives.textContent = "MyArchives";
        myArchives.addEventListener("click", () => {
          mode = "myarchives";
          flipped = true;
          userDropdown.classList.remove("open");
          renderScreen();
        });
        userDropdown.appendChild(myArchives);

        const sep = document.createElement("div");
        sep.className = "user-dropdown-separator";
        userDropdown.appendChild(sep);

        const themeItem = document.createElement("div");
        themeItem.className = "user-dropdown-item";
        themeItem.textContent = getTheme() === "dark" ? "Switch to Light Mode" : "Switch to Dark Mode";
        themeItem.addEventListener("click", () => {
          const next = getTheme() === "dark" ? "light" : "dark";
          setTheme(next);
          persistEverythingFallback();
          buildUserDropdown();
        });
        userDropdown.appendChild(themeItem);

        const sep2 = document.createElement("div");
        sep2.className = "user-dropdown-separator";
        userDropdown.appendChild(sep2);

        const signout = document.createElement("div");
        signout.className = "user-dropdown-item";
        signout.textContent = "Sign out";
        signout.addEventListener("click", async () => {
          userDropdown.classList.remove("open");
          await window.supabase.auth.signOut();
          currentUser = null;
          itemStore = {};
          userSwipeCount = 0;
          authOverlay.style.display = "flex";
          showToast("Signed out");
        });
        userDropdown.appendChild(signout);
      }

      userMenuButton.addEventListener("click", (e) => {
        e.stopPropagation();
        const isOpen = userDropdown.classList.contains("open");
        userDropdown.classList.toggle("open", !isOpen);
      });

      // Close menus on outside click
      document.addEventListener("click", (e) => {
        const target = e.target;
        const clickedUserMenu = userMenuWrapper.contains(target);
        const clickedLogoMenu = logoGroup.contains(target);
        if (!clickedLogoMenu) sportsMenuEl.classList.remove("open");
        if (!clickedUserMenu) userDropdown.classList.remove("open");
      });

      /*************************************************************
       * 13) AUTH: REQUIRED LOGIN
       *************************************************************/
      async function refreshAuthUI() {
        const { data } = await window.supabase.auth.getSession();
        const sess = data?.session;
        if (sess?.user) {
          currentUser = sess.user;

          // Theme default is light; if stored locally, restore
          loadLocalFallback();

          // Load from DB if possible, else keep local fallback
          const ok = await dbLoadAll();
          if (!ok) loadLocalFallback();

          authOverlay.style.display = "none";
          buildUserDropdown();
          renderScreen();
          return true;
        }

        currentUser = null;
        authOverlay.style.display = "flex";
        return false;
      }

      async function handleSignIn() {
        const email = (authEmailInput.value || "").trim();
        const password = authPasswordInput.value || "";
        if (!email || !password) {
          authNoteEl.textContent = "Enter email and password.";
          return;
        }

        authNoteEl.textContent = "Signing in‚Ä¶";
        const res = await window.supabase.auth.signInWithPassword({ email, password });
        if (res.error) {
          authNoteEl.textContent = res.error.message;
          return;
        }
        authNoteEl.textContent = "Signed in.";
        await refreshAuthUI();
      }

      async function handleSignUp() {
        const email = (authEmailInput.value || "").trim();
        const password = authPasswordInput.value || "";
        if (!email || !password) {
          authNoteEl.textContent = "Enter email and password.";
          return;
        }

        authNoteEl.textContent = "Creating account‚Ä¶";
        const res = await window.supabase.auth.signUp({ email, password });

        if (res.error) {
          authNoteEl.textContent = res.error.message;
          return;
        }

        // If email confirmations are ON, user must confirm
        authNoteEl.textContent =
          "Account created. If confirmation is enabled, check your email, confirm, then Sign In.";
      }

      authSignInBtn.addEventListener("click", handleSignIn);
      authSignUpBtn.addEventListener("click", handleSignUp);

      // If already logged in, hide overlay on load
      window.supabase.auth.onAuthStateChange(() => refreshAuthUI());

      /*************************************************************
       * 14) INIT
       *************************************************************/
      // default theme = light (already). persist any stored theme after login.
      setTheme("light");

      buildSportsMenu();
      updateUserMenuLabel();
      buildUserDropdown();
      renderScreen();

      // force auth check on load (no swiping until logged in)
      refreshAuthUI();
    </script>
  </body>
</html>
