<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>BeforeTheBet ‚Äì Demo MVP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      :root {
        color-scheme: dark;
        --bg: #020617;
        --card: #020617;
        --border: #1e293b;
        --text: #e2e8f0;
        --muted: #64748b;
        --green: #22c55e;
        --blue: #3b82f6;
        --red: #ef4444;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #0f172a 0, #020617 55%);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* App shell */
      .app-shell {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header,
      footer {
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        border-bottom: 1px solid var(--border);
        backdrop-filter: blur(10px);
        background: linear-gradient(
          to bottom,
          rgba(15, 23, 42, 0.9),
          rgba(15, 23, 42, 0.4)
        );
        z-index: 10;
      }

      footer {
        border-top: 1px solid var(--border);
        border-bottom: none;
        background: linear-gradient(
          to top,
          rgba(15, 23, 42, 0.9),
          rgba(15, 23, 42, 0.4)
        );
        justify-content: center;
        font-size: 11px;
        color: var(--muted);
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .logo-group {
        position: relative;
        display: flex;
        align-items: center;
      }

      .logo-button {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: transparent;
        cursor: pointer;
      }

      .logo-button:hover {
        border-color: #1f2937;
        background: rgba(15, 23, 42, 0.85);
      }

      .logo {
        font-size: 12px;
        font-weight: 600;
        letter-spacing: 0.22em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .logo-caret {
        font-size: 10px;
        color: var(--muted);
      }

      .sports-menu {
        position: absolute;
        top: 110%;
        left: 0;
        background: #020617;
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.8);
        padding: 8px 0;
        min-width: 240px;
        display: none;
        z-index: 60;
      }

      .sports-menu.open {
        display: block;
      }

      .sports-menu-item {
        padding: 6px 12px;
        font-size: 12px;
        color: #e5e7eb;
        cursor: default;
        position: relative;
      }

      .sports-menu-item:hover {
        background: #0f172a;
      }

      .sports-menu-item-title {
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-size: 11px;
        color: #cbd5e1;
        margin-bottom: 6px;
      }

      .sports-games-submenu {
        margin-top: 4px;
        margin-left: 4px;
        padding-left: 8px;
        border-left: 1px solid #1f2937;
      }

      .game-item {
        font-size: 11px;
        color: var(--muted);
        padding: 4px 0;
        cursor: pointer;
      }

      .game-item:hover {
        color: #e5e7eb;
      }

      #back-to-sports {
        display: none;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.95);
        color: var(--muted);
        font-size: 11px;
        padding: 4px 10px;
        cursor: pointer;
      }

      #back-to-sports:hover {
        border-color: #334155;
        color: #e5e7eb;
      }

      /* User menu */
      .user-menu-wrapper {
        position: relative;
      }

      .menu-placeholder {
        font-size: 11px;
        color: var(--muted);
        cursor: pointer;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: transparent;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .menu-placeholder:hover {
        border-color: #1f2937;
        color: #e5e7eb;
        background: rgba(15, 23, 42, 0.8);
      }

      .user-dropdown {
        position: absolute;
        right: 0;
        top: 110%;
        background: #020617;
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.8);
        min-width: 190px;
        padding: 6px 0;
        display: none;
        z-index: 60;
      }

      .user-dropdown.open {
        display: block;
      }

      .user-dropdown-item {
        padding: 8px 12px;
        font-size: 12px;
        cursor: pointer;
        color: #e5e7eb;
      }

      .user-dropdown-item:hover {
        background: #0f172a;
      }

      .user-dropdown-separator {
        border-top: 1px solid #1f2937;
        margin: 4px 0;
      }

      /* Main content */
      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: center;
        padding: 24px 16px;
      }

      .content {
        max-width: 960px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 24px;
        align-items: stretch;
      }

      .title-block {
        text-align: center;
      }

      .title-block h1 {
        font-size: 28px;
        margin: 0 0 8px;
      }

      .title-block p {
        margin: 0;
        font-size: 14px;
        color: var(--muted);
      }

      .title-block .directions {
        margin-top: 6px;
        font-size: 12px;
        color: var(--muted);
        line-height: 1.35;
      }

      @media (min-width: 768px) {
        .title-block h1 {
          font-size: 32px;
        }
        .title-block .directions {
          font-size: 13px;
        }
      }

      /* Card stack */
      .card-container {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .card-click-area {
        position: relative;
        width: 100%;
        max-width: 380px;
        aspect-ratio: 2.5 / 3.5;
        perspective: 1200px;
        cursor: pointer;
      }

      @media (min-width: 1024px) {
        .card-click-area {
          max-width: 420px;
        }
      }

      .card,
      .stack-card {
        position: absolute;
        inset: 0;
        border-radius: 24px;
        border: 1px solid var(--border);
        background: radial-gradient(circle at top, #020617, #020617);
        box-shadow: 0 22px 40px rgba(0, 0, 0, 0.6);
        overflow: hidden;
      }

      .card-main {
        transform-style: preserve-3d;
        transition: transform 0.5s ease;
        z-index: 3;
      }

      .stack-card {
        pointer-events: none;
        opacity: 0.55;
        z-index: 0;
      }

      .stack-card.stack-1 {
        transform: translateY(10px) translateX(6px) scale(0.97);
      }

      .stack-card.stack-2 {
        transform: translateY(18px) translateX(10px) scale(0.94);
        opacity: 0.4;
      }

      .stack-card.stack-3 {
        transform: translateY(26px) translateX(14px) scale(0.9);
        opacity: 0.25;
      }

      .card-face {
        position: absolute;
        inset: 0;
        padding: 18px 16px 14px;
        display: flex;
        flex-direction: column;
        backface-visibility: hidden;
      }

      .card-front {
        align-items: center;
        text-align: center;
        justify-content: center;
        gap: 12px;
        transform: rotateY(0deg);
        transition: transform 0.5s ease;
      }

      .card-back {
        transform: rotateY(180deg);
        justify-content: flex-start;
        transition: transform 0.5s ease;
      }

      .card-main.flipped .card-front {
        transform: rotateY(-180deg);
      }

      .card-main.flipped .card-back {
        transform: rotateY(0deg);
      }

      /* Logo + labels */
      .sport-logo-circle {
        width: 120px;
        height: 120px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 42px;
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.6);
      }

      .sport-logo-nba {
        background: radial-gradient(circle at top left, #38bdf8, #0ea5e9);
      }
      .sport-logo-nfl {
        background: radial-gradient(circle at top left, #4ade80, #22c55e);
      }

      .sport-front-name {
        font-size: 18px;
        font-weight: 600;
        margin-top: 10px;
      }

      .sport-front-code {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        color: var(--muted);
        margin-top: 4px;
      }

      .tap-hint {
        position: absolute;
        bottom: 10px;
        right: 14px;
        font-size: 10px;
        color: #6b7280;
        pointer-events: none;
      }

      .index-indicator {
        position: absolute;
        bottom: 10px;
        left: 14px;
        font-size: 10px;
        color: #6b7280;
      }

      /* Back content */
      .back-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 8px;
        margin-bottom: 8px;
      }

      .back-title {
        font-size: 16px;
        font-weight: 700;
      }

      .back-sub {
        font-size: 11px;
        color: var(--muted);
        text-align: right;
      }

      .matchups-list {
        margin-top: 6px;
        flex: 1;
        overflow-y: auto;
        padding-right: 4px;
      }

      .matchup-card {
        border-radius: 18px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.98);
        padding: 10px 10px 8px;
        margin-bottom: 8px;
        position: relative;
        transition: transform 0.2s ease, opacity 0.2s ease;
      }

      .matchup-card.swipe-right {
        transform: translateX(40px);
        opacity: 0;
      }

      .matchup-card.swipe-left {
        transform: translateX(-40px);
        opacity: 0;
      }

      .matchup-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 6px;
        margin-bottom: 6px;
      }

      .matchup-label {
        font-size: 13px;
        font-weight: 600;
        color: #e5e7eb;
      }

      .matchup-line {
        font-size: 11px;
        color: var(--muted);
        line-height: 1.35;
      }

      .matchup-tag {
        font-size: 11px;
        color: var(--muted);
        text-align: right;
        white-space: nowrap;
      }

      /* SideBias bar */
      .sentiment-bar-container {
        margin-top: 6px;
      }

      .sentiment-bar-bg {
        height: 9px;
        border-radius: 999px;
        background: #020617;
        overflow: hidden;
        border: 1px solid #111827;
      }

      .sentiment-bar-fill {
        height: 100%;
        border-radius: 999px;
        transition: width 0.25s ease, background 0.25s ease;
      }

      .sentiment-labels {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        margin-top: 3px;
      }

      .sentiment-labels span:first-child {
        font-weight: 600;
      }
      .sentiment-labels span:last-child {
        font-weight: 600;
      }

      .category-header {
        margin: 10px 2px 6px;
        font-size: 11px;
        color: #9ca3af;
        text-transform: uppercase;
        letter-spacing: 0.16em;
      }

      /* toast */
      .swipe-toast {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: rgba(15, 23, 42, 0.96);
        border-radius: 999px;
        border: 1px solid #1f2937;
        padding: 8px 14px;
        font-size: 12px;
        color: var(--text);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease, transform 0.2s ease;
        z-index: 70;
        white-space: nowrap;
      }

      .swipe-toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      /* line detail stats */
      .stat-row {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        font-size: 12px;
        margin-bottom: 4px;
      }

      .stat-row span:first-child {
        color: var(--muted);
      }

      .stat-row span:last-child {
        font-weight: 600;
      }

      .stat-highlight {
        font-size: 13px;
        font-weight: 800;
      }

      .stat-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid #1f2937;
        background: rgba(15, 23, 42, 0.95);
        font-size: 11px;
        margin-right: 6px;
        margin-top: 6px;
      }

      .stat-pill-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: var(--green);
      }

      .line-detail-note {
        font-size: 11px;
        color: var(--muted);
        margin-top: 6px;
        line-height: 1.35;
      }

      /* CTA buttons */
      .sportsbook-cta-btn,
      .play-locks-cta {
        width: 100%;
        margin-top: 8px;
        padding: 8px 10px;
        border-radius: 999px;
        border: none;
        font-size: 12px;
        font-weight: 800;
        cursor: pointer;
      }

      .sportsbook-cta-btn {
        background: var(--green);
        color: #020617;
      }

      .play-locks-cta {
        background: var(--blue);
        color: #e5e7eb;
      }

      /* AUTH overlay (single, guaranteed) */
      #auth-overlay {
        position: fixed;
        inset: 0;
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(
          circle at top,
          rgba(15, 23, 42, 0.92),
          rgba(2, 6, 23, 0.985)
        );
      }

      #auth-overlay.is-hidden {
        display: none !important;
        visibility: hidden !important;
        pointer-events: none !important;
      }

      .auth-card {
        width: calc(100% - 32px);
        max-width: 380px;
        background: #020617;
        border-radius: 24px;
        border: 1px solid var(--border);
        padding: 18px 16px 14px;
        box-shadow: 0 26px 60px rgba(0, 0, 0, 0.85);
      }

      .auth-title {
        font-size: 18px;
        font-weight: 900;
        margin: 0 0 6px;
        letter-spacing: 0.06em;
        text-transform: uppercase;
      }

      .auth-subtitle {
        font-size: 13px;
        color: var(--muted);
        margin: 0 0 14px;
        line-height: 1.35;
      }

      .auth-field {
        margin-bottom: 10px;
      }

      .auth-field label {
        display: block;
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 4px;
      }

      .auth-field input {
        width: 100%;
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid #1f2937;
        background: #020617;
        color: var(--text);
        font-size: 12px;
        outline: none;
      }

      .auth-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
      }

      .auth-secondary,
      .auth-primary {
        flex: 1;
        padding: 9px 10px;
        border-radius: 999px;
        border: none;
        font-size: 12px;
        cursor: pointer;
        font-weight: 900;
      }

      .auth-primary {
        background: var(--green);
        color: #020617;
      }

      .auth-secondary {
        background: transparent;
        border: 1px solid #1f2937;
        color: var(--muted);
      }

      .auth-note {
        margin-top: 10px;
        font-size: 10px;
        color: var(--muted);
        line-height: 1.4;
      }

      .auth-row {
        display: flex;
        gap: 8px;
      }

      @media (max-width: 480px) {
        .card-click-area {
          max-width: 340px;
        }
        .sport-logo-circle {
          width: 104px;
          height: 104px;
          font-size: 36px;
        }
        .swipe-toast {
          font-size: 11px;
          max-width: 90%;
          white-space: normal;
          text-align: center;
        }
      }
    </style>
  </head>

  <body>
    <div class="app-shell" id="app-shell">
      <header>
        <div class="header-left">
          <div class="logo-group" id="logo-group">
            <button id="app-logo-button" class="logo-button" type="button">
              <span class="logo">BEFORETHEBET</span>
              <span class="logo-caret">‚ñæ</span>
            </button>
            <div id="sports-menu" class="sports-menu"></div>
          </div>
          <button id="back-to-sports" type="button">‚Üê Back</button>
        </div>

        <div class="user-menu-wrapper" id="user-menu-wrapper">
          <button class="menu-placeholder" id="user-menu-button" type="button">
            <span id="user-menu-label">SideBias</span>
            <span>‚ñæ</span>
          </button>
          <div class="user-dropdown" id="user-dropdown"></div>
        </div>
      </header>

      <main>
        <div class="content">
          <div class="title-block">
            <h1 id="main-title">Select Your Sport</h1>
            <p id="subtitle">Swipe the edges. Tap the center to flip.</p>
            <div class="directions" id="directions">
              Tap the <strong>center</strong> of a card to flip and see this
              week‚Äôs matchups. Tap the <strong>right edge</strong> for
              <strong>Confident</strong> (next), and the
              <strong>left edge</strong> for <strong>Doubt it</strong>
              (previous). Double-tap center to open the sport. Tap the
              <strong>bottom-left corner</strong> of the screen to go back.
            </div>
          </div>

          <div class="card-container">
            <div class="card-click-area" id="card-click-area">
              <div class="stack-card stack-3"></div>
              <div class="stack-card stack-2"></div>
              <div class="stack-card stack-1"></div>

              <div class="card card-main" id="sport-card">
                <!-- FRONT -->
                <div class="card-face card-front" id="card-front">
                  <div class="sport-logo-circle" id="sport-logo"></div>
                  <div class="sport-front-name" id="sport-name"></div>
                  <div class="sport-front-code" id="sport-code"></div>
                  <div class="tap-hint" id="tap-hint-front">
                    Tap center to flip ‚Üª
                  </div>
                  <div class="index-indicator" id="index-indicator"></div>
                </div>

                <!-- BACK -->
                <div class="card-face card-back" id="card-back">
                  <div class="back-header">
                    <div class="back-title" id="back-title"></div>
                    <div class="back-sub" id="back-sub"></div>
                  </div>

                  <div class="matchups-list" id="matchups-list"></div>

                  <div class="tap-hint" id="tap-hint-back">
                    Tap center to flip ‚Ü∫
                  </div>
                  <div class="index-indicator" id="index-indicator-back"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <footer>BeforeTheBet ‚Ä¢ Demo MVP</footer>
    </div>

    <!-- AUTH OVERLAY (single + correct) -->
    <div id="auth-overlay">
      <div class="auth-card">
        <div class="auth-title">BeforeTheBet</div>
        <div class="auth-subtitle">
          Sign in to sync SideBias later. For now, you can also skip.
        </div>

        <div class="auth-field">
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="you@email.com" />
        </div>

        <div class="auth-field">
          <label for="password">Password</label>
          <input id="password" type="password" placeholder="Password" />
        </div>

        <div class="auth-actions">
          <button class="auth-secondary" id="auth-skip" type="button">
            Skip
          </button>
          <button class="auth-primary" id="signInBtn" type="button">
            Sign In
          </button>
        </div>

        <div class="auth-actions" style="margin-top: 8px">
          <button class="auth-secondary" id="signUpBtn" type="button">
            Create Account
          </button>
          <button class="auth-primary" id="auth-continue" type="button">
            Continue
          </button>
        </div>

        <div class="auth-note">
          Demo only. Real 2-step phone auth can be added next (Supabase OTP).
        </div>
      </div>
    </div>

    <div class="swipe-toast" id="swipe-toast"></div>

    <!-- SUPABASE (single, reliable CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      /************************************************************
       * BEFORETHEBET ‚Äî SINGLE SCRIPT, NO DUPES, NO NESTED SCRIPTS
       ************************************************************/

      /***************
       * CONFIG
       ***************/
      const APP_NAME = "BeforeTheBet";

      // SUPABASE CONFIG (from your earlier setup)
      const SUPABASE_URL = "https://kmgrpyvcxonfjswxusbt.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttZ3JweXZjeG9uZmpzd3h1c2J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NjE4NTIsImV4cCI6MjA4MTIzNzg1Mn0.teDypPoT-TMPkIDGemYVRfCNdmK0uAbOCDaiHfNmgac";

      // Optional NFL live odds (SportsDataIO). Leave as-is if you're using it.
      const NFL_API_KEY = "05e71f5146e8488d9ff3c537b89f4ffc";

      /***************
       * UI Helpers
       ***************/
      const $ = (sel) => document.querySelector(sel);

      function safeText(el, txt) {
        if (!el) return;
        el.textContent = txt;
      }

      function showToast(message) {
        const el = $("#swipe-toast");
        if (!el) return;
        el.textContent = message;
        el.classList.add("show");
        clearTimeout(el._t);
        el._t = setTimeout(() => el.classList.remove("show"), 1100);
      }

      function hardHideAuthOverlay() {
        const overlay = $("#auth-overlay");
        if (overlay) overlay.classList.add("is-hidden");
      }

      function showAuthOverlay() {
        const overlay = $("#auth-overlay");
        if (overlay) overlay.classList.remove("is-hidden");
      }

      /***************
       * Supabase init
       ***************/
      let supabaseClient = null;

      function initSupabase() {
        try {
          if (!window.supabase || !window.supabase.createClient) {
            console.warn("Supabase CDN not ready.");
            return null;
          }
          const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: { persistSession: true, autoRefreshToken: true },
          });
          console.log("SUPABASE READY:", !!client);
          return client;
        } catch (e) {
          console.error("Supabase init failed:", e);
          return null;
        }
      }

      /***************
       * Data + Modes
       ***************/
      const CATEGORY_LABELS = {
        spread: "Spreads",
        total: "Over / Unders",
        points: "Points",
        props: "Props",
        alt: "Alternate Lines",
        moneyline: "Moneyline",
        other: "Other",
      };

      const CATEGORY_ORDER = ["spread", "total", "moneyline", "points", "props", "alt", "other"];

      const BOOKS = ["FanDuel", "DraftKings", "BetMGM", "Caesars", "ESPN BET", "PointsBet"];

      // SPORTS ‚Äî removed MLB (baseball) completely
      const SPORTS = [
        {
          id: "nfl",
          name: "NFL",
          code: "National Football League",
          logoClass: "sport-logo-nfl",
          emoji: "üèà",
          matchups: [
            {
              name: "Chiefs @ Bills",
              lines: [
                { label: "Mahomes o1.5 Passing TDs", category: "props", book: "FanDuel" },
                { label: "Allen o36.5 Rush Yards", category: "props", book: "BetMGM" },
                { label: "Kelce o6.5 Receptions", category: "props", book: "Caesars" },
                { label: "Total 51.5", category: "total", book: "ESPN BET" },
                { label: "Chiefs -2.5", category: "spread", book: "PointsBet" },
              ],
            },
            {
              name: "Eagles @ Cowboys",
              lines: [
                { label: "Hurts o44.5 Rush Yards", category: "props", book: "FanDuel" },
                { label: "Lamb o7.5 Targets", category: "props", book: "DraftKings" },
                { label: "Eagles +3.5", category: "spread", book: "BetMGM" },
                { label: "Total 48.5", category: "total", book: "Caesars" },
              ],
            },
          ],
        },
        {
          id: "nba",
          name: "NBA",
          code: "National Basketball Association",
          logoClass: "sport-logo-nba",
          emoji: "üèÄ",
          matchups: [
            {
              name: "Lakers @ Warriors",
              lines: [
                { label: "LeBron o26.5 Points", category: "points", book: "FanDuel" },
                { label: "Curry o4.5 3PM", category: "points", book: "DraftKings" },
                { label: "Reaves o3.5 Assists", category: "props", book: "BetMGM" },
                { label: "Total 236.5", category: "total", book: "Caesars" },
                { label: "Warriors -3.5", category: "spread", book: "ESPN BET" },
              ],
            },
            {
              name: "Celtics @ Knicks",
              lines: [
                { label: "Tatum o3.5 3PM", category: "points", book: "FanDuel" },
                { label: "Brunson o24.5 Pts", category: "points", book: "DraftKings" },
                { label: "Randle o9.5 Reb", category: "props", book: "BetMGM" },
                { label: "Total 224.5", category: "total", book: "Caesars" },
                { label: "Celtics -4.5", category: "spread", book: "ESPN BET" },
              ],
            },
          ],
        },
      ];

      let mode = "sports"; // sports | matchups | allLines | lineDetails | sidebias | locks | archive
      let currentSportIndex = 0;
      let currentMatchupIndex = 0;
      let flipped = false;

      let previousModeBeforeLineDetails = null;
      let currentLineDetailMeta = null;
      let currentLineDetailStats = null;

      const DOUBLE_CLICK_DELAY = 250;
      let clickTimeout = null;
      let visibleLinesCount = 0;

      /************************************************************
       * SideBias store (local prototype)
       * - starts 50/50 (blue)
       * - turns green after at least 1 swipe recorded on that line
       ************************************************************/
      const sideBiasStore = {}; // key -> { confidentCount, doubtCount, lastUpdated, crowdSize, status, book, ... }
      function sideBiasKey(meta) {
        const sport = SPORTS[meta.sportIndex];
        const matchup = sport.matchups[meta.matchupIndex];
        const book = meta.book || "Best Available";
        return `${sport.id}|${matchup.name}|${meta.label}|${book}`;
      }

      function hashCrowdSize(key) {
        let hash = 0;
        for (let i = 0; i < key.length; i++) hash = (hash * 31 + key.charCodeAt(i)) % 100000;
        return 80 + (hash % 520);
      }

      function ensureSideBiasItem(meta) {
        const sport = SPORTS[meta.sportIndex];
        const matchup = sport.matchups[meta.matchupIndex];
        const book = meta.book || "Best Available";
        const key = sideBiasKey(meta);

        if (!sideBiasStore[key]) {
          sideBiasStore[key] = {
            key,
            sportId: sport.id,
            sportName: sport.name,
            sportIndex: meta.sportIndex,
            matchupIndex: meta.matchupIndex,
            matchupName: matchup.name,
            lineLabel: meta.label,
            category: meta.category || "other",
            book,
            confidentCount: 0,
            doubtCount: 0,
            lastUpdated: Date.now(),
            crowdSize: hashCrowdSize(key),
            status: "inbox", // inbox | lock | archived
          };
        }
        return sideBiasStore[key];
      }

      function computeSideBiasPercent(item) {
        const total = item.confidentCount + item.doubtCount;
        if (total <= 0) return 50;
        return Math.round((item.confidentCount / total) * 100);
      }

      function hasAnySwipe(item) {
        return (item.confidentCount + item.doubtCount) > 0;
      }

      function recordSideBias(meta, vote, context) {
        const item = ensureSideBiasItem(meta);
        if (vote === "confident") item.confidentCount += 1;
        else item.doubtCount += 1;
        item.lastUpdated = Date.now();

        if (context === "sidebiasInbox") {
          item.status = vote === "confident" ? "lock" : "archived";
        }

        const label = meta.label.length > 42 ? meta.label.slice(0, 39).trim() + "..." : meta.label;
        showToast((vote === "confident" ? "‚úÖ Confident" : "ü§î Doubt it") + " ‚Äî " + label);
      }

      function getInboxItems() {
        return Object.values(sideBiasStore).filter((x) => x.status === "inbox");
      }
      function getLockItems() {
        return Object.values(sideBiasStore).filter((x) => x.status === "lock");
      }
      function getArchiveItems() {
        return Object.values(sideBiasStore).filter((x) => x.status === "archived");
      }

      /***************
       * DOM refs
       ***************/
      const cardEl = $("#sport-card");
      const cardClickArea = $("#card-click-area");

      const logoEl = $("#sport-logo");
      const nameEl = $("#sport-name");
      const codeEl = $("#sport-code");
      const tapHintFrontEl = $("#tap-hint-front");
      const tapHintBackEl = $("#tap-hint-back");

      const indexIndicatorFront = $("#index-indicator");
      const indexIndicatorBack = $("#index-indicator-back");

      const backTitleEl = $("#back-title");
      const backSubEl = $("#back-sub");
      const matchupsListEl = $("#matchups-list");

      const titleEl = $("#main-title");
      const subtitleEl = $("#subtitle");
      const directionsEl = $("#directions");
      const backToSportsBtn = $("#back-to-sports");

      const sportsMenuEl = $("#sports-menu");
      const appLogoButton = $("#app-logo-button");
      const logoGroup = $("#logo-group");

      const userMenuButton = $("#user-menu-button");
      const userMenuLabel = $("#user-menu-label");
      const userDropdown = $("#user-dropdown");
      const userMenuWrapper = $("#user-menu-wrapper");

      /***************
       * Auth refs
       ***************/
      const authOverlay = $("#auth-overlay");
      const authSkipBtn = $("#auth-skip");
      const authContinueBtn = $("#auth-continue");
      const signInBtn = $("#signInBtn");
      const signUpBtn = $("#signUpBtn");

      let currentUser = null; // supabase user if signed in

      /***************
       * Navigation helpers
       ***************/
      function getNextIndex(length, current) {
        return (current + 1) % length;
      }

      function getPrevIndex(length, current) {
        return current === 0 ? length - 1 : current - 1;
      }

      function currentSport() {
        return SPORTS[currentSportIndex];
      }

      function currentMatchup() {
        return currentSport().matchups[currentMatchupIndex];
      }

      /***************
       * Card flip state
       ***************/
      function renderCardFlipState() {
        if (!cardEl) return;
        if (flipped) cardEl.classList.add("flipped");
        else cardEl.classList.remove("flipped");
      }

      /************************************************************
       * SideBias bar renderer (blue 50/50 -> green after swipes)
       ************************************************************/
      function renderSideBiasBar(container, meta) {
        const item = ensureSideBiasItem(meta);
        const pct = computeSideBiasPercent(item); // percent confident
        const total = item.confidentCount + item.doubtCount;

        const barBg = document.createElement("div");
        barBg.className = "sentiment-bar-bg";

        const barFill = document.createElement("div");
        barFill.className = "sentiment-bar-fill";
        barFill.style.width = pct + "%";

        // BLUE if no swipes; GREEN if at least 1 swipe exists
        if (hasAnySwipe(item)) {
          barFill.style.background = `linear-gradient(90deg, var(--green), #16a34a)`;
        } else {
          barFill.style.background = `linear-gradient(90deg, var(--blue), #1d4ed8)`;
        }

        barBg.appendChild(barFill);

        const labels = document.createElement("div");
        labels.className = "sentiment-labels";

        const leftLabel = document.createElement("span");
        const rightLabel = document.createElement("span");

        // "Confident" / "Doubt it"
        leftLabel.textContent = `Confident ${pct}%`;
        rightLabel.textContent = `Doubt it ${100 - pct}%`;

        // Color labels to match state
        if (hasAnySwipe(item)) {
          leftLabel.style.color = "#bbf7d0";
          rightLabel.style.color = "#fecaca";
        } else {
          leftLabel.style.color = "#bfdbfe";
          rightLabel.style.color = "#bfdbfe";
        }

        labels.appendChild(leftLabel);
        labels.appendChild(rightLabel);

        container.appendChild(barBg);
        container.appendChild(labels);

        // Extra tiny line (optional)
        const metaRow = document.createElement("div");
        metaRow.className = "matchup-line";
        metaRow.style.marginTop = "4px";
        metaRow.textContent =
          total > 0
            ? `SideBias votes: ${total} (You‚Äôre prototyping local-only)`
            : `SideBias starts at 50/50 until swipes come in`;
        container.appendChild(metaRow);
      }

      /***************
       * Line stats (simple placeholder)
       ***************/
      function parseLineNumeric(label) {
        const ou = label.match(/[ou](\d+\.?\d*)/i);
        if (ou) return parseFloat(ou[1]);
        const plain = label.match(/(\d+\.?\d*)/);
        if (plain) return parseFloat(plain[1]);
        return null;
      }

      function generateLineStats(meta) {
        const sport = SPORTS[meta.sportIndex];
        const matchup = sport.matchups[meta.matchupIndex];
        const label = meta.label;

        const lv = parseLineNumeric(label) ?? 10;
        const seasonAvg = +(lv + 0.4).toFixed(1);
        const last10Avg = +(lv + 0.2).toFixed(1);
        const homeAvg = +(lv + 0.5).toFixed(1);
        const roadAvg = +(lv + 0.1).toFixed(1);

        const item = ensureSideBiasItem(meta);
        const pct = computeSideBiasPercent(item);

        return {
          sportName: sport.name,
          matchupName: matchup.name,
          label,
          lineValue: lv,
          seasonAvg,
          last10Avg,
          homeAvg,
          roadAvg,
          sideBias: {
            confidentPct: pct,
            doubtPct: 100 - pct,
            totalVotes: item.confidentCount + item.doubtCount,
          },
        };
      }

      function openLineDetails(meta) {
        if (!meta) return;
        previousModeBeforeLineDetails = mode === "lineDetails" ? previousModeBeforeLineDetails : mode;
        currentLineDetailMeta = meta;
        currentLineDetailStats = generateLineStats(meta);
        mode = "lineDetails";
        flipped = true;
        renderScreen();
      }

      /***************
       * Swipe attach
       ***************/
      function attachSwipeToLineCard(card, meta, context) {
        let startX = null;
        let isPointerDown = false;

        card.addEventListener("click", (e) => e.stopPropagation());

        card.addEventListener("dblclick", (e) => {
          e.stopPropagation();
          openLineDetails(meta);
        });

        card.addEventListener("pointerdown", (e) => {
          isPointerDown = true;
          startX = e.clientX;
        });

        card.addEventListener("pointerup", (e) => {
          if (!isPointerDown) return;
          isPointerDown = false;

          const dx = e.clientX - startX;
          const threshold = 40;
          if (Math.abs(dx) < threshold) return;

          e.stopPropagation();

          const direction = dx > 0 ? "right" : "left";
          const vote = direction === "right" ? "confident" : "doubt";

          // Record SideBias always
          recordSideBias(meta, vote, context);

          // In SideBias inbox, swiping promotes or archives but stays in SideBias
          if (context === "sidebiasInbox") {
            const inboxLeft = getInboxItems().length;
            const locksCount = getLockItems().length;
            if (inboxLeft === 0 && locksCount > 0) {
              mode = "locks";
              flipped = true;
            }
            renderScreen();
            return;
          }

          card.classList.add(direction === "right" ? "swipe-right" : "swipe-left");

          setTimeout(() => {
            if (card.parentNode) card.parentNode.removeChild(card);

            if (context === "matchupsTop") {
              visibleLinesCount -= 1;
              if (visibleLinesCount <= 0) {
                const sport = currentSport();
                if (currentMatchupIndex < sport.matchups.length - 1) {
                  currentMatchupIndex += 1;
                  flipped = true;
                  renderScreen();
                } else {
                  mode = "sports";
                  flipped = false;
                  renderScreen();
                  showToast("‚úÖ Completed this sport (demo)");
                }
              }
            }
          }, 180);
        });

        card.addEventListener("pointercancel", () => {
          isPointerDown = false;
        });
      }

      /***************
       * Renderers
       ***************/
      function renderSportsFront() {
        const sport = currentSport();
        logoEl.className = "sport-logo-circle " + sport.logoClass;
        logoEl.textContent = sport.emoji;
        nameEl.textContent = sport.name;
        codeEl.textContent = sport.code;
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";
        const idx = `${currentSportIndex + 1} / ${SPORTS.length}`;
        indexIndicatorFront.textContent = idx;
        indexIndicatorBack.textContent = idx;
      }

      function renderSportsBack() {
        const sport = currentSport();
        backTitleEl.textContent = `${sport.name} ‚Äì This Week's Matchups`;
        backSubEl.textContent = "Preview matchups. Double-tap a matchup to open all lines.";
        matchupsListEl.innerHTML = "";

        sport.matchups.forEach((matchup, mIndex) => {
          const topLine = matchup.lines[0];
          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = matchup.name;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = topLine ? topLine.label : "Lines loading‚Ä¶";

          left.appendChild(label);
          left.appendChild(line);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = (topLine && topLine.book) || "Consensus";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);

          // SideBias bar uses key on the topLine (or placeholder)
          const meta = {
            sportIndex: currentSportIndex,
            matchupIndex: mIndex,
            label: topLine ? topLine.label : matchup.name,
            category: (topLine && topLine.category) || "other",
            book: (topLine && topLine.book) || "Best Available",
          };

          const sentimentContainer = document.createElement("div");
          sentimentContainer.className = "sentiment-bar-container";
          renderSideBiasBar(sentimentContainer, meta);

          card.appendChild(sentimentContainer);

          attachSwipeToLineCard(card, meta, "sportsPreview");

          card.addEventListener("dblclick", (e) => {
            e.stopPropagation();
            mode = "allLines";
            currentMatchupIndex = mIndex;
            flipped = true;
            renderScreen();
          });

          matchupsListEl.appendChild(card);
        });
      }

      function renderMatchupsFront() {
        const sport = currentSport();
        const matchup = currentMatchup();

        logoEl.className = "sport-logo-circle " + sport.logoClass;
        logoEl.textContent = sport.emoji;
        nameEl.textContent = matchup.name;
        codeEl.textContent = sport.name;
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";

        const idx = `${currentMatchupIndex + 1} / ${sport.matchups.length}`;
        indexIndicatorFront.textContent = idx;
        indexIndicatorBack.textContent = idx;
      }

      function renderMatchupsBack() {
        const sport = currentSport();
        const matchup = currentMatchup();

        backTitleEl.textContent = `${sport.name} ‚Äì Top Lines`;
        backSubEl.textContent = "Swipe each line. Clear the pack to advance.";
        matchupsListEl.innerHTML = "";
        visibleLinesCount = 0;

        const linesToShow = matchup.lines.slice(0, 5);

        linesToShow.forEach((ln) => {
          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = ln.label;

          const gameLine = document.createElement("div");
          gameLine.className = "matchup-line";
          gameLine.textContent = matchup.name;

          const helper = document.createElement("div");
          helper.className = "matchup-line";
          helper.textContent = "Swipe right = Confident. Swipe left = Doubt it. Double-tap for details.";

          left.appendChild(label);
          left.appendChild(gameLine);
          left.appendChild(helper);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = ln.book || "Consensus";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);

          const meta = {
            sportIndex: currentSportIndex,
            matchupIndex: currentMatchupIndex,
            label: ln.label,
            category: ln.category || "other",
            book: ln.book || "Best Available",
          };

          const sentimentContainer = document.createElement("div");
          sentimentContainer.className = "sentiment-bar-container";
          renderSideBiasBar(sentimentContainer, meta);

          card.appendChild(sentimentContainer);

          attachSwipeToLineCard(card, meta, "matchupsTop");

          visibleLinesCount += 1;
          matchupsListEl.appendChild(card);
        });
      }

      function renderAllLinesBack() {
        const sport = currentSport();
        const matchup = currentMatchup();

        backTitleEl.textContent = `${sport.name} ‚Äì All Lines`;
        backSubEl.textContent = "Grouped lines. Swipe + double-tap works the same.";
        matchupsListEl.innerHTML = "";

        const baseLines = matchup.lines.slice();
        let extendedLines = baseLines.slice();

        // Add alt lines (demo)
        let altCounter = 1;
        while (extendedLines.length < 12 && baseLines.length > 0) {
          const template = baseLines[(extendedLines.length - baseLines.length) % baseLines.length];
          const cat =
            template.category === "spread" || template.category === "total" || template.category === "points"
              ? "alt"
              : template.category || "alt";
          extendedLines.push({
            ...template,
            label: `${template.label} (Alt ${altCounter})`,
            category: cat,
          });
          altCounter++;
        }

        const grouped = {};
        extendedLines.forEach((ln) => {
          const cat = ln.category || "other";
          grouped[cat] = grouped[cat] || [];
          grouped[cat].push(ln);
        });

        CATEGORY_ORDER.forEach((catKey) => {
          const linesInCat = grouped[catKey];
          if (!linesInCat || !linesInCat.length) return;

          const header = document.createElement("div");
          header.className = "category-header";
          header.textContent = CATEGORY_LABELS[catKey] || CATEGORY_LABELS.other;
          matchupsListEl.appendChild(header);

          linesInCat.forEach((ln) => {
            const card = document.createElement("div");
            card.className = "matchup-card";

            const top = document.createElement("div");
            top.className = "matchup-top";

            const left = document.createElement("div");
            const label = document.createElement("div");
            label.className = "matchup-label";
            label.textContent = ln.label;

            const gameLine = document.createElement("div");
            gameLine.className = "matchup-line";
            gameLine.textContent = matchup.name;

            const helper = document.createElement("div");
            helper.className = "matchup-line";
            helper.textContent = "Swipe right = Confident. Swipe left = Doubt it. Double-tap for details.";

            left.appendChild(label);
            left.appendChild(gameLine);
            left.appendChild(helper);

            const right = document.createElement("div");
            right.className = "matchup-tag";
            right.textContent = ln.book || "Consensus";

            top.appendChild(left);
            top.appendChild(right);
            card.appendChild(top);

            const meta = {
              sportIndex: currentSportIndex,
              matchupIndex: currentMatchupIndex,
              label: ln.label,
              category: ln.category || "other",
              book: ln.book || "Best Available",
            };

            const sentimentContainer = document.createElement("div");
            sentimentContainer.className = "sentiment-bar-container";
            renderSideBiasBar(sentimentContainer, meta);

            card.appendChild(sentimentContainer);

            attachSwipeToLineCard(card, meta, "allLines");
            matchupsListEl.appendChild(card);
          });
        });
      }

      function renderLineDetailsFront() {
        const meta = currentLineDetailMeta;
        const stats = currentLineDetailStats;
        const sport = SPORTS[meta.sportIndex];

        logoEl.className = "sport-logo-circle " + sport.logoClass;
        logoEl.textContent = sport.emoji;

        nameEl.textContent = meta.label;
        codeEl.textContent = `${stats.sportName} ‚Ä¢ ${stats.matchupName}`;
        tapHintFrontEl.textContent = "Tap center to go back ‚Ü∫";

        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderLineDetailsBack() {
        const stats = currentLineDetailStats;
        const meta = currentLineDetailMeta;

        backTitleEl.textContent = "Line Detail";
        backSubEl.textContent = meta.label;
        matchupsListEl.innerHTML = "";

        const card = document.createElement("div");
        card.className = "matchup-card";

        const t = document.createElement("div");
        t.className = "matchup-label stat-highlight";
        t.textContent = "SideBias + Sample Stats";
        card.appendChild(t);

        const r1 = document.createElement("div");
        r1.className = "stat-row";
        r1.innerHTML = `<span>Line</span><span>${stats.lineValue}</span>`;
        card.appendChild(r1);

        const r2 = document.createElement("div");
        r2.className = "stat-row";
        r2.innerHTML = `<span>Season Avg</span><span>${stats.seasonAvg}</span>`;
        card.appendChild(r2);

        const r3 = document.createElement("div");
        r3.className = "stat-row";
        r3.innerHTML = `<span>Last 10 Avg</span><span>${stats.last10Avg}</span>`;
        card.appendChild(r3);

        const r4 = document.createElement("div");
        r4.className = "stat-row";
        r4.innerHTML = `<span>Home Avg</span><span>${stats.homeAvg}</span>`;
        card.appendChild(r4);

        const r5 = document.createElement("div");
        r5.className = "stat-row";
        r5.innerHTML = `<span>Road Avg</span><span>${stats.roadAvg}</span>`;
        card.appendChild(r5);

        const item = ensureSideBiasItem(meta);
        const pct = computeSideBiasPercent(item);

        const sentimentContainer = document.createElement("div");
        sentimentContainer.className = "sentiment-bar-container";
        renderSideBiasBar(sentimentContainer, meta);
        card.appendChild(sentimentContainer);

        const note = document.createElement("div");
        note.className = "line-detail-note";
        note.textContent =
          "This is demo data for layout. Next step is saving SideBias to Supabase per line + computing global bias across users. Right now it‚Äôs local-only.";
        card.appendChild(note);

        matchupsListEl.appendChild(card);
      }

      function renderSideBiasFront() {
        logoEl.className = "sport-logo-circle sport-logo-nba";
        logoEl.textContent = "üìä";
        nameEl.textContent = "SideBias";
        codeEl.textContent = "Your Confident vs Doubt it history";
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderSideBiasBack() {
        backTitleEl.textContent = "SideBias";
        backSubEl.textContent =
          "All your swipes. Swipe right to promote to Locks. Swipe left to Archive. Double-tap for details.";
        matchupsListEl.innerHTML = "";

        const inbox = getInboxItems().sort((a, b) => {
          if (b.crowdSize !== a.crowdSize) return b.crowdSize - a.crowdSize;
          return (b.lastUpdated || 0) - (a.lastUpdated || 0);
        });

        if (!inbox.length) {
          const empty = document.createElement("div");
          empty.className = "matchup-card";
          const t = document.createElement("div");
          t.className = "matchup-label";
          t.textContent = "Nothing in SideBias yet";
          const p = document.createElement("div");
          p.className = "matchup-line";
          p.textContent = "Swipe a few lines in the main flow, then come back here.";
          empty.appendChild(t);
          empty.appendChild(p);
          matchupsListEl.appendChild(empty);
          return;
        }

        inbox.forEach((item) => {
          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = item.lineLabel;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = `${item.matchupName} ‚Ä¢ ${item.sportName}`;

          const helper = document.createElement("div");
          helper.className = "matchup-line";
          helper.textContent = "Swipe right = Lock. Swipe left = Archive. Double-tap = details.";

          left.appendChild(label);
          left.appendChild(line);
          left.appendChild(helper);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = item.book || "Best Available";

          top.appendChild(left);
          top.appendChild(right);
          card.appendChild(top);

          // Build bar via meta
          const meta = {
            sportIndex: item.sportIndex,
            matchupIndex: item.matchupIndex,
            label: item.lineLabel,
            category: item.category,
            book: item.book,
          };

          const sentimentContainer = document.createElement("div");
          sentimentContainer.className = "sentiment-bar-container";
          renderSideBiasBar(sentimentContainer, meta);
          card.appendChild(sentimentContainer);

          attachSwipeToLineCard(card, meta, "sidebiasInbox");
          matchupsListEl.appendChild(card);
        });
      }

      function renderLocksFront() {
        logoEl.className = "sport-logo-circle sport-logo-nfl";
        logoEl.textContent = "üîí";
        nameEl.textContent = "Locks";
        codeEl.textContent = "Promoted Confident plays";
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderLocksBack() {
        backTitleEl.textContent = "Locks";
        backSubEl.textContent = "Grouped by sportsbook. Double-tap a lock for details.";
        matchupsListEl.innerHTML = "";

        const locks = getLockItems().sort((a, b) => (b.lastUpdated || 0) - (a.lastUpdated || 0));

        if (!locks.length) {
          const empty = document.createElement("div");
          empty.className = "matchup-card";
          const t = document.createElement("div");
          t.className = "matchup-label";
          t.textContent = "No locks yet";
          const p = document.createElement("div");
          p.className = "matchup-line";
          p.textContent = "From SideBias, swipe right to promote a line into Locks.";
          empty.appendChild(t);
          empty.appendChild(p);
          matchupsListEl.appendChild(empty);
          return;
        }

        const byBook = {};
        locks.forEach((x) => {
          const book = x.book || "Best Available";
          byBook[book] = byBook[book] || [];
          byBook[book].push(x);
        });

        Object.keys(byBook)
          .sort()
          .forEach((book) => {
            const header = document.createElement("div");
            header.className = "category-header";
            header.textContent = book;
            matchupsListEl.appendChild(header);

            byBook[book].forEach((item) => {
              const card = document.createElement("div");
              card.className = "matchup-card";
              card.style.cursor = "pointer";

              const top = document.createElement("div");
              top.className = "matchup-top";

              const left = document.createElement("div");
              const label = document.createElement("div");
              label.className = "matchup-label";
              label.textContent = item.lineLabel;

              const line = document.createElement("div");
              line.className = "matchup-line";
              line.textContent = `${item.matchupName} ‚Ä¢ ${item.sportName}`;

              left.appendChild(label);
              left.appendChild(line);

              const right = document.createElement("div");
              right.className = "matchup-tag";
              right.textContent = book;

              top.appendChild(left);
              top.appendChild(right);
              card.appendChild(top);

              const meta = {
                sportIndex: item.sportIndex,
                matchupIndex: item.matchupIndex,
                label: item.lineLabel,
                category: item.category,
                book: item.book,
              };

              const sentimentContainer = document.createElement("div");
              sentimentContainer.className = "sentiment-bar-container";
              renderSideBiasBar(sentimentContainer, meta);
              card.appendChild(sentimentContainer);

              card.addEventListener("dblclick", (e) => {
                e.stopPropagation();
                openLineDetails(meta);
              });

              matchupsListEl.appendChild(card);
            });

            const bookBtn = document.createElement("button");
            bookBtn.className = "sportsbook-cta-btn";
            bookBtn.textContent = `Place bet in ${book} (affiliate later)`;
            bookBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              showToast(`Affiliate link for ${book} coming soon`);
            });
            matchupsListEl.appendChild(bookBtn);
          });

        const playBtn = document.createElement("button");
        playBtn.className = "play-locks-cta";
        playBtn.textContent = "PLAY YOUR LOCKS (Coming Soon)";
        playBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          showToast("In-house play mode coming soon");
        });
        matchupsListEl.appendChild(playBtn);
      }

      function renderArchiveFront() {
        logoEl.className = "sport-logo-circle sport-logo-nba";
        logoEl.textContent = "üóÉÔ∏è";
        nameEl.textContent = "Archive";
        codeEl.textContent = "Doubt it (archived) lines";
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderArchiveBack() {
        backTitleEl.textContent = "Archive";
        backSubEl.textContent = "Lines you archived. Double-tap to view details.";
        matchupsListEl.innerHTML = "";

        const archived = getArchiveItems().sort((a, b) => (b.lastUpdated || 0) - (a.lastUpdated || 0));

        if (!archived.length) {
          const empty = document.createElement("div");
          empty.className = "matchup-card";
          const t = document.createElement("div");
          t.className = "matchup-label";
          t.textContent = "Nothing archived";
          const p = document.createElement("div");
          p.className = "matchup-line";
          p.textContent = "From SideBias, swipe left to archive a line.";
          empty.appendChild(t);
          empty.appendChild(p);
          matchupsListEl.appendChild(empty);
          return;
        }

        archived.forEach((item) => {
          const card = document.createElement("div");
          card.className = "matchup-card";
          card.style.cursor = "pointer";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = item.lineLabel;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = `${item.matchupName} ‚Ä¢ ${item.sportName}`;

          left.appendChild(label);
          left.appendChild(line);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = item.book || "Best Available";

          top.appendChild(left);
          top.appendChild(right);
          card.appendChild(top);

          const meta = {
            sportIndex: item.sportIndex,
            matchupIndex: item.matchupIndex,
            label: item.lineLabel,
            category: item.category,
            book: item.book,
          };

          card.addEventListener("dblclick", (e) => {
            e.stopPropagation();
            openLineDetails(meta);
          });

          matchupsListEl.appendChild(card);
        });
      }

      /************************************************************
       * Main screen router (THIS is what was undefined before)
       ************************************************************/
      function renderScreen() {
        // SAFETY: if DOM refs missing, we don't crash
        if (!titleEl || !subtitleEl || !directionsEl) return;

        if (mode === "sports") {
          titleEl.textContent = "Select Your Sport";
          subtitleEl.textContent = "Swipe edges. Tap center to flip.";
          directionsEl.innerHTML =
            'Tap the <strong>center</strong> to flip and preview matchups. Tap <strong>right edge</strong> for <strong>Confident</strong> (next), and <strong>left edge</strong> for <strong>Doubt it</strong> (previous). Double-tap center to open the sport. Tap <strong>bottom-left</strong> to go back.';
          backToSportsBtn.style.display = "none";
          renderSportsFront();
          renderSportsBack();
          flipped = flipped && true; // keep current flip state
        } else if (mode === "matchups") {
          const sport = currentSport();
          titleEl.textContent = `${sport.name} Matchups`;
          subtitleEl.textContent = "Each card is a matchup.";
          directionsEl.innerHTML =
            'Tap center to flip. Double-tap center for <strong>all lines</strong>. Swipe lines: right = <strong>Confident</strong>, left = <strong>Doubt it</strong>. Double-tap a line for details.';
          backToSportsBtn.style.display = "inline-flex";
          renderMatchupsFront();
          renderMatchupsBack();
        } else if (mode === "allLines") {
          const sport = currentSport();
          const matchup = currentMatchup();
          titleEl.textContent = `${sport.name} ‚Äì All Lines`;
          subtitleEl.textContent = matchup.name;
          directionsEl.innerHTML =
            'Scroll lines. Swipe right = <strong>Confident</strong>, left = <strong>Doubt it</strong>. Double-tap for details.';
          backToSportsBtn.style.display = "inline-flex";
          renderMatchupsFront();
          renderAllLinesBack();
          flipped = true;
        } else if (mode === "lineDetails") {
          titleEl.textContent = "Line Detail";
          subtitleEl.textContent = currentLineDetailStats ? currentLineDetailStats.matchupName : "";
          directionsEl.innerHTML =
            'Tap the <strong>center</strong> or the <strong>bottom-left</strong> to go back.';
          backToSportsBtn.style.display = "inline-flex";
          renderLineDetailsFront();
          renderLineDetailsBack();
          flipped = true;
        } else if (mode === "sidebias") {
          titleEl.textContent = "SideBias";
          subtitleEl.textContent = "Your Confident vs Doubt it feed.";
          directionsEl.innerHTML =
            'Swipe right to promote to <strong>Locks</strong>. Swipe left to <strong>Archive</strong>. Double-tap for detail.';
          backToSportsBtn.style.display = "inline-flex";
          renderSideBiasFront();
          renderSideBiasBack();
          flipped = true;
        } else if (mode === "locks") {
          titleEl.textContent = "Locks";
          subtitleEl.textContent = "Your promoted Confident plays.";
          directionsEl.innerHTML =
            "Double-tap a lock for details. CTA buttons are placeholders.";
          backToSportsBtn.style.display = "inline-flex";
          renderLocksFront();
          renderLocksBack();
          flipped = true;
        } else if (mode === "archive") {
          titleEl.textContent = "Archive";
          subtitleEl.textContent = "Archived Doubt it lines.";
          directionsEl.innerHTML = "Double-tap an archived line for details.";
          backToSportsBtn.style.display = "inline-flex";
          renderArchiveFront();
          renderArchiveBack();
          flipped = true;
        }

        renderCardFlipState();
      }

      /***************
       * Back logic
       ***************/
      function handleGlobalBack() {
        if (mode === "lineDetails" && previousModeBeforeLineDetails) {
          mode = previousModeBeforeLineDetails;
          flipped = true;
        } else if (mode === "allLines") {
          mode = "matchups";
          flipped = true;
        } else if (mode === "matchups") {
          mode = "sports";
          flipped = false;
        } else if (mode === "sidebias" || mode === "locks" || mode === "archive") {
          mode = "sports";
          flipped = false;
        } else {
          return;
        }
        renderScreen();
      }

      backToSportsBtn.addEventListener("click", () => handleGlobalBack());

      /***************
       * Card click handling
       ***************/
      function handleSingleClick(e) {
        const rect = cardClickArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const zone = x / rect.width;

        if (mode === "sidebias" || mode === "locks" || mode === "archive") {
          if (zone >= 0.2 && zone <= 0.8) {
            flipped = !flipped;
            renderCardFlipState();
          }
          return;
        }

        if (zone < 0.2) {
          if (mode === "sports") currentSportIndex = getPrevIndex(SPORTS.length, currentSportIndex);
          else if (mode === "matchups" || mode === "allLines")
            currentMatchupIndex = getPrevIndex(currentSport().matchups.length, currentMatchupIndex);

          if (mode !== "lineDetails") flipped = false;
          renderScreen();
        } else if (zone > 0.8) {
          if (mode === "sports") currentSportIndex = getNextIndex(SPORTS.length, currentSportIndex);
          else if (mode === "matchups" || mode === "allLines")
            currentMatchupIndex = getNextIndex(currentSport().matchups.length, currentMatchupIndex);

          if (mode !== "lineDetails") flipped = false;
          renderScreen();
        } else {
          if (mode === "lineDetails") handleGlobalBack();
          else {
            flipped = !flipped;
            renderCardFlipState();
          }
        }
      }

      function handleDoubleClick(e) {
        const rect = cardClickArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const zone = x / rect.width;

        if (mode === "lineDetails") {
          handleGlobalBack();
          return;
        }

        if (mode === "sidebias" || mode === "locks" || mode === "archive") {
          flipped = !flipped;
          renderCardFlipState();
          return;
        }

        if (mode === "sports" && zone >= 0.2 && zone <= 0.8) {
          mode = "matchups";
          currentMatchupIndex = 0;
          flipped = false;
          renderScreen();
          return;
        }

        if (mode === "matchups" && zone >= 0.2 && zone <= 0.8) {
          mode = "allLines";
          flipped = true;
          renderScreen();
          return;
        }

        handleSingleClick(e);
      }

      cardClickArea.addEventListener("click", (e) => {
        if (clickTimeout) {
          clearTimeout(clickTimeout);
          clickTimeout = null;
          handleDoubleClick(e);
        } else {
          clickTimeout = setTimeout(() => {
            handleSingleClick(e);
            clickTimeout = null;
          }, DOUBLE_CLICK_DELAY);
        }
      });

      /***************
       * Menus
       ***************/
      function buildSportsMenu() {
        sportsMenuEl.innerHTML = "";
        SPORTS.forEach((sport, sIndex) => {
          const sportItem = document.createElement("div");
          sportItem.className = "sports-menu-item";

          const title = document.createElement("div");
          title.className = "sports-menu-item-title";
          title.textContent = sport.name;
          sportItem.appendChild(title);

          const gamesSub = document.createElement("div");
          gamesSub.className = "sports-games-submenu";

          sport.matchups.forEach((matchup, mIndex) => {
            const gameItem = document.createElement("div");
            gameItem.className = "game-item";
            gameItem.textContent = matchup.name;
            gameItem.addEventListener("click", (e) => {
              e.stopPropagation();
              currentSportIndex = sIndex;
              currentMatchupIndex = mIndex;
              mode = "allLines";
              flipped = true;
              sportsMenuEl.classList.remove("open");
              renderScreen();
            });
            gamesSub.appendChild(gameItem);
          });

          sportItem.appendChild(gamesSub);
          sportsMenuEl.appendChild(sportItem);
        });
      }

      appLogoButton.addEventListener("click", (e) => {
        e.stopPropagation();
        const isOpen = sportsMenuEl.classList.contains("open");
        sportsMenuEl.classList.toggle("open", !isOpen);
      });

      function updateUserMenuLabel() {
        userMenuLabel.textContent = "SideBias";
      }

      function buildUserDropdown() {
        userDropdown.innerHTML = "";

        const sideBiasItem = document.createElement("div");
        sideBiasItem.className = "user-dropdown-item";
        sideBiasItem.textContent = "SideBias";
        sideBiasItem.addEventListener("click", () => {
          mode = "sidebias";
          flipped = true;
          userDropdown.classList.remove("open");
          renderScreen();
        });
        userDropdown.appendChild(sideBiasItem);

        const locksItem = document.createElement("div");
        locksItem.className = "user-dropdown-item";
        locksItem.textContent = "Locks";
        locksItem.addEventListener("click", () => {
          mode = "locks";
          flipped = true;
          userDropdown.classList.remove("open");
          renderScreen();
        });
        userDropdown.appendChild(locksItem);

        const archiveItem = document.createElement("div");
        archiveItem.className = "user-dropdown-item";
        archiveItem.textContent = "Archive";
        archiveItem.addEventListener("click", () => {
          mode = "archive";
          flipped = true;
          userDropdown.classList.remove("open");
          renderScreen();
        });
        userDropdown.appendChild(archiveItem);

        const sep = document.createElement("div");
        sep.className = "user-dropdown-separator";
        userDropdown.appendChild(sep);

        const authItem = document.createElement("div");
        authItem.className = "user-dropdown-item";
        authItem.textContent = currentUser ? "Sign out" : "Sign in";
        authItem.addEventListener("click", async () => {
          if (currentUser && supabaseClient) {
            await supabaseClient.auth.signOut();
            currentUser = null;
            showToast("Signed out");
          } else {
            showAuthOverlay();
          }
          buildUserDropdown();
          userDropdown.classList.remove("open");
        });
        userDropdown.appendChild(authItem);
      }

      userMenuButton.addEventListener("click", (e) => {
        e.stopPropagation();
        const isOpen = userDropdown.classList.contains("open");
        userDropdown.classList.toggle("open", !isOpen);
      });

      // Global click to close menus + bottom-left back
      document.addEventListener("click", (e) => {
        const target = e.target;

        const clickedCard = cardClickArea.contains(target);
        const clickedBack = backToSportsBtn.contains(target);
        const clickedUserMenu = userMenuWrapper.contains(target);
        const clickedLogoMenu = logoGroup.contains(target);
        const clickedAuth = authOverlay.contains(target);

        if (!clickedLogoMenu) sportsMenuEl.classList.remove("open");
        if (!clickedUserMenu) userDropdown.classList.remove("open");

        if (clickedCard || clickedBack || clickedUserMenu || clickedLogoMenu || clickedAuth) return;

        const vw = window.innerWidth;
        const vh = window.innerHeight;
        const x = e.clientX;
        const y = e.clientY;

        if (x < vw * 0.25 && y > vh * 0.75) handleGlobalBack();
      });

      /***************
       * Keyboard nav
       ***************/
      document.addEventListener("keydown", (e) => {
        if (e.key === "ArrowLeft") {
          if (mode === "sports") currentSportIndex = getPrevIndex(SPORTS.length, currentSportIndex);
          else if (mode === "matchups" || mode === "allLines")
            currentMatchupIndex = getPrevIndex(currentSport().matchups.length, currentMatchupIndex);

          if (mode !== "lineDetails") flipped = false;
          renderScreen();
        } else if (e.key === "ArrowRight") {
          if (mode === "sports") currentSportIndex = getNextIndex(SPORTS.length, currentSportIndex);
          else if (mode === "matchups" || mode === "allLines")
            currentMatchupIndex = getNextIndex(currentSport().matchups.length, currentMatchupIndex);

          if (mode !== "lineDetails") flipped = false;
          renderScreen();
        } else if (e.key === " ") {
          e.preventDefault();
          if (mode === "lineDetails") handleGlobalBack();
          else {
            flipped = !flipped;
            renderCardFlipState();
          }
        }
      });

      /************************************************************
       * AUTH FLOW (simple, works)
       ************************************************************/
      async function handleSignIn() {
        const email = ($("#email")?.value || "").trim();
        const password = $("#password")?.value || "";
        if (!email || !password) return alert("Enter email and password.");

        if (!supabaseClient) return alert("Supabase not ready. Refresh once.");

        const res = await supabaseClient.auth.signInWithPassword({ email, password });
        console.log("SIGNIN:", res);

        if (res.error) return alert(res.error.message);

        const sessionRes = await supabaseClient.auth.getSession();
        if (!sessionRes.data?.session) return alert("Signed in but no session found.");

        currentUser = sessionRes.data.session.user || null;
        buildUserDropdown();
        hardHideAuthOverlay();
        showToast("Signed in ‚úÖ");
      }

      async function handleSignUp() {
        const email = ($("#email")?.value || "").trim();
        const password = $("#password")?.value || "";
        if (!email || !password) return alert("Enter email and password.");

        if (!supabaseClient) return alert("Supabase not ready. Refresh once.");

        const res = await supabaseClient.auth.signUp({ email, password });
        console.log("SIGNUP:", res);

        if (res.error) return alert(res.error.message);

        alert("Account created. If email confirmation is enabled, confirm then sign in.");
      }

      async function handleContinue() {
        // Continue only if session exists; otherwise allow user to sign in or skip
        if (!supabaseClient) {
          hardHideAuthOverlay();
          showToast("Guest mode (no auth) ‚úÖ");
          return;
        }

        const sessionRes = await supabaseClient.auth.getSession();
        const sess = sessionRes.data?.session;
        if (!sess) {
          alert("Please sign in first, or press Skip.");
          return;
        }

        currentUser = sess.user || null;
        buildUserDropdown();
        hardHideAuthOverlay();
        showToast("Welcome back ‚úÖ");
      }

      function wireAuthButtons() {
        authSkipBtn.addEventListener("click", (e) => {
          e.preventDefault();
          hardHideAuthOverlay();
          showToast("Guest mode ‚úÖ");
        });

        signInBtn.addEventListener("click", async (e) => {
          e.preventDefault();
          await handleSignIn();
        });

        signUpBtn.addEventListener("click", async (e) => {
          e.preventDefault();
          await handleSignUp();
        });

        authContinueBtn.addEventListener("click", async (e) => {
          e.preventDefault();
          await handleContinue();
        });
      }

      /************************************************************
       * NFL LIVE ODDS (optional)
       * Safe wrapper: never breaks UI if API fails.
       ************************************************************/
      async function fetchJsonSafe(url) {
        try {
          const r = await fetch(url);
          if (!r.ok) return null;
          return await r.json();
        } catch {
          return null;
        }
      }

      function applyLiveNflOdds(oddsData) {
        const nflSport = SPORTS.find((s) => s.id === "nfl");
        if (!nflSport) return;

        const mapped = [];
        oddsData.forEach((game) => {
          const homeName = game.HomeTeamName || game.HomeTeam || "HOME";
          const awayName = game.AwayTeamName || game.AwayTeam || "AWAY";
          const matchupName = `${awayName} @ ${homeName}`;

          const pre = game.PregameOdds || [];
          if (!pre.length) return;

          const lines = [];

          pre.forEach((odd) => {
            const book =
              odd.SportsbookName ||
              odd.Sportsbook ||
              odd.SportsBook ||
              `Sportsbook ${odd.SportsbookId || ""}`.trim() ||
              "Sportsbook";

            if (typeof odd.Spread === "number" && odd.FavoredTeam) {
              lines.push({
                label: `${odd.FavoredTeam} ${odd.Spread > 0 ? "+" : ""}${odd.Spread}`,
                category: "spread",
                book,
              });
            }

            if (typeof odd.OverUnder === "number") {
              lines.push({
                label: `Total ${odd.OverUnder}`,
                category: "total",
                book,
              });
            }

            if (typeof odd.HomeTeamMoneyLine === "number") {
              const val = odd.HomeTeamMoneyLine;
              lines.push({
                label: `${homeName} ${val > 0 ? "+" : ""}${val} ML`,
                category: "moneyline",
                book,
              });
            }

            if (typeof odd.AwayTeamMoneyLine === "number") {
              const val = odd.AwayTeamMoneyLine;
              lines.push({
                label: `${awayName} ${val > 0 ? "+" : ""}${val} ML`,
                category: "moneyline",
                book,
              });
            }
          });

          if (!lines.length) return;

          mapped.push({
            name: matchupName,
            lines: lines.slice(0, 20),
            _scoreId: game.ScoreId || game.ScoreID || null,
          });
        });

        if (mapped.length) {
          nflSport.matchups = mapped;
          console.log("NFL updated with", mapped.length, "live games");
        }
      }

      async function augmentNflMatchupsWithProps(oddsData) {
        const nflSport = SPORTS.find((s) => s.id === "nfl");
        if (!nflSport) return;

        const gamesWithScore = oddsData.filter((g) => g.ScoreId || g.ScoreID);
        if (!gamesWithScore.length) return;

        const limited = gamesWithScore.slice(0, 4);

        function findMatchupByScoreId(scoreId) {
          return nflSport.matchups.find((m) => m._scoreId == scoreId);
        }

        for (const game of limited) {
          const scoreId = game.ScoreId || game.ScoreID;
          const matchup = findMatchupByScoreId(scoreId);
          if (!matchup) continue;

          const propsUrl = `https://api.sportsdata.io/v3/nfl/odds/json/BettingPlayerPropsByScoreID/${scoreId}?key=${NFL_API_KEY}`;
          const propsData = await fetchJsonSafe(propsUrl);
          if (!Array.isArray(propsData) || !propsData.length) continue;

          const propLines = [];
          propsData.forEach((prop) => {
            const book = prop.SportsbookName || prop.Sportsbook || prop.SportsBook || "Sportsbook";
            const playerName = prop.PlayerName || prop.Name || prop.ParticipantName || "Player";
            const statType =
              prop.BettingMarketTypeDescription || prop.BettingMarketType || prop.MarketDescription || "Prop";

            const baseValue =
              typeof prop.Value === "number" ? prop.Value : typeof prop.Total === "number" ? prop.Total : null;

            const overOutcome =
              (prop.BettingOutcomes || []).find((o) => o.BettingOutcomeType === "Over" || o.OutcomeType === "Over") ||
              null;

            const displayValue =
              overOutcome && typeof overOutcome.Value === "number" ? overOutcome.Value : baseValue;

            if (displayValue == null) return;

            const label = `${playerName} o${displayValue} ${statType}`.replace(/\s+/g, " ").trim();
            propLines.push({ label, category: "props", book });
          });

          if (!propLines.length) continue;
          matchup.lines = matchup.lines.concat(propLines.slice(0, 10));
          console.log("Attached props:", matchup.name, propLines.length);
        }
      }

      async function loadLiveNflOdds() {
        if (!NFL_API_KEY) return;
        const season = await fetchJsonSafe(
          `https://api.sportsdata.io/v3/nfl/scores/json/CurrentSeason?key=${NFL_API_KEY}`
        );
        const week = await fetchJsonSafe(
          `https://api.sportsdata.io/v3/nfl/scores/json/CurrentWeek?key=${NFL_API_KEY}`
        );
        const s = Number(season);
        const w = Number(week);
        if (!s || !w) return;

        const oddsData = await fetchJsonSafe(
          `https://api.sportsdata.io/v3/nfl/odds/json/GameOddsByWeek/${s}/${w}?key=${NFL_API_KEY}`
        );
        if (!Array.isArray(oddsData) || !oddsData.length) return;

        applyLiveNflOdds(oddsData);
        await augmentNflMatchupsWithProps(oddsData);

        // Refresh if user is on NFL views
        renderScreen();
      }

      /************************************************************
       * BOOT
       ************************************************************/
      function boot() {
        // Init supabase
        supabaseClient = initSupabase();

        // Restore session if exists
        if (supabaseClient) {
          supabaseClient.auth.getSession().then((r) => {
            currentUser = r.data?.session?.user || null;
            buildUserDropdown();
          });

          // Optional: react to auth changes
          supabaseClient.auth.onAuthStateChange((_event, session) => {
            currentUser = session?.user || null;
            buildUserDropdown();
          });
        }

        buildSportsMenu();
        updateUserMenuLabel();
        buildUserDropdown();
        wireAuthButtons();

        // Always render UI
        renderScreen();

        // Try loading NFL odds (won‚Äôt break app if it fails)
        loadLiveNflOdds().catch((e) => console.warn("NFL live load failed:", e));
      }

      window.addEventListener("load", boot);
    </script>
  </body>
</html>
