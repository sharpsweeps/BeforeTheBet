<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>BeforeTheBet ‚Äì Demo MVP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      :root {
        color-scheme: dark;
        --bg: #020617;
        --card: #020617;
        --border: #1e293b;
        --text: #e2e8f0;
        --muted: #64748b;

        --blue: #3b82f6;
        --green: #22c55e;

        --disabled: rgba(148, 163, 184, 0.25);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #0f172a 0, #020617 55%);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .app-shell {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header,
      footer {
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        border-bottom: 1px solid var(--border);
        backdrop-filter: blur(10px);
        background: linear-gradient(
          to bottom,
          rgba(15, 23, 42, 0.9),
          rgba(15, 23, 42, 0.4)
        );
        z-index: 10;
      }

      footer {
        border-top: 1px solid var(--border);
        border-bottom: none;
        background: linear-gradient(
          to top,
          rgba(15, 23, 42, 0.9),
          rgba(15, 23, 42, 0.4)
        );
        justify-content: center;
        font-size: 11px;
        color: var(--muted);
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .logo-group {
        position: relative;
        display: flex;
        align-items: center;
      }

      .logo-button {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: transparent;
        cursor: pointer;
      }

      .logo-button:hover {
        border-color: #1f2937;
        background: rgba(15, 23, 42, 0.85);
      }

      .logo {
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: #cbd5e1;
      }

      .logo-caret {
        font-size: 10px;
        color: var(--muted);
      }

      .sports-menu {
        position: absolute;
        top: 110%;
        left: 0;
        background: #020617;
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.8);
        padding: 8px 0;
        min-width: 260px;
        display: none;
        z-index: 60;
        max-height: 70vh;
        overflow: auto;
      }

      .sports-menu.open {
        display: block;
      }

      .sports-menu-item {
        padding: 8px 12px;
        font-size: 12px;
        color: #e5e7eb;
        cursor: default;
        position: relative;
      }

      .sports-menu-item:hover {
        background: #0f172a;
      }

      .sports-menu-item-title {
        font-weight: 700;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        font-size: 11px;
        color: #cbd5e1;
      }

      .sports-games-submenu {
        margin-top: 6px;
        margin-left: 4px;
        padding-left: 10px;
        border-left: 1px solid #1f2937;
      }

      .game-item {
        font-size: 11px;
        color: var(--muted);
        padding: 5px 0;
        cursor: pointer;
      }

      .game-item:hover {
        color: #e5e7eb;
      }

      #back-to-sports {
        display: none;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.95);
        color: var(--muted);
        font-size: 11px;
        padding: 4px 10px;
        cursor: pointer;
      }

      #back-to-sports:hover {
        border-color: #334155;
        color: #e5e7eb;
      }

      .user-menu-wrapper {
        position: relative;
      }

      .menu-placeholder {
        font-size: 11px;
        color: var(--muted);
        cursor: pointer;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: transparent;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .menu-placeholder:hover {
        border-color: #1f2937;
        color: #e5e7eb;
        background: rgba(15, 23, 42, 0.8);
      }

      .user-dropdown {
        position: absolute;
        right: 0;
        top: 110%;
        background: #020617;
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.8);
        min-width: 190px;
        padding: 6px 0;
        display: none;
        z-index: 60;
      }

      .user-dropdown.open {
        display: block;
      }

      .user-dropdown-item {
        padding: 8px 12px;
        font-size: 12px;
        cursor: pointer;
        color: #e5e7eb;
      }

      .user-dropdown-item:hover {
        background: #0f172a;
      }

      .user-dropdown-separator {
        border-top: 1px solid #1f2937;
        margin: 4px 0;
      }

      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: center;
        padding: 24px 16px;
      }

      .content {
        max-width: 980px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 24px;
        align-items: stretch;
      }

      .title-block {
        text-align: center;
      }

      .title-block h1 {
        font-size: 28px;
        margin: 0 0 8px;
      }

      .title-block p {
        margin: 0;
        font-size: 14px;
        color: var(--muted);
      }

      .title-block .directions {
        margin-top: 6px;
        font-size: 12px;
        color: var(--muted);
      }

      @media (min-width: 768px) {
        .title-block h1 {
          font-size: 32px;
        }
        .title-block .directions {
          font-size: 13px;
        }
      }

      /* card stack */
      .card-container {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .card-click-area {
        position: relative;
        width: 100%;
        max-width: 420px;
        aspect-ratio: 2.5 / 3.5;
        perspective: 1200px;
        cursor: pointer;
      }

      .card,
      .stack-card {
        position: absolute;
        inset: 0;
        border-radius: 24px;
        border: 1px solid var(--border);
        background: radial-gradient(circle at top, #020617, #020617);
        box-shadow: 0 22px 40px rgba(0, 0, 0, 0.6);
        overflow: hidden;
      }

      .card-main {
        transform-style: preserve-3d;
        transition: transform 0.5s ease;
        z-index: 3;
      }

      .stack-card {
        pointer-events: none;
        opacity: 0.55;
        z-index: 0;
      }

      .stack-card.stack-1 {
        transform: translateY(10px) translateX(6px) scale(0.97);
      }
      .stack-card.stack-2 {
        transform: translateY(18px) translateX(10px) scale(0.94);
        opacity: 0.4;
      }
      .stack-card.stack-3 {
        transform: translateY(26px) translateX(14px) scale(0.9);
        opacity: 0.25;
      }

      .card-face {
        position: absolute;
        inset: 0;
        padding: 18px 16px 14px;
        display: flex;
        flex-direction: column;
        backface-visibility: hidden;
      }

      .card-front {
        align-items: center;
        text-align: center;
        justify-content: center;
        gap: 12px;
        transform: rotateY(0deg);
        transition: transform 0.5s ease;
      }

      .card-back {
        transform: rotateY(180deg);
        justify-content: flex-start;
        transition: transform 0.5s ease;
      }

      .card-main.flipped .card-front {
        transform: rotateY(-180deg);
      }

      .card-main.flipped .card-back {
        transform: rotateY(0deg);
      }

      /* logo + labels */
      .sport-logo-circle {
        width: 120px;
        height: 120px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 42px;
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.6);
      }

      .sport-logo-nba {
        background: radial-gradient(circle at top left, #38bdf8, #0ea5e9);
      }
      .sport-logo-nfl {
        background: radial-gradient(circle at top left, #4ade80, #22c55e);
      }

      .sport-front-name {
        font-size: 18px;
        font-weight: 650;
        margin-top: 10px;
      }

      .sport-front-code {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: var(--muted);
        margin-top: 4px;
        max-width: 95%;
      }

      .tap-hint {
        position: absolute;
        bottom: 10px;
        right: 14px;
        font-size: 10px;
        color: #6b7280;
        pointer-events: none;
      }

      .index-indicator {
        position: absolute;
        bottom: 10px;
        left: 14px;
        font-size: 10px;
        color: #6b7280;
      }

      /* back content */
      .back-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 8px;
        margin-bottom: 8px;
      }

      .back-title {
        font-size: 16px;
        font-weight: 700;
      }

      .back-sub {
        font-size: 11px;
        color: var(--muted);
        text-align: right;
      }

      .matchups-list {
        margin-top: 6px;
        flex: 1;
        overflow-y: auto;
        padding-right: 4px;
      }

      .matchup-card {
        border-radius: 18px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.98);
        padding: 10px 10px 8px;
        margin-bottom: 10px;
        position: relative;
        transition: transform 0.18s ease, opacity 0.18s ease;
        cursor: pointer;
      }

      .matchup-card.swipe-right {
        transform: translateX(40px);
        opacity: 0;
      }

      .matchup-card.swipe-left {
        transform: translateX(-40px);
        opacity: 0;
      }

      .matchup-card.is-answered {
        opacity: 0.55;
        background: rgba(15, 23, 42, 0.6);
        border-color: rgba(148, 163, 184, 0.25);
      }

      .matchup-card.is-answered .matchup-line {
        color: rgba(148, 163, 184, 0.8);
      }

      .matchup-card.is-answered .bias-labels span {
        opacity: 0.9;
      }

      .matchup-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 6px;
        margin-bottom: 6px;
      }

      .matchup-label {
        font-size: 13px;
        font-weight: 650;
        color: #e5e7eb;
      }

      .matchup-line {
        font-size: 11px;
        color: var(--muted);
        margin-top: 3px;
      }

      .matchup-tag {
        font-size: 11px;
        color: var(--muted);
        text-align: right;
        white-space: nowrap;
      }

      /* SideBias (now MyBias) UI */
      .bias-container {
        margin-top: 8px;
      }

      .bias-bar-bg {
        height: 10px;
        border-radius: 999px;
        background: #020617;
        overflow: hidden;
        border: 1px solid #111827;
      }

      .bias-bar-fill {
        height: 100%;
        border-radius: 999px;
        transition: width 0.25s ease;
      }

      .bias-bar-fill.blue {
        background: linear-gradient(90deg, #60a5fa, #3b82f6);
      }

      .bias-bar-fill.green {
        background: linear-gradient(90deg, #34d399, #22c55e);
      }

      .bias-labels {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        margin-top: 3px;
      }

      .bias-labels span:first-child {
        color: #cbd5e1;
        font-weight: 700;
      }

      .bias-labels span:last-child {
        color: #cbd5e1;
        font-weight: 700;
      }

      .back-footer-note {
        margin-top: 8px;
        font-size: 11px;
        color: var(--muted);
      }

      /* toast */
      .swipe-toast {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: rgba(15, 23, 42, 0.96);
        border-radius: 999px;
        border: 1px solid #1f2937;
        padding: 8px 14px;
        font-size: 12px;
        color: var(--text);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease, transform 0.2s ease;
        z-index: 70;
        white-space: nowrap;
      }

      .swipe-toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      /* line detail placeholder */
      .stat-row {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        font-size: 12px;
        margin-bottom: 6px;
      }

      .stat-row span:first-child {
        color: var(--muted);
      }

      .stat-row span:last-child {
        font-weight: 700;
      }

      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(2, 6, 23, 0.72);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        padding: 16px;
      }

      .modal-overlay.open {
        display: flex;
      }

      .modal-card {
        width: 100%;
        max-width: 420px;
        border-radius: 18px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.98);
        box-shadow: 0 26px 70px rgba(0, 0, 0, 0.75);
        padding: 14px;
      }

      .modal-title {
        font-size: 14px;
        font-weight: 800;
        margin-bottom: 6px;
      }

      .modal-sub {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 10px;
        line-height: 1.35;
      }

      .modal-actions {
        display: flex;
        gap: 10px;
      }

      .modal-actions button {
        flex: 1;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid #1f2937;
        background: transparent;
        color: #e5e7eb;
        cursor: pointer;
        font-weight: 700;
        font-size: 12px;
      }

      .modal-actions button.primary {
        background: #22c55e;
        color: #020617;
        border-color: transparent;
      }

      @media (max-width: 480px) {
        .card-click-area {
          max-width: 360px;
        }
        .sport-logo-circle {
          width: 104px;
          height: 104px;
          font-size: 36px;
        }
        .swipe-toast {
          font-size: 11px;
          max-width: 90%;
          white-space: normal;
          text-align: center;
        }
      }

      /* Auth overlay (simple) */
      #auth-overlay {
        position: fixed;
        inset: 0;
        background: rgba(2, 6, 23, 0.92);
        z-index: 9999;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 16px;
      }

      #auth-overlay.open {
        display: flex;
      }

      #auth-overlay input {
        width: min(340px, 92vw);
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid #1f2937;
        background: #020617;
        color: var(--text);
        font-size: 12px;
      }

      #auth-overlay button {
        width: min(340px, 92vw);
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid #1f2937;
        background: rgba(15, 23, 42, 0.95);
        color: #e5e7eb;
        font-size: 12px;
        font-weight: 800;
        cursor: pointer;
      }

      #auth-overlay button.primary {
        background: #22c55e;
        color: #020617;
        border-color: transparent;
      }
    </style>
  </head>

  <body>
    <div class="app-shell">
      <header>
        <div class="header-left">
          <div class="logo-group" id="logo-group">
            <button id="app-logo-button" class="logo-button">
              <span class="logo">BEFORETHEBET</span>
              <span class="logo-caret">‚ñæ</span>
            </button>
            <div id="sports-menu" class="sports-menu"></div>
          </div>
          <button id="back-to-sports">‚Üê Back</button>
        </div>

        <div class="user-menu-wrapper" id="user-menu-wrapper">
          <button class="menu-placeholder" id="user-menu-button">
            <span id="user-menu-label">MyBias</span>
            <span>‚ñæ</span>
          </button>
          <div class="user-dropdown" id="user-dropdown"></div>
        </div>
      </header>

      <main>
        <div class="content">
          <div class="title-block">
            <h1 id="main-title">Select Your Sport</h1>
            <p id="subtitle">One card at a time. Swipe your stance.</p>
            <div class="directions" id="directions">
              Tap <strong>center</strong> to flip. Tap <strong>right edge</strong> for
              next, <strong>left edge</strong> for previous. Double-click center
              to open deeper views.
            </div>
          </div>

          <div class="card-container">
            <div class="card-click-area" id="card-click-area">
              <div class="stack-card stack-3"></div>
              <div class="stack-card stack-2"></div>
              <div class="stack-card stack-1"></div>

              <div class="card card-main" id="sport-card">
                <!-- FRONT -->
                <div class="card-face card-front" id="card-front">
                  <div class="sport-logo-circle" id="sport-logo"></div>
                  <div class="sport-front-name" id="sport-name"></div>
                  <div class="sport-front-code" id="sport-code"></div>
                  <div class="tap-hint" id="tap-hint-front">Tap center to flip ‚Üª</div>
                  <div class="index-indicator" id="index-indicator"></div>
                </div>

                <!-- BACK -->
                <div class="card-face card-back" id="card-back">
                  <div class="back-header">
                    <div class="back-title" id="back-title"></div>
                    <div class="back-sub" id="back-sub"></div>
                  </div>

                  <div class="matchups-list" id="matchups-list"></div>

                  <div class="back-footer-note" id="back-footer-note">
                    <span style="font-weight:800;color:#cbd5e1;">MyBias</span> starts at
                    <span style="font-weight:800;color:#60a5fa;">50/50</span> (blue).
                    After <span style="font-weight:800;">5</span> of <em>your</em> swipes,
                    community bias appears (green).
                  </div>

                  <div class="tap-hint" id="tap-hint-back">Double-click to flip ‚Ü∫</div>
                  <div class="index-indicator" id="index-indicator-back"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <footer>BeforeTheBet ‚Ä¢ Demo MVP</footer>
    </div>

    <!-- AUTH OVERLAY -->
    <div id="auth-overlay">
      <div style="font-size:14px;font-weight:900;letter-spacing:.12em;text-transform:uppercase;color:#cbd5e1;">
        Sign In
      </div>
      <input id="email" type="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <button id="signInBtn" class="primary" type="button">Sign In</button>
      <button id="signUpBtn" type="button">Create Account</button>
      <button id="auth-skip" type="button">Skip</button>
    </div>

    <!-- HOLD-TO-CHANGE MODAL -->
    <div class="modal-overlay" id="hold-modal">
      <div class="modal-card">
        <div class="modal-title">Change your bias?</div>
        <div class="modal-sub" id="hold-modal-sub"></div>
        <div class="modal-actions">
          <button id="hold-cancel">Cancel</button>
          <button id="hold-confirm" class="primary">Yes, flip it</button>
        </div>
      </div>
    </div>

    <div class="swipe-toast" id="swipe-toast"></div>

    <!-- SUPABASE -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      /* =========================
         0) CORE DATA + STATE
         ========================= */

      const SWIPE_GATE_COUNT = 5; // after your 5 swipes -> show community bias

      const SPORTS = [
        {
          id: "nfl",
          name: "NFL",
          code: "National Football League",
          logoClass: "sport-logo-nfl",
          emoji: "üèà",
          matchups: [
            {
              name: "Chiefs @ Bills",
              lines: [
                { label: "Mahomes o1.5 Passing TDs", category: "props", sharp: 68, sweep: 32, book: "FanDuel" },
                { label: "Allen o36.5 Rush Yards", category: "props", sharp: 57, sweep: 43, book: "DraftKings" },
                { label: "Kelce o6.5 Receptions", category: "props", sharp: 61, sweep: 39, book: "BetMGM" },
                { label: "Total Points o51.5", category: "total", sharp: 54, sweep: 46, book: "Caesars" },
                { label: "Chiefs -2.5", category: "spread", sharp: 52, sweep: 48, book: "ESPN BET" },
              ],
            },
            {
              name: "Eagles @ Cowboys",
              lines: [
                { label: "Hurts o44.5 Rush Yards", category: "props", sharp: 55, sweep: 45, book: "FanDuel" },
                { label: "Lamb o7.5 Targets", category: "props", sharp: 60, sweep: 40, book: "DraftKings" },
                { label: "Eagles +3.5", category: "spread", sharp: 58, sweep: 42, book: "BetMGM" },
                { label: "Total o48.5", category: "total", sharp: 51, sweep: 49, book: "Caesars" },
                { label: "Hurts 2+ Pass TDs", category: "props", sharp: 49, sweep: 51, book: "ESPN BET" },
              ],
            },
          ],
        },
        {
          id: "nba",
          name: "NBA",
          code: "National Basketball Association",
          logoClass: "sport-logo-nba",
          emoji: "üèÄ",
          matchups: [
            {
              name: "Lakers @ Warriors",
              lines: [
                { label: "LeBron o26.5 Points", category: "points", sharp: 61, sweep: 39, book: "FanDuel" },
                { label: "Curry o4.5 3PM", category: "points", sharp: 64, sweep: 36, book: "DraftKings" },
                { label: "Total o236.5", category: "total", sharp: 52, sweep: 48, book: "BetMGM" },
                { label: "Warriors -3.5", category: "spread", sharp: 49, sweep: 51, book: "Caesars" },
                { label: "Reaves o3.5 Assists", category: "props", sharp: 55, sweep: 45, book: "ESPN BET" },
              ],
            },
            {
              name: "Celtics @ Knicks",
              lines: [
                { label: "Tatum o3.5 3PM", category: "points", sharp: 49, sweep: 51, book: "FanDuel" },
                { label: "Brunson o24.5 Pts", category: "points", sharp: 56, sweep: 44, book: "DraftKings" },
                { label: "Total u224.5", category: "total", sharp: 51, sweep: 49, book: "BetMGM" },
                { label: "Celtics -4.5", category: "spread", sharp: 58, sweep: 42, book: "Caesars" },
                { label: "Randle o9.5 Reb", category: "props", sharp: 53, sweep: 47, book: "ESPN BET" },
              ],
            },
          ],
        },
      ];

      let mode = "sports"; // sports | matchups | allLines | lineDetails | mybias | locks
      let currentSportIndex = 0;
      let currentMatchupIndex = 0;
      let flipped = false;

      let previousModeBeforeLineDetails = null;
      let currentLineDetailMeta = null;

      let clickTimeout = null;
      const DOUBLE_CLICK_DELAY = 250;

      // user state
      let currentUser = null;
      let userSwipeCount = 0; // gate for showing community bias

      // Store per-line user decision + status
      // key => { vote: 'confident'|'doubt', status:'inbox'|'lock'|'archived', meta, createdAt, lastUpdated }
      const myBiasStore = {};

      /* =========================
         1) DOM HOOKS
         ========================= */
      const cardEl = document.getElementById("sport-card");
      const cardClickArea = document.getElementById("card-click-area");

      const logoEl = document.getElementById("sport-logo");
      const nameEl = document.getElementById("sport-name");
      const codeEl = document.getElementById("sport-code");
      const tapHintFrontEl = document.getElementById("tap-hint-front");
      const tapHintBackEl = document.getElementById("tap-hint-back");

      const indexIndicatorFront = document.getElementById("index-indicator");
      const indexIndicatorBack = document.getElementById("index-indicator-back");

      const backTitleEl = document.getElementById("back-title");
      const backSubEl = document.getElementById("back-sub");
      const matchupsListEl = document.getElementById("matchups-list");

      const titleEl = document.getElementById("main-title");
      const subtitleEl = document.getElementById("subtitle");
      const directionsEl = document.getElementById("directions");
      const backToSportsBtn = document.getElementById("back-to-sports");

      const sportsMenuEl = document.getElementById("sports-menu");
      const appLogoButton = document.getElementById("app-logo-button");
      const logoGroup = document.getElementById("logo-group");

      const userMenuButton = document.getElementById("user-menu-button");
      const userMenuLabel = document.getElementById("user-menu-label");
      const userDropdown = document.getElementById("user-dropdown");
      const userMenuWrapper = document.getElementById("user-menu-wrapper");

      const swipeToastEl = document.getElementById("swipe-toast");

      // auth
      const authOverlay = document.getElementById("auth-overlay");
      const signInBtn = document.getElementById("signInBtn");
      const signUpBtn = document.getElementById("signUpBtn");
      const authSkipBtn = document.getElementById("auth-skip");

      // hold-to-change modal
      const holdModal = document.getElementById("hold-modal");
      const holdModalSub = document.getElementById("hold-modal-sub");
      const holdCancel = document.getElementById("hold-cancel");
      const holdConfirm = document.getElementById("hold-confirm");

      let holdPendingKey = null;

      /* =========================
         2) UTIL
         ========================= */
      function getNextIndex(length, current) {
        return (current + 1) % length;
      }
      function getPrevIndex(length, current) {
        return current === 0 ? length - 1 : current - 1;
      }
      function currentSport() {
        return SPORTS[currentSportIndex];
      }
      function currentMatchup() {
        return currentSport().matchups[currentMatchupIndex];
      }

      function showToast(msg) {
        swipeToastEl.textContent = msg;
        swipeToastEl.classList.add("show");
        clearTimeout(swipeToastEl._hideTimeout);
        swipeToastEl._hideTimeout = setTimeout(() => {
          swipeToastEl.classList.remove("show");
        }, 1100);
      }

      function keyForMeta(meta) {
        const sport = SPORTS[meta.sportIndex];
        const matchup = sport.matchups[meta.matchupIndex];
        const book = meta.book || "Consensus";
        return `${sport.id}|${matchup.name}|${meta.label}|${book}`;
      }

      function renderCardFlipState() {
        if (flipped) cardEl.classList.add("flipped");
        else cardEl.classList.remove("flipped");
      }

      /* =========================
         3) MYBIAS / COMMUNITY BIAS LOGIC
         ========================= */
      function shouldShowCommunityBias() {
        return userSwipeCount >= SWIPE_GATE_COUNT;
      }

      // returns {leftPct, rightPct, style:'blue'|'green'}
      // IMPORTANT: left = DOUBT, right = CONFIDENT
      function getBiasDisplay(meta, communitySharpPct, communitySweepPct) {
        // Before gate: 50/50 blue
        if (!shouldShowCommunityBias()) {
          return { leftPct: 50, rightPct: 50, style: "blue" };
        }
        // After gate: use community but map:
        // In old data: sharp=right, sweep=left
        // We now want: confident=right, doubt=left
        const rightPct = typeof communitySharpPct === "number" ? communitySharpPct : 50; // confident
        const leftPct = typeof communitySweepPct === "number" ? communitySweepPct : 50; // doubt
        return { leftPct, rightPct, style: "green" };
      }

      function buildBiasUI(meta, communitySharpPct, communitySweepPct) {
        const bias = getBiasDisplay(meta, communitySharpPct, communitySweepPct);

        const wrap = document.createElement("div");
        wrap.className = "bias-container";

        const bg = document.createElement("div");
        bg.className = "bias-bar-bg";

        // Fill represents RIGHT side percentage (confident)
        const fill = document.createElement("div");
        fill.className = "bias-bar-fill " + (bias.style === "green" ? "green" : "blue");
        fill.style.width = `${bias.rightPct}%`;

        bg.appendChild(fill);

        const labels = document.createElement("div");
        labels.className = "bias-labels";

        const left = document.createElement("span");
        left.textContent = `Doubt ${bias.leftPct}%`;

        const right = document.createElement("span");
        right.textContent = `Confident ${bias.rightPct}%`;

        labels.appendChild(left);
        labels.appendChild(right);

        wrap.appendChild(bg);
        wrap.appendChild(labels);

        return wrap;
      }

      /* =========================
         4) SWIPE + HOLD CONTROL (PER LINE)
         ========================= */

      function openHoldModalForKey(key, label) {
        holdPendingKey = key;
        holdModalSub.textContent =
          `You already picked "${myBiasStore[key]?.vote || "a side"}" for:\n\n${label}\n\nFlip your bias for THIS ONE line?`;
        holdModal.classList.add("open");
      }

      function closeHoldModal() {
        holdPendingKey = null;
        holdModal.classList.remove("open");
      }

      holdCancel.addEventListener("click", () => closeHoldModal());
      holdModal.addEventListener("click", (e) => {
        if (e.target === holdModal) closeHoldModal();
      });

      holdConfirm.addEventListener("click", () => {
        if (!holdPendingKey || !myBiasStore[holdPendingKey]) {
          closeHoldModal();
          return;
        }
        // flip just this one line
        myBiasStore[holdPendingKey].vote =
          myBiasStore[holdPendingKey].vote === "confident" ? "doubt" : "confident";
        myBiasStore[holdPendingKey].lastUpdated = Date.now();

        showToast(`Bias flipped: ${myBiasStore[holdPendingKey].vote === "confident" ? "Confident ‚úÖ" : "Doubt ü§î"}`);
        closeHoldModal();
        renderScreen(); // update only view
      });

      function recordMyBias(meta, vote, status) {
        const key = keyForMeta(meta);
        const now = Date.now();

        if (!myBiasStore[key]) {
          myBiasStore[key] = {
            key,
            meta: { ...meta },
            vote, // 'confident' | 'doubt'
            status: status || "inbox",
            createdAt: now,
            lastUpdated: now,
          };
        } else {
          // If it already exists, don't overwrite automatically by swipe.
          // Users must hold-to-change.
          return { key, existed: true };
        }

        // Count only if it is the FIRST time this user swiped that specific line
        userSwipeCount += 1;
        return { key, existed: false };
      }

      function setAnsweredVisual(cardEl) {
        cardEl.classList.add("is-answered");
        cardEl.dataset.answered = "1";
      }

      function moveCardToBottom(cardEl) {
        // move to bottom of list after swipe
        const parent = cardEl.parentElement;
        if (!parent) return;
        parent.appendChild(cardEl);
      }

      function attachSwipeAndHoldToLineCard(card, meta, context) {
        let startX = null;
        let pointerDown = false;

        let holdTimer = null;
        const HOLD_MS = 700;

        // dblclick => open details
        card.addEventListener("dblclick", (e) => {
          e.stopPropagation();
          openLineDetails(meta);
        });

        card.addEventListener("pointerdown", (e) => {
          pointerDown = true;
          startX = e.clientX;

          // hold-to-change ONLY if already answered (exists in store)
          const key = keyForMeta(meta);
          if (myBiasStore[key]) {
            holdTimer = setTimeout(() => {
              openHoldModalForKey(key, meta.label);
            }, HOLD_MS);
          }
        });

        card.addEventListener("pointermove", (e) => {
          if (!pointerDown) return;
          const dx = Math.abs(e.clientX - startX);
          if (dx > 10 && holdTimer) {
            clearTimeout(holdTimer);
            holdTimer = null;
          }
        });

        card.addEventListener("pointerup", (e) => {
          if (!pointerDown) return;
          pointerDown = false;

          if (holdTimer) {
            clearTimeout(holdTimer);
            holdTimer = null;
          }

          // if already answered, swipes do nothing (must hold-to-change)
          const existingKey = keyForMeta(meta);
          if (myBiasStore[existingKey]) {
            showToast("Hold to change bias on this line");
            return;
          }

          const dx = e.clientX - startX;
          const threshold = 40;
          if (Math.abs(dx) < threshold) return;

          e.stopPropagation();

          const direction = dx > 0 ? "right" : "left";
          // Right = Confident, Left = Doubt
          const vote = direction === "right" ? "confident" : "doubt";

          // MyBias page: swipe right -> lock, left -> archive
          // Elsewhere: always goes into MyBias inbox
          let status = "inbox";
          if (context === "mybias") {
            status = direction === "right" ? "lock" : "archived";
          }

          const res = recordMyBias(meta, vote, status);
          if (res.existed) return;

          showToast(vote === "confident" ? `Confident ‚úÖ ‚Äî ${meta.label}` : `Doubt ü§î ‚Äî ${meta.label}`);

          // animate off then disable + move to bottom
          card.classList.add(direction === "right" ? "swipe-right" : "swipe-left");

          setTimeout(() => {
            card.classList.remove("swipe-right", "swipe-left");
            setAnsweredVisual(card);
            moveCardToBottom(card);
            // do NOT flip main card; do NOT change flipped state
          }, 180);

          // after 5 swipes, refresh so community bias appears green
          if (shouldShowCommunityBias()) {
            setTimeout(() => renderScreen(), 220);
          }
        });

        card.addEventListener("pointercancel", () => {
          pointerDown = false;
          if (holdTimer) clearTimeout(holdTimer);
          holdTimer = null;
        });
      }

      /* =========================
         5) LINE DETAILS (PLACEHOLDER)
         ========================= */
      function openLineDetails(meta) {
        previousModeBeforeLineDetails = mode === "lineDetails" ? previousModeBeforeLineDetails : mode;
        currentLineDetailMeta = meta;
        mode = "lineDetails";
        flipped = true;
        renderScreen();
      }

      function renderLineDetailsFront() {
        const sport = SPORTS[currentLineDetailMeta.sportIndex];
        logoEl.className = "sport-logo-circle " + sport.logoClass;
        logoEl.textContent = "üìà";
        nameEl.textContent = "Line Details";
        codeEl.textContent = sport.name + " ‚Ä¢ " + currentSport().matchups[currentLineDetailMeta.matchupIndex].name;
        tapHintFrontEl.textContent = "Double-click to go back ‚Ü∫";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderLineDetailsBack() {
        const sport = SPORTS[currentLineDetailMeta.sportIndex];
        const matchup = sport.matchups[currentLineDetailMeta.matchupIndex];
        const label = currentLineDetailMeta.label;

        backTitleEl.textContent = "Line Details (Placeholder)";
        backSubEl.textContent = label;

        matchupsListEl.innerHTML = "";

        const card = document.createElement("div");
        card.className = "matchup-card";

        const t = document.createElement("div");
        t.className = "matchup-label";
        t.textContent = label;

        const p = document.createElement("div");
        p.className = "matchup-line";
        p.textContent = matchup.name + " ‚Ä¢ " + sport.name + " ‚Ä¢ " + (currentLineDetailMeta.book || "Consensus");

        const s1 = document.createElement("div");
        s1.className = "stat-row";
        s1.innerHTML = "<span>Last 10 Avg</span><span>+0.8 vs line</span>";

        const s2 = document.createElement("div");
        s2.className = "stat-row";
        s2.innerHTML = "<span>Season Cover Rate</span><span>61%</span>";

        const s3 = document.createElement("div");
        s3.className = "stat-row";
        s3.innerHTML = "<span>Injury / News</span><span>None (demo)</span>";

        const s4 = document.createElement("div");
        s4.className = "stat-row";
        s4.innerHTML = "<span>Model Lean</span><span>Lean Over (demo)</span>";

        const note = document.createElement("div");
        note.className = "matchup-line";
        note.style.marginTop = "8px";
        note.textContent =
          "Placeholder stats. Later you‚Äôll tell me exactly which data to render here (splits, odds history, injury feed, etc.).";

        card.appendChild(t);
        card.appendChild(p);
        card.appendChild(s1);
        card.appendChild(s2);
        card.appendChild(s3);
        card.appendChild(s4);
        card.appendChild(note);

        matchupsListEl.appendChild(card);
      }

      /* =========================
         6) RENDERERS
         ========================= */
      function renderSportsFront() {
        const sport = currentSport();
        logoEl.className = "sport-logo-circle " + sport.logoClass;
        logoEl.textContent = sport.emoji;
        nameEl.textContent = sport.name;
        codeEl.textContent = sport.code;
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";

        const idx = `${currentSportIndex + 1} / ${SPORTS.length}`;
        indexIndicatorFront.textContent = idx;
        indexIndicatorBack.textContent = idx;
      }

      function renderSportsBack() {
        const sport = currentSport();
        backTitleEl.textContent = `${sport.name} ‚Äì Matchups`;
        backSubEl.textContent = "Double-click a matchup to open All Lines.";
        matchupsListEl.innerHTML = "";

        sport.matchups.forEach((matchup, mIndex) => {
          const topLine = matchup.lines[0] || { label: "Top line", sharp: 50, sweep: 50, book: "Consensus" };

          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = matchup.name;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = topLine.label;

          left.appendChild(label);
          left.appendChild(line);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = topLine.book || "Consensus";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);
          card.appendChild(
            buildBiasUI(
              {
                sportIndex: currentSportIndex,
                matchupIndex: mIndex,
                label: topLine.label,
                category: topLine.category || "other",
                book: topLine.book,
              },
              topLine.sharp,
              topLine.sweep
            )
          );

          // swipe on matchup preview line = counts as line bias too (optional)
          attachSwipeAndHoldToLineCard(
            card,
            {
              sportIndex: currentSportIndex,
              matchupIndex: mIndex,
              label: topLine.label,
              category: topLine.category || "other",
              book: topLine.book,
              sharp: topLine.sharp,
              sweep: topLine.sweep,
            },
            "sportsPreview"
          );

          card.addEventListener("dblclick", (e) => {
            e.stopPropagation();
            mode = "allLines";
            currentMatchupIndex = mIndex;
            flipped = true;
            renderScreen();
          });

          matchupsListEl.appendChild(card);
        });
      }

      function renderMatchupsFront() {
        const sport = currentSport();
        const matchup = currentMatchup();

        logoEl.className = "sport-logo-circle " + sport.logoClass;
        logoEl.textContent = sport.emoji;
        nameEl.textContent = matchup.name;
        codeEl.textContent = sport.name;
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";

        const idx = `${currentMatchupIndex + 1} / ${sport.matchups.length}`;
        indexIndicatorFront.textContent = idx;
        indexIndicatorBack.textContent = idx;
      }

      function renderMatchupsBack() {
        const sport = currentSport();
        const matchup = currentMatchup();

        backTitleEl.textContent = `${sport.name} ‚Äì Top Lines`;
        backSubEl.textContent = "Swipe right = Confident ‚Ä¢ left = Doubt ‚Ä¢ double-click = details.";
        matchupsListEl.innerHTML = "";

        const linesToShow = matchup.lines.slice(0, 6);

        linesToShow.forEach((ln) => {
          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");

          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = ln.label;

          const gameLine = document.createElement("div");
          gameLine.className = "matchup-line";
          gameLine.textContent = matchup.name;

          left.appendChild(label);
          left.appendChild(gameLine);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = ln.book || "Consensus";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);
          card.appendChild(
            buildBiasUI(
              {
                sportIndex: currentSportIndex,
                matchupIndex: currentMatchupIndex,
                label: ln.label,
                category: ln.category || "other",
                book: ln.book,
              },
              ln.sharp,
              ln.sweep
            )
          );

          attachSwipeAndHoldToLineCard(
            card,
            {
              sportIndex: currentSportIndex,
              matchupIndex: currentMatchupIndex,
              label: ln.label,
              category: ln.category || "other",
              book: ln.book,
              sharp: ln.sharp,
              sweep: ln.sweep,
            },
            "matchupsTop"
          );

          // if already answered, disable visual
          const k = keyForMeta({
            sportIndex: currentSportIndex,
            matchupIndex: currentMatchupIndex,
            label: ln.label,
            book: ln.book,
          });
          if (myBiasStore[k]) setAnsweredVisual(card);

          matchupsListEl.appendChild(card);
        });
      }

      function renderAllLinesBack() {
        const sport = currentSport();
        const matchup = currentMatchup();

        backTitleEl.textContent = `${sport.name} ‚Äì All Lines`;
        backSubEl.textContent = matchup.name;
        matchupsListEl.innerHTML = "";

        matchup.lines.forEach((ln) => {
          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = ln.label;

          const gameLine = document.createElement("div");
          gameLine.className = "matchup-line";
          gameLine.textContent = matchup.name;

          left.appendChild(label);
          left.appendChild(gameLine);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = ln.book || "Consensus";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);
          card.appendChild(
            buildBiasUI(
              {
                sportIndex: currentSportIndex,
                matchupIndex: currentMatchupIndex,
                label: ln.label,
                category: ln.category || "other",
                book: ln.book,
              },
              ln.sharp,
              ln.sweep
            )
          );

          attachSwipeAndHoldToLineCard(
            card,
            {
              sportIndex: currentSportIndex,
              matchupIndex: currentMatchupIndex,
              label: ln.label,
              category: ln.category || "other",
              book: ln.book,
              sharp: ln.sharp,
              sweep: ln.sweep,
            },
            "allLines"
          );

          const k = keyForMeta({
            sportIndex: currentSportIndex,
            matchupIndex: currentMatchupIndex,
            label: ln.label,
            book: ln.book,
          });
          if (myBiasStore[k]) setAnsweredVisual(card);

          matchupsListEl.appendChild(card);
        });
      }

      function renderMyBiasFront() {
        logoEl.className = "sport-logo-circle sport-logo-nba";
        logoEl.textContent = "üß†";
        nameEl.textContent = "MyBias";
        codeEl.textContent = "Your swiped lines (hold to change)";
        tapHintFrontEl.textContent = "Double-click to flip ‚Üª";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function getMyBiasItemsByStatus(status) {
        return Object.values(myBiasStore)
          .filter((x) => x.status === status)
          .sort((a, b) => (b.lastUpdated || 0) - (a.lastUpdated || 0));
      }

      function renderMyBiasBack() {
        backTitleEl.textContent = "MyBias";
        backSubEl.textContent = "Swipe right = Lock ‚Ä¢ Swipe left = Archive ‚Ä¢ Hold = Change bias.";
        matchupsListEl.innerHTML = "";

        const inbox = getMyBiasItemsByStatus("inbox");

        if (inbox.length === 0) {
          const empty = document.createElement("div");
          empty.className = "matchup-card";
          const t = document.createElement("div");
          t.className = "matchup-label";
          t.textContent = "No MyBias lines yet";
          const p = document.createElement("div");
          p.className = "matchup-line";
          p.textContent = "Swipe some lines in Matchups / All Lines. They will appear here.";
          empty.appendChild(t);
          empty.appendChild(p);
          matchupsListEl.appendChild(empty);
          return;
        }

        inbox.forEach((item) => {
          const meta = item.meta;
          const sport = SPORTS[meta.sportIndex];
          const matchup = sport.matchups[meta.matchupIndex];

          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = meta.label;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = `${matchup.name} ‚Ä¢ ${sport.name} ‚Ä¢ Your pick: ${
            item.vote === "confident" ? "Confident ‚úÖ" : "Doubt ü§î"
          }`;

          left.appendChild(label);
          left.appendChild(line);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = meta.book || "Consensus";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);
          // show bias bar (community after gate, else 50/50)
          card.appendChild(buildBiasUI(meta, meta.sharp, meta.sweep));

          // Here: swipe right => lock, left => archive
          attachSwipeAndHoldToLineCard(card, meta, "mybias");

          matchupsListEl.appendChild(card);
        });
      }

      function renderLocksFront() {
        logoEl.className = "sport-logo-circle sport-logo-nfl";
        logoEl.textContent = "üîí";
        nameEl.textContent = "My Locks";
        codeEl.textContent = "Lines you locked";
        tapHintFrontEl.textContent = "Double-click to flip ‚Üª";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderLocksBack() {
        backTitleEl.textContent = "My Locks";
        backSubEl.textContent = "Hold any locked line to flip your bias (only that line).";
        matchupsListEl.innerHTML = "";

        const locks = getMyBiasItemsByStatus("lock");

        if (locks.length === 0) {
          const empty = document.createElement("div");
          empty.className = "matchup-card";
          const t = document.createElement("div");
          t.className = "matchup-label";
          t.textContent = "No locks yet";
          const p = document.createElement("div");
          p.className = "matchup-line";
          p.textContent = "Go to MyBias and swipe right to Lock lines.";
          empty.appendChild(t);
          empty.appendChild(p);
          matchupsListEl.appendChild(empty);
          return;
        }

        locks.forEach((item) => {
          const meta = item.meta;
          const sport = SPORTS[meta.sportIndex];
          const matchup = sport.matchups[meta.matchupIndex];

          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = meta.label;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = `${matchup.name} ‚Ä¢ ${sport.name} ‚Ä¢ Your pick: ${
            item.vote === "confident" ? "Confident ‚úÖ" : "Doubt ü§î"
          }`;

          left.appendChild(label);
          left.appendChild(line);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = meta.book || "Consensus";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);
          card.appendChild(buildBiasUI(meta, meta.sharp, meta.sweep));

          // locked lines cannot be swiped here; but can hold to change bias
          attachSwipeAndHoldToLineCard(card, meta, "locks");

          matchupsListEl.appendChild(card);
        });
      }

      /* =========================
         7) SCREEN ROUTER
         ========================= */
      function renderScreen() {
        if (mode === "sports") {
          titleEl.textContent = "Select Your Sport";
          subtitleEl.textContent = "Tap center to flip. Explore matchups.";
          directionsEl.innerHTML =
            "Tap <strong>center</strong> to flip. Tap <strong>right</strong> for next sport, <strong>left</strong> for previous. Double-click a matchup to open All Lines.";
          backToSportsBtn.style.display = "none";

          renderSportsFront();
          renderSportsBack();
        }

        if (mode === "matchups") {
          const sport = currentSport();
          titleEl.textContent = sport.name + " Matchups";
          subtitleEl.textContent = "Swipe lines: Confident (right) / Doubt (left).";
          directionsEl.innerHTML =
            "Tap <strong>center</strong> to flip. Double-click center to open All Lines. Swiping does <strong>not</strong> flip you back.";
          backToSportsBtn.style.display = "inline-flex";

          renderMatchupsFront();
          renderMatchupsBack();
        }

        if (mode === "allLines") {
          const sport = currentSport();
          titleEl.textContent = sport.name + " ‚Äì All Lines";
          subtitleEl.textContent = currentMatchup().name;
          directionsEl.innerHTML =
            "<strong>Single-click the front</strong> changes the game. <strong>Double-click</strong> flips to show all lines. Swiping does <strong>not</strong> flip you back.";
          backToSportsBtn.style.display = "inline-flex";

          // Front is matchup name already (renderMatchupsFront), back is all lines
          renderMatchupsFront();
          renderAllLinesBack();
        }

        if (mode === "lineDetails") {
          titleEl.textContent = "Line Details";
          subtitleEl.textContent = "Placeholder stats view";
          directionsEl.innerHTML =
            "Double-click center to go back.";
          backToSportsBtn.style.display = "inline-flex";
          renderLineDetailsFront();
          renderLineDetailsBack();
        }

        if (mode === "mybias") {
          titleEl.textContent = "MyBias";
          subtitleEl.textContent = "Your swiped lines";
          directionsEl.innerHTML =
            "Swipe right on MyBias to Lock ‚Ä¢ swipe left to Archive (coming next). Hold any line to change only that line.";
          backToSportsBtn.style.display = "inline-flex";

          renderMyBiasFront();
          renderMyBiasBack();
          flipped = true;
        }

        if (mode === "locks") {
          titleEl.textContent = "My Locks";
          subtitleEl.textContent = "Locked lines";
          directionsEl.innerHTML =
            "Hold any line to change only that line‚Äôs bias. Double-click a line for Line Details.";
          backToSportsBtn.style.display = "inline-flex";

          renderLocksFront();
          renderLocksBack();
          flipped = true;
        }

        renderCardFlipState();
      }

      function handleGlobalBack() {
        if (mode === "lineDetails" && previousModeBeforeLineDetails) {
          mode = previousModeBeforeLineDetails;
          flipped = true;
          renderScreen();
          return;
        }

        if (mode === "allLines") {
          mode = "matchups";
          flipped = false; // return to matchup front
          renderScreen();
          return;
        }

        if (mode === "matchups" || mode === "mybias" || mode === "locks") {
          mode = "sports";
          flipped = false;
          renderScreen();
          return;
        }
      }

      backToSportsBtn.addEventListener("click", () => handleGlobalBack());

      /* =========================
         8) CLICK / DOUBLE CLICK
         ========================= */

      function handleSingleClick(e) {
        const rect = cardClickArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const zone = x / rect.width;

        // in line details, any click acts as back
        if (mode === "lineDetails") {
          handleGlobalBack();
          return;
        }

        // All Lines special rule:
        // Single click on FRONT should change game and NOT flip.
        // We interpret "center click" as next game.
        if (mode === "allLines" && !flipped && zone >= 0.2 && zone <= 0.8) {
          currentMatchupIndex = getNextIndex(currentSport().matchups.length, currentMatchupIndex);
          // keep flipped false
          renderScreen();
          return;
        }

        // For MyBias/Locks: center flip only (but do not auto flip on swipe anyway)
        if ((mode === "mybias" || mode === "locks") && zone >= 0.2 && zone <= 0.8) {
          flipped = !flipped;
          renderCardFlipState();
          return;
        }

        // normal edge nav
        if (zone < 0.2) {
          if (mode === "sports") {
            currentSportIndex = getPrevIndex(SPORTS.length, currentSportIndex);
          } else if (mode === "matchups" || mode === "allLines") {
            currentMatchupIndex = getPrevIndex(currentSport().matchups.length, currentMatchupIndex);
          }
          // do not force flip changes here except in sports/matchups; keep current flipped unless switching sports
          if (mode === "sports") flipped = false;
          renderScreen();
          return;
        }

        if (zone > 0.8) {
          if (mode === "sports") {
            currentSportIndex = getNextIndex(SPORTS.length, currentSportIndex);
          } else if (mode === "matchups" || mode === "allLines") {
            currentMatchupIndex = getNextIndex(currentSport().matchups.length, currentMatchupIndex);
          }
          if (mode === "sports") flipped = false;
          renderScreen();
          return;
        }

        // center click behavior
        // IMPORTANT CHANGE YOU ASKED: once flipped and lines are showing, it stays flipped
        // so center click should NOT auto toggle flip except on sports/matchups previews.
        if (mode === "sports") {
          flipped = !flipped;
          renderCardFlipState();
          return;
        }

        if (mode === "matchups") {
          // allow center click to flip manually, but do not auto flip on swipe (we do not)
          flipped = !flipped;
          renderCardFlipState();
          return;
        }

        if (mode === "allLines") {
          // If currently flipped (lines showing) single click does nothing (stay flipped)
          // If not flipped, single click already handled above (changes game)
          return;
        }
      }

      function handleDoubleClick(e) {
        const rect = cardClickArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const zone = x / rect.width;

        // double click center toggles flip
        if (zone >= 0.2 && zone <= 0.8) {
          // In sports -> go to matchups
          if (mode === "sports") {
            mode = "matchups";
            currentMatchupIndex = 0;
            flipped = false;
            renderScreen();
            return;
          }

          // In matchups -> go to allLines
          if (mode === "matchups") {
            mode = "allLines";
            flipped = false; // start on front so single click changes game
            renderScreen();
            return;
          }

          // In allLines -> flip to show/hide lines
          if (mode === "allLines") {
            flipped = !flipped;
            renderCardFlipState();
            return;
          }

          // In mybias/locks -> flip card
          if (mode === "mybias" || mode === "locks") {
            flipped = !flipped;
            renderCardFlipState();
            return;
          }

          // In lineDetails -> back
          if (mode === "lineDetails") {
            handleGlobalBack();
            return;
          }
        }

        // fallback: treat as single
        handleSingleClick(e);
      }

      cardClickArea.addEventListener("click", (e) => {
        if (clickTimeout) {
          clearTimeout(clickTimeout);
          clickTimeout = null;
          handleDoubleClick(e);
        } else {
          clickTimeout = setTimeout(() => {
            handleSingleClick(e);
            clickTimeout = null;
          }, DOUBLE_CLICK_DELAY);
        }
      });

      // Allow dblclick on card area to still work even with our timer
      cardClickArea.addEventListener("dblclick", (e) => {
        e.preventDefault();
      });

      /* =========================
         9) MENUS
         ========================= */
      function buildSportsMenu() {
        sportsMenuEl.innerHTML = "";

        SPORTS.forEach((sport, sIndex) => {
          const sportItem = document.createElement("div");
          sportItem.className = "sports-menu-item";

          const title = document.createElement("div");
          title.className = "sports-menu-item-title";
          title.textContent = sport.name;
          sportItem.appendChild(title);

          const gamesSub = document.createElement("div");
          gamesSub.className = "sports-games-submenu";

          sport.matchups.forEach((matchup, mIndex) => {
            const gameItem = document.createElement("div");
            gameItem.className = "game-item";
            gameItem.textContent = matchup.name;

            gameItem.addEventListener("click", (e) => {
              e.stopPropagation();
              currentSportIndex = sIndex;
              currentMatchupIndex = mIndex;
              mode = "allLines";
              flipped = false; // start front; double click to flip
              sportsMenuEl.classList.remove("open");
              renderScreen();
            });

            gamesSub.appendChild(gameItem);
          });

          sportItem.appendChild(gamesSub);
          sportsMenuEl.appendChild(sportItem);
        });
      }

      appLogoButton.addEventListener("click", (e) => {
        e.stopPropagation();
        sportsMenuEl.classList.toggle("open", !sportsMenuEl.classList.contains("open"));
      });

      function updateUserMenuLabel() {
        userMenuLabel.textContent = "MyBias";
      }

      function buildUserDropdown() {
        userDropdown.innerHTML = "";

        const myBiasItem = document.createElement("div");
        myBiasItem.className = "user-dropdown-item";
        myBiasItem.textContent = "MyBias";
        myBiasItem.addEventListener("click", () => {
          mode = "mybias";
          flipped = true;
          userDropdown.classList.remove("open");
          renderScreen();
        });
        userDropdown.appendChild(myBiasItem);

        const locksItem = document.createElement("div");
        locksItem.className = "user-dropdown-item";
        locksItem.textContent = "My Locks";
        locksItem.addEventListener("click", () => {
          mode = "locks";
          flipped = true;
          userDropdown.classList.remove("open");
          renderScreen();
        });
        userDropdown.appendChild(locksItem);

        const sep = document.createElement("div");
        sep.className = "user-dropdown-separator";
        userDropdown.appendChild(sep);

        const authItem = document.createElement("div");
        authItem.className = "user-dropdown-item";
        authItem.textContent = currentUser ? "Sign out" : "Sign in";
        authItem.addEventListener("click", () => {
          userDropdown.classList.remove("open");
          if (currentUser) {
            currentUser = null;
            showToast("Signed out");
            authOverlay.classList.add("open");
          } else {
            authOverlay.classList.add("open");
          }
        });
        userDropdown.appendChild(authItem);
      }

      userMenuButton.addEventListener("click", (e) => {
        e.stopPropagation();
        userDropdown.classList.toggle("open", !userDropdown.classList.contains("open"));
      });

      // close menus on outside click + bottom-left back
      document.addEventListener("click", (e) => {
        const target = e.target;

        const clickedCard = cardClickArea.contains(target);
        const clickedBack = backToSportsBtn.contains(target);
        const clickedUserMenu = userMenuWrapper.contains(target);
        const clickedLogoMenu = logoGroup.contains(target);
        const clickedAuth = authOverlay.contains(target);
        const clickedModal = holdModal.contains(target);

        if (!clickedLogoMenu) sportsMenuEl.classList.remove("open");
        if (!clickedUserMenu) userDropdown.classList.remove("open");

        if (clickedCard || clickedBack || clickedUserMenu || clickedLogoMenu || clickedAuth || clickedModal) return;

        const vw = window.innerWidth;
        const vh = window.innerHeight;
        const x = e.clientX;
        const y = e.clientY;

        if (x < vw * 0.25 && y > vh * 0.75) handleGlobalBack();
      });

      /* =========================
         10) AUTH (simple)
         ========================= */
      window.supabase = supabase.createClient(
        "https://kmgrpyvcxonfjswxusbt.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttZ3JweXZjeG9uZmpzd3h1c2J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NjE4NTIsImV4cCI6MjA4MTIzNzg1Mn0.teDypPoT-TMPkIDGemYVRfCNdmK0uAbOCDaiHfNmgac",
        { auth: { persistSession: true, autoRefreshToken: true } }
      );

      async function exitAuthAndEnterApp(source) {
        authOverlay.classList.remove("open");
        showToast(source === "skip" ? "Guest mode" : "Signed in");
        renderScreen();
      }

      authSkipBtn.addEventListener("click", (e) => {
        e.preventDefault();
        currentUser = { email: "guest@demo", id: "guest" };
        exitAuthAndEnterApp("skip");
      });

      signInBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        const email = (document.getElementById("email")?.value || "").trim();
        const password = document.getElementById("password")?.value || "";
        if (!email || !password) return alert("Enter email and password");

        const res = await window.supabase.auth.signInWithPassword({ email, password });
        if (res.error) return alert(res.error.message);

        const sess = await window.supabase.auth.getSession();
        if (!sess.data?.session) return alert("Signed in, but session missing.");

        currentUser = { email, id: sess.data.session.user.id };
        exitAuthAndEnterApp("signin");
      });

      signUpBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        const email = (document.getElementById("email")?.value || "").trim();
        const password = document.getElementById("password")?.value || "";
        if (!email || !password) return alert("Enter email and password");

        const res = await window.supabase.auth.signUp({ email, password });
        if (res.error) return alert(res.error.message);

        alert("Account created. Confirm email if required, then sign in.");
      });

      /* =========================
         11) INIT
         ========================= */
      function ensureAuthOpenIfNeeded() {
        // if you want it always open initially, enable next line:
        // authOverlay.classList.add("open");
        // for now, let user use immediately
      }

      buildSportsMenu();
      updateUserMenuLabel();
      buildUserDropdown();
      ensureAuthOpenIfNeeded();
      renderScreen();
    </script>
  </body>
</html>
