<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <title>BeforeTheBet ‚Äì Demo MVP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      /* =========================
         THEME (Light default)
         ========================= */
      :root {
        --bg: #f6f7fb;
        --card: #ffffff;
        --border: #e5e7eb;
        --text: #0f172a;
        --muted: #64748b;

        --accent: #16a34a; /* green */
        --accent2: #2563eb; /* blue */
        --danger: #ef4444;

        --shadow: 0 18px 40px rgba(15, 23, 42, 0.14);
        --shadowStrong: 0 26px 60px rgba(15, 23, 42, 0.18);
      }

      html[data-theme="dark"] {
        color-scheme: dark;
        --bg: #020617;
        --card: #020617;
        --border: #1e293b;
        --text: #e2e8f0;
        --muted: #94a3b8;

        --accent: #22c55e;
        --accent2: #3b82f6;
        --danger: #fb7185;

        --shadow: 0 18px 40px rgba(0, 0, 0, 0.55);
        --shadowStrong: 0 26px 60px rgba(0, 0, 0, 0.7);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, rgba(59, 130, 246, 0.12), var(--bg) 55%);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .app-shell {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header,
      footer {
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        border-bottom: 1px solid var(--border);
        backdrop-filter: blur(10px);
        background: color-mix(in srgb, var(--card) 88%, transparent);
        z-index: 10;
      }

      footer {
        border-top: 1px solid var(--border);
        border-bottom: none;
        justify-content: center;
        font-size: 11px;
        color: var(--muted);
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .logo-group {
        position: relative;
        display: flex;
        align-items: center;
      }

      .logo-button {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: transparent;
        cursor: pointer;
      }

      .logo-button:hover {
        border-color: var(--border);
        background: color-mix(in srgb, var(--card) 90%, transparent);
      }

      .logo {
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .logo-caret {
        font-size: 10px;
        color: var(--muted);
      }

      .sports-menu {
        position: absolute;
        top: 112%;
        left: 0;
        background: var(--card);
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: var(--shadowStrong);
        padding: 8px 0;
        min-width: 240px;
        display: none;
        z-index: 60;
      }

      .sports-menu.open {
        display: block;
      }

      .sports-menu-item {
        padding: 8px 12px;
        font-size: 12px;
        cursor: default;
      }

      .sports-menu-item:hover {
        background: color-mix(in srgb, var(--card) 70%, #0000);
      }

      .sports-menu-item-title {
        font-weight: 700;
        color: var(--text);
      }

      .sports-games-submenu {
        margin-top: 6px;
        margin-left: 4px;
        padding-left: 10px;
        border-left: 1px solid var(--border);
      }

      .game-item {
        font-size: 11px;
        color: var(--muted);
        padding: 4px 0;
        cursor: pointer;
      }

      .game-item:hover {
        color: var(--text);
      }

      #back-to-sports {
        display: none;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: color-mix(in srgb, var(--card) 92%, transparent);
        color: var(--muted);
        font-size: 11px;
        padding: 6px 12px;
        cursor: pointer;
      }

      #back-to-sports:hover {
        color: var(--text);
      }

      .user-menu-wrapper {
        position: relative;
      }

      .menu-placeholder {
        font-size: 11px;
        color: var(--muted);
        cursor: pointer;
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: transparent;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .menu-placeholder:hover {
        border-color: var(--border);
        color: var(--text);
        background: color-mix(in srgb, var(--card) 90%, transparent);
      }

      .user-dropdown {
        position: absolute;
        right: 0;
        top: 112%;
        background: var(--card);
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: var(--shadowStrong);
        min-width: 200px;
        padding: 6px 0;
        display: none;
        z-index: 60;
      }

      .user-dropdown.open {
        display: block;
      }

      .user-dropdown-item {
        padding: 8px 12px;
        font-size: 12px;
        cursor: pointer;
        color: var(--text);
        display: flex;
        justify-content: space-between;
        gap: 10px;
      }

      .user-dropdown-item:hover {
        background: color-mix(in srgb, var(--card) 70%, #0000);
      }

      .user-dropdown-separator {
        border-top: 1px solid var(--border);
        margin: 6px 0;
      }

      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: center;
        padding: 24px 16px;
      }

      .content {
        max-width: 960px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 24px;
        align-items: stretch;
      }

      .title-block {
        text-align: center;
      }

      .title-block h1 {
        font-size: 28px;
        margin: 0 0 8px;
      }

      .title-block p {
        margin: 0;
        font-size: 14px;
        color: var(--muted);
      }

      .title-block .directions {
        margin-top: 8px;
        font-size: 12px;
        color: var(--muted);
        line-height: 1.5;
      }

      @media (min-width: 768px) {
        .title-block h1 {
          font-size: 32px;
        }
        .title-block .directions {
          font-size: 13px;
        }
      }

      /* Card stack */
      .card-container {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .card-click-area {
        position: relative;
        width: 100%;
        max-width: 390px;
        aspect-ratio: 2.5 / 3.5;
        perspective: 1200px;
        cursor: pointer;
      }

      @media (min-width: 1024px) {
        .card-click-area {
          max-width: 430px;
        }
      }

      .card,
      .stack-card {
        position: absolute;
        inset: 0;
        border-radius: 24px;
        border: 1px solid var(--border);
        background: radial-gradient(circle at top, color-mix(in srgb, var(--card) 92%, var(--accent2) 8%), var(--card));
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .card-main {
        transform-style: preserve-3d;
        transition: transform 0.5s ease;
        z-index: 3;
      }

      .stack-card {
        pointer-events: none;
        opacity: 0.55;
        z-index: 0;
      }

      .stack-card.stack-1 {
        transform: translateY(10px) translateX(6px) scale(0.97);
      }

      .stack-card.stack-2 {
        transform: translateY(18px) translateX(10px) scale(0.94);
        opacity: 0.4;
      }

      .stack-card.stack-3 {
        transform: translateY(26px) translateX(14px) scale(0.9);
        opacity: 0.25;
      }

      .card-face {
        position: absolute;
        inset: 0;
        padding: 18px 16px 14px;
        display: flex;
        flex-direction: column;
        backface-visibility: hidden;
      }

      .card-front {
        align-items: center;
        text-align: center;
        justify-content: center;
        gap: 12px;
        transform: rotateY(0deg);
        transition: transform 0.5s ease;
      }

      .card-back {
        transform: rotateY(180deg);
        justify-content: flex-start;
        transition: transform 0.5s ease;
      }

      .card-main.flipped .card-front {
        transform: rotateY(-180deg);
      }

      .card-main.flipped .card-back {
        transform: rotateY(0deg);
      }

      .sport-logo-circle {
        width: 112px;
        height: 112px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 42px;
        box-shadow: var(--shadow);
        background: radial-gradient(circle at top left, color-mix(in srgb, var(--accent2) 40%, var(--card)), var(--card));
        border: 1px solid var(--border);
      }

      .sport-front-name {
        font-size: 18px;
        font-weight: 700;
        margin-top: 10px;
      }

      .sport-front-code {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: var(--muted);
        margin-top: 4px;
      }

      .tap-hint {
        position: absolute;
        bottom: 10px;
        right: 14px;
        font-size: 10px;
        color: var(--muted);
        pointer-events: none;
      }

      .index-indicator {
        position: absolute;
        bottom: 10px;
        left: 14px;
        font-size: 10px;
        color: var(--muted);
      }

      .back-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 8px;
        margin-bottom: 8px;
      }

      .back-title {
        font-size: 16px;
        font-weight: 800;
      }

      .back-sub {
        font-size: 11px;
        color: var(--muted);
        text-align: right;
      }

      .matchups-list {
        margin-top: 6px;
        flex: 1;
        overflow-y: auto;
        padding-right: 4px;
      }

      .matchup-card {
        border-radius: 18px;
        border: 1px solid var(--border);
        background: color-mix(in srgb, var(--card) 92%, transparent);
        padding: 10px 10px 8px;
        margin-bottom: 8px;
        position: relative;
        transition: transform 0.18s ease, opacity 0.18s ease, filter 0.18s ease;
        user-select: none;
      }

      .matchup-card.swipe-right {
        transform: translateX(40px);
        opacity: 0;
      }

      .matchup-card.swipe-left {
        transform: translateX(-40px);
        opacity: 0;
      }

      .matchup-card.is-saved {
        opacity: 0.55;
        filter: grayscale(0.3);
      }

      .matchup-card.is-saved::after {
        content: "Saved";
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 10px;
        color: var(--muted);
        border: 1px solid var(--border);
        padding: 3px 8px;
        border-radius: 999px;
        background: color-mix(in srgb, var(--card) 88%, transparent);
      }

      .matchup-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 6px;
        margin-bottom: 6px;
      }

      .matchup-label {
        font-size: 13px;
        font-weight: 800;
        color: var(--text);
      }

      .matchup-line {
        font-size: 11px;
        color: var(--muted);
        line-height: 1.25;
      }

      .matchup-tag {
        font-size: 11px;
        color: var(--muted);
        text-align: right;
        white-space: nowrap;
      }

      .sentiment-bar-container {
        margin-top: 6px;
      }

      .sentiment-bar-bg {
        height: 9px;
        border-radius: 999px;
        background: color-mix(in srgb, var(--card) 55%, var(--border));
        overflow: hidden;
        border: 1px solid var(--border);
      }

      /* fill color set inline: blue pre-5 swipes, green after */
      .sentiment-bar-fill {
        height: 100%;
        border-radius: 999px;
        transition: width 0.25s ease;
      }

      .sentiment-labels {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        margin-top: 4px;
      }

      .sentiment-labels span {
        font-weight: 800;
      }

      /* LEFT = Doubt it, RIGHT = Confident */
      .sentiment-labels span:first-child {
        color: color-mix(in srgb, var(--danger) 85%, var(--text));
      }

      .sentiment-labels span:last-child {
        color: color-mix(in srgb, var(--accent) 85%, var(--text));
      }

      .category-header {
        margin: 10px 2px 6px;
        font-size: 11px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.14em;
        font-weight: 800;
      }

      .cta-btn {
        width: 100%;
        margin-top: 8px;
        padding: 10px 12px;
        border-radius: 999px;
        border: none;
        font-size: 12px;
        font-weight: 900;
        cursor: pointer;
        background: var(--accent);
        color: #0b1220;
      }

      .cta-btn.secondary {
        background: color-mix(in srgb, var(--accent2) 85%, #ffffff);
        color: #0b1220;
      }

      /* Toast */
      .swipe-toast {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: color-mix(in srgb, var(--card) 92%, transparent);
        border-radius: 999px;
        border: 1px solid var(--border);
        padding: 8px 14px;
        font-size: 12px;
        color: var(--text);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease, transform 0.2s ease;
        z-index: 90;
        white-space: nowrap;
        box-shadow: var(--shadow);
      }

      .swipe-toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      /* Modal (in-app popups) */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 100;
        padding: 18px;
      }

      html[data-theme="dark"] .modal-overlay {
        background: rgba(0, 0, 0, 0.62);
      }

      .modal-overlay.open {
        display: flex;
      }

      .modal-card {
        width: 100%;
        max-width: 420px;
        border-radius: 22px;
        border: 1px solid var(--border);
        background: var(--card);
        box-shadow: var(--shadowStrong);
        padding: 16px 16px 14px;
      }

      .modal-title {
        font-weight: 900;
        margin: 0 0 6px;
        font-size: 14px;
      }

      .modal-body {
        font-size: 12px;
        color: var(--muted);
        line-height: 1.45;
        margin-bottom: 12px;
      }

      .modal-actions {
        display: flex;
        gap: 8px;
      }

      .modal-actions button {
        flex: 1;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: transparent;
        cursor: pointer;
        font-weight: 900;
        font-size: 12px;
        color: var(--text);
      }

      .modal-actions button.primary {
        border: none;
        background: var(--accent2);
        color: #0b1220;
      }

      .modal-actions button.danger {
        border: none;
        background: var(--danger);
        color: #0b1220;
      }

      /* Auth overlay */
      #auth-overlay {
        position: fixed;
        inset: 0;
        background: radial-gradient(
          circle at top,
          color-mix(in srgb, var(--accent2) 12%, rgba(0, 0, 0, 0)),
          color-mix(in srgb, var(--bg) 92%, transparent)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 120;
        padding: 16px;
      }

      #auth-overlay.hidden {
        display: none !important;
      }

      .auth-card {
        width: 100%;
        max-width: 420px;
        background: var(--card);
        border-radius: 24px;
        border: 1px solid var(--border);
        padding: 18px 16px 14px;
        box-shadow: var(--shadowStrong);
      }

      .auth-title {
        font-size: 16px;
        font-weight: 900;
        margin: 0 0 6px;
      }

      .auth-subtitle {
        font-size: 12px;
        color: var(--muted);
        margin: 0 0 12px;
        line-height: 1.45;
      }

      .auth-field {
        margin-bottom: 10px;
      }

      .auth-field label {
        display: block;
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 4px;
        font-weight: 800;
      }

      .auth-field input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: color-mix(in srgb, var(--card) 92%, transparent);
        color: var(--text);
        font-size: 12px;
        outline: none;
      }

      .auth-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
      }

      .auth-actions button {
        flex: 1;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: transparent;
        cursor: pointer;
        font-weight: 900;
        font-size: 12px;
        color: var(--text);
      }

      .auth-actions button.primary {
        border: none;
        background: var(--accent2);
        color: #0b1220;
      }

      .auth-note {
        margin-top: 10px;
        font-size: 10px;
        color: var(--muted);
        line-height: 1.4;
      }

      @media (max-width: 480px) {
        .card-click-area {
          max-width: 350px;
        }
        .sport-logo-circle {
          width: 104px;
          height: 104px;
          font-size: 38px;
        }
        .swipe-toast {
          font-size: 11px;
          max-width: 92%;
          white-space: normal;
          text-align: center;
        }
      }
    </style>
  </head>

  <body>
    <div class="app-shell" id="app-shell">
      <header>
        <div class="header-left">
          <div class="logo-group" id="logo-group">
            <button id="app-logo-button" class="logo-button">
              <span class="logo">BEFORETHEBET</span>
              <span class="logo-caret">‚ñæ</span>
            </button>
            <div id="sports-menu" class="sports-menu"></div>
          </div>
          <button id="back-to-sports">‚Üê Back</button>
        </div>

        <div class="user-menu-wrapper" id="user-menu-wrapper">
          <button class="menu-placeholder" id="user-menu-button">
            <span id="user-menu-label">My Hub</span>
            <span>‚ñæ</span>
          </button>
          <div class="user-dropdown" id="user-dropdown"></div>
        </div>
      </header>

      <main>
        <div class="content">
          <div class="title-block">
            <h1 id="main-title">Select Your Sport</h1>
            <p id="subtitle">Swipe through sports, then explore matchups and lines.</p>
            <div class="directions" id="directions"></div>
          </div>

          <div class="card-container">
            <div class="card-click-area" id="card-click-area">
              <div class="stack-card stack-3"></div>
              <div class="stack-card stack-2"></div>
              <div class="stack-card stack-1"></div>

              <div class="card card-main" id="sport-card">
                <!-- FRONT -->
                <div class="card-face card-front" id="card-front">
                  <div class="sport-logo-circle" id="sport-logo">üèà</div>
                  <div class="sport-front-name" id="sport-name"></div>
                  <div class="sport-front-code" id="sport-code"></div>
                  <div class="tap-hint" id="tap-hint-front">Tap center to flip ‚Üª</div>
                  <div class="index-indicator" id="index-indicator"></div>
                </div>

                <!-- BACK -->
                <div class="card-face card-back" id="card-back">
                  <div class="back-header">
                    <div class="back-title" id="back-title"></div>
                    <div class="back-sub" id="back-sub"></div>
                  </div>

                  <div class="matchups-list" id="matchups-list"></div>

                  <div class="tap-hint" id="tap-hint-back">Double-tap center to flip ‚Ü∫</div>
                  <div class="index-indicator" id="index-indicator-back"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <footer>BeforeTheBet ‚Ä¢ Demo MVP</footer>
    </div>

    <!-- AUTH OVERLAY -->
    <div id="auth-overlay">
      <div class="auth-card">
        <div class="auth-title">Sign in to swipe</div>
        <div class="auth-subtitle">
          You must be signed in to record Confident / Doubt it and to save MyLocks across devices.
        </div>

        <div class="auth-field">
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="you@email.com" autocomplete="email" />
        </div>

        <div class="auth-field">
          <label for="password">Password</label>
          <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
        </div>

        <div class="auth-actions">
          <button id="signInBtn" class="primary" type="button">Sign In</button>
          <button id="signUpBtn" type="button">Create Account</button>
        </div>

        <div class="auth-actions" style="margin-top:8px;">
          <button id="auth-skip" type="button">View Only (No Swiping)</button>
          <button id="auth-continue" class="primary" type="button">Continue</button>
        </div>

        <div class="auth-note">
          If you create an account and don‚Äôt receive a verification email, your Supabase project may require confirmation.
          In that case, sign in with an already confirmed account, or disable email confirmations in Supabase Auth settings.
        </div>
      </div>
    </div>

    <!-- TOAST -->
    <div class="swipe-toast" id="swipe-toast"></div>

    <!-- MODAL -->
    <div class="modal-overlay" id="modal">
      <div class="modal-card">
        <div class="modal-title" id="modal-title">Action</div>
        <div class="modal-body" id="modal-body">Body</div>
        <div class="modal-actions" id="modal-actions"></div>
      </div>
    </div>

    <!-- SUPABASE CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      /************************************************************
       * 0) SUPABASE CLIENT
       ************************************************************/
      const SUPABASE_URL = "https://kmgrpyvcxonfjswxusbt.supabase.co";
      const SUPABASE_ANON =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttZ3JweXZjeG9uZmpzd3h1c2J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NjE4NTIsImV4cCI6MjA4MTIzNzg1Mn0.teDypPoT-TMPkIDGemYVRfCNdmK0uAbOCDaiHfNmgac";

      window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
        auth: { persistSession: true, autoRefreshToken: true },
      });

      /************************************************************
       * 1) DATA (sample sports; you can expand later)
       ************************************************************/
      const CATEGORY_LABELS = {
        spread: "Spreads",
        total: "Over / Unders",
        points: "Points",
        props: "Props",
        alt: "Alternate Lines",
        moneyline: "Moneylines",
        other: "Other",
      };

      const CATEGORY_ORDER = ["spread", "total", "moneyline", "points", "props", "alt", "other"];

      const SPORTS = [
        {
          id: "nfl",
          name: "NFL",
          code: "National Football League",
          emoji: "üèà",
          matchups: [
            {
              name: "Chiefs @ Bills",
              lines: [
                { label: "Chiefs -2.5", category: "spread", book: "FanDuel", confident: 56, doubt: 44 },
                { label: "Total 51.5", category: "total", book: "DraftKings", confident: 54, doubt: 46 },
                { label: "Mahomes o1.5 Passing TDs", category: "props", book: "BetMGM", confident: 62, doubt: 38 },
                { label: "Allen o36.5 Rush Yards", category: "props", book: "Caesars", confident: 57, doubt: 43 },
              ],
            },
            {
              name: "Eagles @ Cowboys",
              lines: [
                { label: "Eagles +3.5", category: "spread", book: "FanDuel", confident: 58, doubt: 42 },
                { label: "Total 48.5", category: "total", book: "DraftKings", confident: 51, doubt: 49 },
                { label: "Hurts o44.5 Rush Yards", category: "props", book: "BetMGM", confident: 55, doubt: 45 },
                { label: "Lamb o7.5 Targets", category: "props", book: "Caesars", confident: 60, doubt: 40 },
              ],
            },
          ],
        },
        {
          id: "nba",
          name: "NBA",
          code: "National Basketball Association",
          emoji: "üèÄ",
          matchups: [
            {
              name: "Lakers @ Warriors",
              lines: [
                { label: "Warriors -3.5", category: "spread", book: "FanDuel", confident: 52, doubt: 48 },
                { label: "Total 236.5", category: "total", book: "DraftKings", confident: 54, doubt: 46 },
                { label: "Curry o4.5 3PM", category: "points", book: "BetMGM", confident: 64, doubt: 36 },
                { label: "LeBron o26.5 Points", category: "points", book: "Caesars", confident: 61, doubt: 39 },
              ],
            },
            {
              name: "Celtics @ Knicks",
              lines: [
                { label: "Celtics -4.5", category: "spread", book: "FanDuel", confident: 58, doubt: 42 },
                { label: "Total 224.5", category: "total", book: "DraftKings", confident: 51, doubt: 49 },
                { label: "Brunson o24.5 Pts", category: "points", book: "BetMGM", confident: 56, doubt: 44 },
                { label: "Tatum o3.5 3PM", category: "points", book: "Caesars", confident: 49, doubt: 51 },
              ],
            },
          ],
        },
      ];

      /************************************************************
       * 2) APP STATE
       ************************************************************/
      let mode = "sports"; // sports | matchups | allLines | lineDetails | mybias | mylocks | myarchives
      let currentSportIndex = 0;
      let currentMatchupIndex = 0;
      let flipped = false;

      let previousModeBeforeLineDetails = null;
      let currentLineDetailMeta = null;

      const DOUBLE_CLICK_DELAY = 250;
      let clickTimeout = null;

      // Auth/session
      let sessionUser = null; // supabase user object (when signed in)
      let viewOnly = false;   // true if they click "View Only"

      // swipe gating (show community bias only after 5 swipes by this user)
      let totalUserSwipes = 0;

      // local store (fallback + UI cache)
      // key format: sportId|matchupName|lineLabel|book
      const store = {
        itemsByKey: {}, // { [key]: { status: 'bias'|'lock'|'archived', vote: 'confident'|'doubt', ... } }
      };

      /************************************************************
       * 3) DOM
       ************************************************************/
      const cardEl = document.getElementById("sport-card");
      const cardClickArea = document.getElementById("card-click-area");

      const logoEl = document.getElementById("sport-logo");
      const nameEl = document.getElementById("sport-name");
      const codeEl = document.getElementById("sport-code");
      const tapHintFrontEl = document.getElementById("tap-hint-front");
      const tapHintBackEl = document.getElementById("tap-hint-back");
      const indexIndicatorFront = document.getElementById("index-indicator");
      const indexIndicatorBack = document.getElementById("index-indicator-back");

      const backTitleEl = document.getElementById("back-title");
      const backSubEl = document.getElementById("back-sub");
      const matchupsListEl = document.getElementById("matchups-list");

      const titleEl = document.getElementById("main-title");
      const subtitleEl = document.getElementById("subtitle");
      const directionsEl = document.getElementById("directions");
      const backToSportsBtn = document.getElementById("back-to-sports");

      const sportsMenuEl = document.getElementById("sports-menu");
      const appLogoButton = document.getElementById("app-logo-button");
      const logoGroup = document.getElementById("logo-group");

      const userMenuButton = document.getElementById("user-menu-button");
      const userMenuLabel = document.getElementById("user-menu-label");
      const userDropdown = document.getElementById("user-dropdown");
      const userMenuWrapper = document.getElementById("user-menu-wrapper");

      const authOverlay = document.getElementById("auth-overlay");
      const authSkipBtn = document.getElementById("auth-skip");
      const authContinueBtn = document.getElementById("auth-continue");
      const signInBtn = document.getElementById("signInBtn");
      const signUpBtn = document.getElementById("signUpBtn");

      const swipeToastEl = document.getElementById("swipe-toast");

      const modalEl = document.getElementById("modal");
      const modalTitleEl = document.getElementById("modal-title");
      const modalBodyEl = document.getElementById("modal-body");
      const modalActionsEl = document.getElementById("modal-actions");

      /************************************************************
       * 4) HELPERS
       ************************************************************/
      function currentSport() {
        return SPORTS[currentSportIndex];
      }
      function currentMatchup() {
        return currentSport().matchups[currentMatchupIndex];
      }
      function getNextIndex(length, current) {
        return (current + 1) % length;
      }
      function getPrevIndex(length, current) {
        return current === 0 ? length - 1 : current - 1;
      }

      function showToast(msg) {
        swipeToastEl.textContent = msg;
        swipeToastEl.classList.add("show");
        clearTimeout(swipeToastEl._hideTimeout);
        swipeToastEl._hideTimeout = setTimeout(() => {
          swipeToastEl.classList.remove("show");
        }, 1100);
      }

      function openModal({ title, body, actions }) {
        modalTitleEl.textContent = title || "Action";
        modalBodyEl.textContent = body || "";
        modalActionsEl.innerHTML = "";

        (actions || []).forEach((a) => {
          const btn = document.createElement("button");
          btn.textContent = a.label;
          if (a.variant === "primary") btn.classList.add("primary");
          if (a.variant === "danger") btn.classList.add("danger");
          btn.addEventListener("click", async () => {
            try {
              if (a.onClick) await a.onClick();
            } finally {
              closeModal();
            }
          });
          modalActionsEl.appendChild(btn);
        });

        modalEl.classList.add("open");
      }

      function closeModal() {
        modalEl.classList.remove("open");
      }

      modalEl.addEventListener("click", (e) => {
        if (e.target === modalEl) closeModal();
      });

      function requireAuthOrPrompt() {
        if (viewOnly) {
          openModal({
            title: "Sign in required",
            body: "You‚Äôre in View Only mode. Sign in to record Confident / Doubt it and save MyLocks across devices.",
            actions: [
              { label: "Close", onClick: () => {} },
              {
                label: "Sign in",
                variant: "primary",
                onClick: () => {
                  authOverlay.classList.remove("hidden");
                },
              },
            ],
          });
          return false;
        }
        if (!sessionUser) {
          authOverlay.classList.remove("hidden");
          return false;
        }
        return true;
      }

      function setTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);
        localStorage.setItem("btb_theme", theme);
      }

      function initTheme() {
        const saved = localStorage.getItem("btb_theme");
        if (saved === "dark" || saved === "light") setTheme(saved);
        else setTheme("light"); // default
      }

      function makeKey(meta) {
        return `${meta.sportId}|${meta.matchupName}|${meta.label}|${meta.book || ""}`;
      }

      function getUserId() {
        return sessionUser?.id || null;
      }

      /************************************************************
       * 5) SUPABASE PERSISTENCE
       *    Table expected: btb_swipes
       *    Columns (suggested):
       *      user_id uuid, key text, sport_id text, matchup_name text, line_label text, book text,
       *      status text ('bias'|'lock'|'archived'), vote text ('confident'|'doubt'),
       *      updated_at timestamptz default now()
       *    UNIQUE (user_id, key)
       ************************************************************/
      async function loadProfileFromDb() {
        const userId = getUserId();
        if (!userId) return;

        try {
          const { data, error } = await window.supabase
            .from("btb_swipes")
            .select("*")
            .eq("user_id", userId);

          if (error) throw error;

          // reset local store and hydrate
          store.itemsByKey = {};
          let count = 0;

          (data || []).forEach((row) => {
            store.itemsByKey[row.key] = {
              key: row.key,
              sportId: row.sport_id,
              matchupName: row.matchup_name,
              label: row.line_label,
              book: row.book || "",
              status: row.status,
              vote: row.vote,
              updatedAt: row.updated_at || Date.now(),
            };
            count += 1;
          });

          // swipes total for gating: count all rows (bias/lock/archived)
          totalUserSwipes = count;

        } catch (e) {
          // fallback: keep local
          console.warn("DB load failed (btb_swipes missing?). Using local cache.", e);
          const local = JSON.parse(localStorage.getItem("btb_local_store") || "{}");
          if (local.itemsByKey) store.itemsByKey = local.itemsByKey;
          totalUserSwipes = Number(local.totalUserSwipes || 0);
        }
      }

      async function persistRowToDb(row) {
        const userId = getUserId();
        if (!userId) return false;

        try {
          const payload = {
            user_id: userId,
            key: row.key,
            sport_id: row.sportId,
            matchup_name: row.matchupName,
            line_label: row.label,
            book: row.book || "",
            status: row.status,
            vote: row.vote,
            updated_at: new Date().toISOString(),
          };

          const { error } = await window.supabase
            .from("btb_swipes")
            .upsert(payload, { onConflict: "user_id,key" });

          if (error) throw error;
          return true;
        } catch (e) {
          console.warn("DB upsert failed. Saving locally.", e);
          // local fallback
          localStorage.setItem(
            "btb_local_store",
            JSON.stringify({ itemsByKey: store.itemsByKey, totalUserSwipes })
          );
          return false;
        }
      }

      async function removeRowFromDb(key) {
        const userId = getUserId();
        if (!userId) return false;

        try {
          const { error } = await window.supabase
            .from("btb_swipes")
            .delete()
            .eq("user_id", userId)
            .eq("key", key);

          if (error) throw error;
          return true;
        } catch (e) {
          console.warn("DB delete failed. Removing locally.", e);
          return false;
        }
      }

      /************************************************************
       * 6) BIAS DISPLAY LOGIC
       *    Before user has 5 swipes => show 50/50 BLUE
       *    After 5 swipes => show line's community bias in GREEN
       ************************************************************/
      function canShowCommunityBias() {
        return totalUserSwipes >= 5;
      }

      function getDisplayedBias(lineObj) {
        // right = Confident, left = Doubt it
        if (!canShowCommunityBias()) {
          return { confident: 50, doubt: 50, color: "blue" };
        }
        // use line's stored numbers (fallback to 55/45)
        const c = clampPct(lineObj.confident ?? 55);
        const d = clampPct(lineObj.doubt ?? (100 - c));
        return { confident: c, doubt: d, color: "green" };
      }

      function clampPct(v) {
        const n = Number(v);
        if (!Number.isFinite(n)) return 50;
        return Math.max(0, Math.min(100, Math.round(n)));
      }

      function buildBiasUI(meta, lineObj) {
        const bias = getDisplayedBias(lineObj);

        const wrap = document.createElement("div");
        wrap.className = "sentiment-bar-container";

        const bg = document.createElement("div");
        bg.className = "sentiment-bar-bg";

        const fill = document.createElement("div");
        fill.className = "sentiment-bar-fill";
        fill.style.width = bias.confident + "%";
        fill.style.background =
          bias.color === "blue"
            ? `linear-gradient(90deg, var(--accent2), color-mix(in srgb, var(--accent2) 70%, #ffffff))`
            : `linear-gradient(90deg, var(--accent), color-mix(in srgb, var(--accent) 70%, #ffffff))`;

        bg.appendChild(fill);

        const labels = document.createElement("div");
        labels.className = "sentiment-labels";

        // LEFT = Doubt it
        const left = document.createElement("span");
        left.textContent = `Doubt it ${bias.doubt}%`;

        // RIGHT = Confident
        const right = document.createElement("span");
        right.textContent = `Confident ${bias.confident}%`;

        labels.appendChild(left);
        labels.appendChild(right);

        wrap.appendChild(bg);
        wrap.appendChild(labels);

        return wrap;
      }

      /************************************************************
       * 7) LINE DETAILS (placeholder stats)
       ************************************************************/
      function openLineDetails(meta) {
        previousModeBeforeLineDetails = mode === "lineDetails" ? previousModeBeforeLineDetails : mode;
        currentLineDetailMeta = meta;
        mode = "lineDetails";
        flipped = true; // keep card flipped while on details
        renderScreen();
      }

      function renderLineDetailsFront() {
        logoEl.textContent = "üìà";
        nameEl.textContent = "Line Details";
        codeEl.textContent = "Placeholder stats layout";
        tapHintFrontEl.textContent = "Double-tap center to go back ‚Ü∫";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderLineDetailsBack() {
        const meta = currentLineDetailMeta;
        backTitleEl.textContent = "Line Details";
        backSubEl.textContent = meta?.label || "";

        matchupsListEl.innerHTML = "";

        const card1 = document.createElement("div");
        card1.className = "matchup-card";
        card1.innerHTML = `
          <div class="matchup-top">
            <div>
              <div class="matchup-label">${escapeHtml(meta.label)}</div>
              <div class="matchup-line">${escapeHtml(meta.matchupName)} ‚Ä¢ ${escapeHtml(meta.sportName)} ‚Ä¢ ${escapeHtml(meta.book || "Best Available")}</div>
              <div class="matchup-line">Double-click anywhere to go back.</div>
            </div>
            <div class="matchup-tag">Season: 2025</div>
          </div>
        `;
        matchupsListEl.appendChild(card1);

        const card2 = document.createElement("div");
        card2.className = "matchup-card";
        card2.innerHTML = `
          <div class="matchup-label">Performance (placeholder)</div>
          <div class="matchup-line">Games tracked: 18</div>
          <div class="matchup-line">Hit rate: 61%</div>
          <div class="matchup-line">Avg delta vs line: +0.7</div>
          <div class="matchup-line">Last 5: Hit ‚Ä¢ Hit ‚Ä¢ Miss ‚Ä¢ Hit ‚Ä¢ Hit</div>
        `;
        matchupsListEl.appendChild(card2);

        const card3 = document.createElement("div");
        card3.className = "matchup-card";
        card3.innerHTML = `
          <div class="matchup-label">Matchup context (placeholder)</div>
          <div class="matchup-line">Pace rank: 8th</div>
          <div class="matchup-line">Defense rank: 14th</div>
          <div class="matchup-line">Injury impact: Low</div>
        `;
        matchupsListEl.appendChild(card3);
      }

      function escapeHtml(s) {
        return String(s || "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      /************************************************************
       * 8) SWIPES + LONG PRESS (per-line only)
       ************************************************************/
      function getExisting(meta) {
        const key = makeKey(meta);
        return store.itemsByKey[key] || null;
      }

      function markCardSavedUI(card) {
        card.classList.add("is-saved");
      }

      function moveCardToBottom(card) {
        if (!card?.parentNode) return;
        card.parentNode.appendChild(card);
      }

      async function saveSwipe(meta, vote, nextStatus) {
        // vote: 'confident' (right), 'doubt' (left)
        const key = makeKey(meta);
        const now = new Date().toISOString();

        // create/update local row
        const row = {
          key,
          sportId: meta.sportId,
          sportName: meta.sportName,
          matchupName: meta.matchupName,
          label: meta.label,
          book: meta.book || "",
          status: nextStatus, // bias|lock|archived
          vote,              // confident|doubt
          updatedAt: now,
        };
        store.itemsByKey[key] = row;

        // bump gating count only if this is first time we see this key for this user
        // (if it existed, don‚Äôt increase totalUserSwipes)
        const existed = !!getExisting(meta) && getExisting(meta)?.updatedAt !== row.updatedAt;
        // safer: detect if the key existed before overwrite
        // (we can track with a flag from earlier call site)
        // We'll handle gating outside when needed.

        await persistRowToDb(row);

        // cache fallback
        localStorage.setItem(
          "btb_local_store",
          JSON.stringify({ itemsByKey: store.itemsByKey, totalUserSwipes })
        );
      }

      function attachSwipeHandlers(card, meta, context) {
        // context: 'linesFlow' | 'mybias'
        let startX = null;
        let isPointerDown = false;

        // LONG PRESS state
        let holdTimer = null;
        let holdFired = false;

        function clearHold() {
          if (holdTimer) clearTimeout(holdTimer);
          holdTimer = null;
          holdFired = false;
        }

        // prevent click flipping if user interacts with card
        card.addEventListener("click", (e) => e.stopPropagation());
        card.addEventListener("dblclick", (e) => {
          e.stopPropagation();
          openLineDetails(meta);
        });

        card.addEventListener("pointerdown", (e) => {
          e.stopPropagation();

          // block swiping if not authed
          if (!requireAuthOrPrompt()) return;

          // block if already saved
          if (card.classList.contains("is-saved")) return;

          isPointerDown = true;
          startX = e.clientX;

          // long press = open change-bias modal for THIS line only
          clearHold();
          holdTimer = setTimeout(() => {
            holdFired = true;
            const existing = getExisting(meta);
            if (!existing) return;

            const isLock = existing.status === "lock";

            openModal({
              title: isLock ? "Manage Lock" : "Change your bias?",
              body: isLock
                ? "Remove this line from MyLocks? (It will no longer show as a lock on any device.)"
                : "Flip your saved bias for this line?",
              actions: [
                { label: "Cancel", onClick: () => {} },
                isLock
                  ? {
                      label: "Remove from Locks",
                      variant: "danger",
                      onClick: async () => {
                        // move lock back to MyBias (status=bias)
                        existing.status = "bias";
                        existing.vote = existing.vote || "confident";
                        existing.updatedAt = new Date().toISOString();
                        store.itemsByKey[existing.key] = existing;
                        await persistRowToDb(existing);
                        showToast("Removed from MyLocks");
                        renderScreen();
                      },
                    }
                  : {
                      label: "Flip Bias",
                      variant: "primary",
                      onClick: async () => {
                        // flip vote only for this line
                        existing.vote = existing.vote === "confident" ? "doubt" : "confident";
                        existing.updatedAt = new Date().toISOString();
                        store.itemsByKey[existing.key] = existing;

                        // if it was in MyBias, keep it there
                        await persistRowToDb(existing);

                        showToast("Bias updated");
                        renderScreen();
                      },
                    },
              ],
            });
          }, 650);
        });

        card.addEventListener("pointerup", async (e) => {
          e.stopPropagation();

          if (!isPointerDown) return;
          isPointerDown = false;

          if (!requireAuthOrPrompt()) {
            clearHold();
            return;
          }

          // if long-press already fired, do nothing
          if (holdFired) {
            clearHold();
            return;
          }

          clearHold();

          // block if already saved
          if (card.classList.contains("is-saved")) return;

          const dx = e.clientX - startX;
          const threshold = 40;
          if (Math.abs(dx) < threshold) return;

          const direction = dx > 0 ? "right" : "left";
          const vote = direction === "right" ? "confident" : "doubt";

          // Determine next status based on context
          let nextStatus = "bias";
          if (context === "mybias") {
            nextStatus = vote === "confident" ? "lock" : "archived";
          } else {
            // in flow, store as MyBias (inbox) on first swipe
            nextStatus = "bias";
          }

          const key = makeKey(meta);
          const existedBefore = !!store.itemsByKey[key];

          // Save row
          await saveSwipe(meta, vote, nextStatus);

          // gating count: only increment on first-ever swipe of a new key
          if (!existedBefore) totalUserSwipes += 1;

          // UI: animate, mark saved, move to bottom
          markCardSavedUI(card);
          moveCardToBottom(card);

          if (context === "mybias") {
            // if swiped in MyBias, remove from MyBias list visually by re-rendering screen
            showToast(vote === "confident" ? "Saved to MyLocks" : "Moved to MyArchives");
            renderScreen();
          } else {
            showToast(vote === "confident" ? "‚úÖ Confident saved to MyBias" : "ü§î Doubt saved to MyBias");
            // IMPORTANT: do NOT flip card back over
            // Just refresh bias bars if we crossed 5 swipes
            if (canShowCommunityBias()) {
              renderScreen();
            }
          }
        });

        card.addEventListener("pointercancel", () => {
          isPointerDown = false;
          clearHold();
        });
      }

      /************************************************************
       * 9) RENDER BUILDERS
       ************************************************************/
      function renderCardFlipState() {
        if (flipped) cardEl.classList.add("flipped");
        else cardEl.classList.remove("flipped");
      }

      function renderSportsFront() {
        const sport = currentSport();
        logoEl.textContent = sport.emoji;
        nameEl.textContent = sport.name;
        codeEl.textContent = sport.code;
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";
        const idx = `${currentSportIndex + 1} / ${SPORTS.length}`;
        indexIndicatorFront.textContent = idx;
        indexIndicatorBack.textContent = idx;
      }

      function renderSportsBack() {
        const sport = currentSport();
        backTitleEl.textContent = `${sport.name} ‚Äì Matchups`;
        backSubEl.textContent = "Double-click a matchup to open All Lines.";

        matchupsListEl.innerHTML = "";

        sport.matchups.forEach((matchup, mIndex) => {
          const topLine = matchup.lines[0] || { label: "Lines coming soon", book: "Consensus", confident: 50, doubt: 50 };

          const card = document.createElement("div");
          card.className = "matchup-card";
          card.style.cursor = "pointer";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = matchup.name;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = topLine.label;

          left.appendChild(label);
          left.appendChild(line);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = topLine.book || "Consensus";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);

          // side bias UI (blue until 5 swipes, then green)
          card.appendChild(
            buildBiasUI(
              {
                sportId: sport.id,
                sportName: sport.name,
                matchupName: matchup.name,
                label: topLine.label,
                book: topLine.book || "Consensus",
              },
              topLine
            )
          );

          // IMPORTANT FIX: dblclick opens All Lines for that matchup
          card.addEventListener("dblclick", (e) => {
            e.stopPropagation();
            mode = "allLines";
            currentMatchupIndex = mIndex;
            flipped = true; // show lines
            renderScreen();
          });

          matchupsListEl.appendChild(card);
        });
      }

      function renderMatchupsFront() {
        const sport = currentSport();
        const matchup = currentMatchup();
        logoEl.textContent = sport.emoji;
        nameEl.textContent = matchup.name;
        codeEl.textContent = sport.name;
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";
        const idx = `${currentMatchupIndex + 1} / ${sport.matchups.length}`;
        indexIndicatorFront.textContent = idx;
        indexIndicatorBack.textContent = idx;
      }

      function renderMatchupsBack() {
        const sport = currentSport();
        const matchup = currentMatchup();

        backTitleEl.textContent = `${sport.name} ‚Äì Top Lines`;
        backSubEl.textContent = "Swipe to save to MyBias. Double-click any line for details.";

        matchupsListEl.innerHTML = "";

        // show top 5 lines
        const linesToShow = matchup.lines.slice(0, 5);

        linesToShow.forEach((ln) => {
          const meta = {
            sportId: sport.id,
            sportName: sport.name,
            matchupName: matchup.name,
            label: ln.label,
            book: ln.book || "Consensus",
          };

          const existing = getExisting(meta);

          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = ln.label;

          const gameLine = document.createElement("div");
          gameLine.className = "matchup-line";
          gameLine.textContent = matchup.name;

          const helper = document.createElement("div");
          helper.className = "matchup-line";
          helper.textContent = "Swipe: left = Doubt it, right = Confident. Hold to change later.";

          left.appendChild(label);
          left.appendChild(gameLine);
          left.appendChild(helper);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = ln.book || "Consensus";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);

          // bias bar
          card.appendChild(buildBiasUI(meta, ln));

          // saved?
          if (existing) markCardSavedUI(card);

          // swipe handlers (saves to MyBias only)
          attachSwipeHandlers(card, meta, "linesFlow");

          matchupsListEl.appendChild(card);
        });
      }

      function renderAllLinesBack() {
        const sport = currentSport();
        const matchup = currentMatchup();

        backTitleEl.textContent = `${sport.name} ‚Äì All Lines`;
        backSubEl.textContent =
          "Swipe to save to MyBias. Double-click any line for details.";

        matchupsListEl.innerHTML = "";

        const baseLines = matchup.lines;

        // group by category
        const grouped = {};
        baseLines.forEach((ln) => {
          const cat = ln.category || "other";
          if (!grouped[cat]) grouped[cat] = [];
          grouped[cat].push(ln);
        });

        CATEGORY_ORDER.forEach((catKey) => {
          const linesInCat = grouped[catKey];
          if (!linesInCat || linesInCat.length === 0) return;

          const header = document.createElement("div");
          header.className = "category-header";
          header.textContent = CATEGORY_LABELS[catKey] || CATEGORY_LABELS.other;
          matchupsListEl.appendChild(header);

          linesInCat.forEach((ln) => {
            const meta = {
              sportId: sport.id,
              sportName: sport.name,
              matchupName: matchup.name,
              label: ln.label,
              book: ln.book || "Consensus",
            };
            const existing = getExisting(meta);

            const card = document.createElement("div");
            card.className = "matchup-card";

            const top = document.createElement("div");
            top.className = "matchup-top";

            const left = document.createElement("div");
            const label = document.createElement("div");
            label.className = "matchup-label";
            label.textContent = ln.label;

            const gameLine = document.createElement("div");
            gameLine.className = "matchup-line";
            gameLine.textContent = matchup.name;

            const helper = document.createElement("div");
            helper.className = "matchup-line";
            helper.textContent = "Swipe: left = Doubt it, right = Confident. Hold to change later.";

            left.appendChild(label);
            left.appendChild(gameLine);
            left.appendChild(helper);

            const right = document.createElement("div");
            right.className = "matchup-tag";
            right.textContent = ln.book || "Consensus";

            top.appendChild(left);
            top.appendChild(right);

            card.appendChild(top);
            card.appendChild(buildBiasUI(meta, ln));

            if (existing) markCardSavedUI(card);

            attachSwipeHandlers(card, meta, "linesFlow");

            matchupsListEl.appendChild(card);
          });
        });
      }

      function renderMyBiasFront() {
        logoEl.textContent = "üß†";
        nameEl.textContent = "MyBias";
        codeEl.textContent = "Lines you swiped in the flow";
        tapHintFrontEl.textContent = "Double-tap center to flip ‚Üª";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderMyBiasBack() {
        backTitleEl.textContent = "MyBias";
        backSubEl.textContent =
          "Swipe right (Confident) to move to MyLocks. Swipe left (Doubt it) to move to MyArchives. Hold a line to flip your bias.";

        matchupsListEl.innerHTML = "";

        const items = Object.values(store.itemsByKey)
          .filter((x) => x.status === "bias")
          .sort((a, b) => new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime());

        if (items.length === 0) {
          const empty = document.createElement("div");
          empty.className = "matchup-card";
          empty.innerHTML = `
            <div class="matchup-label">No lines in MyBias</div>
            <div class="matchup-line">Swipe some lines from Matchups / All Lines, then come back here to lock or archive them.</div>
          `;
          matchupsListEl.appendChild(empty);
          return;
        }

        items.forEach((it) => {
          const card = document.createElement("div");
          card.className = "matchup-card";
          card.style.cursor = "pointer";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = it.label;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = `${it.matchupName} ‚Ä¢ ${it.sportId.toUpperCase()} ‚Ä¢ ${it.book || "Best Available"}`;

          const helper = document.createElement("div");
          helper.className = "matchup-line";
          helper.textContent = "Swipe: left = Doubt it ‚Üí MyArchives ‚Ä¢ right = Confident ‚Üí MyLocks ‚Ä¢ hold to flip bias.";

          left.appendChild(label);
          left.appendChild(line);
          left.appendChild(helper);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = it.vote === "confident" ? "Last: Confident" : "Last: Doubt it";

          top.appendChild(left);
          top.appendChild(right);
          card.appendChild(top);

          // build bias UI from the base line data if possible (otherwise 50/50)
          const baseLine = findLineObject(it);
          card.appendChild(buildBiasUI(
            {
              sportId: it.sportId,
              sportName: it.sportId.toUpperCase(),
              matchupName: it.matchupName,
              label: it.label,
              book: it.book || "",
            },
            baseLine || { confident: 50, doubt: 50 }
          ));

          // attach swipe to move to locks/archives
          attachSwipeHandlers(card, {
            sportId: it.sportId,
            sportName: it.sportId.toUpperCase(),
            matchupName: it.matchupName,
            label: it.label,
            book: it.book || "",
          }, "mybias");

          matchupsListEl.appendChild(card);
        });
      }

      function renderMyLocksFront() {
        logoEl.textContent = "üîí";
        nameEl.textContent = "MyLocks";
        codeEl.textContent = "Your locked Confident picks";
        tapHintFrontEl.textContent = "Double-tap center to flip ‚Üª";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderMyLocksBack() {
        backTitleEl.textContent = "MyLocks";
        backSubEl.textContent =
          "Grouped by sportsbook. Hold a lock to remove it from MyLocks.";

        matchupsListEl.innerHTML = "";

        const locks = Object.values(store.itemsByKey)
          .filter((x) => x.status === "lock")
          .sort((a, b) => (a.book || "").localeCompare(b.book || "") || (new Date(b.updatedAt) - new Date(a.updatedAt)));

        if (locks.length === 0) {
          const empty = document.createElement("div");
          empty.className = "matchup-card";
          empty.innerHTML = `
            <div class="matchup-label">No locks yet</div>
            <div class="matchup-line">Go to MyBias and swipe right (Confident) to lock a line.</div>
          `;
          matchupsListEl.appendChild(empty);
          return;
        }

        const byBook = {};
        locks.forEach((it) => {
          const b = it.book || "Best Available";
          if (!byBook[b]) byBook[b] = [];
          byBook[b].push(it);
        });

        Object.keys(byBook).sort().forEach((book) => {
          const header = document.createElement("div");
          header.className = "category-header";
          header.textContent = book;
          matchupsListEl.appendChild(header);

          byBook[book].forEach((it) => {
            const card = document.createElement("div");
            card.className = "matchup-card";
            card.style.cursor = "pointer";

            const top = document.createElement("div");
            top.className = "matchup-top";

            const left = document.createElement("div");
            const label = document.createElement("div");
            label.className = "matchup-label";
            label.textContent = it.label;

            const line = document.createElement("div");
            line.className = "matchup-line";
            line.textContent = `${it.matchupName} ‚Ä¢ ${it.sportId.toUpperCase()} ‚Ä¢ Locked`;

            const helper = document.createElement("div");
            helper.className = "matchup-line";
            helper.textContent = "Hold to remove from locks. Double-click for details.";

            left.appendChild(label);
            left.appendChild(line);
            left.appendChild(helper);

            const right = document.createElement("div");
            right.className = "matchup-tag";
            right.textContent = "Confident ‚úÖ";

            top.appendChild(left);
            top.appendChild(right);
            card.appendChild(top);

            const baseLine = findLineObject(it);
            card.appendChild(buildBiasUI(
              { sportId: it.sportId, matchupName: it.matchupName, label: it.label, book: it.book },
              baseLine || { confident: 50, doubt: 50 }
            ));

            // attach handlers for details + long-press remove
            attachSwipeHandlers(card, {
              sportId: it.sportId,
              sportName: it.sportId.toUpperCase(),
              matchupName: it.matchupName,
              label: it.label,
              book: it.book || "",
            }, "linesFlow");

            // force status is lock; long-press modal already handles remove from locks
            matchupsListEl.appendChild(card);
          });

          const btn = document.createElement("button");
          btn.className = "cta-btn";
          btn.textContent = `PLACE BET IN ${book.toUpperCase()}`;
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            openModal({
              title: "Coming soon",
              body: "Coming Soon for now. Please access your book to wager.",
              actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
            });
          });
          matchupsListEl.appendChild(btn);
        });
      }

      function renderMyArchivesFront() {
        logoEl.textContent = "üóÉÔ∏è";
        nameEl.textContent = "MyArchives";
        codeEl.textContent = "Lines you doubted";
        tapHintFrontEl.textContent = "Double-tap center to flip ‚Üª";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderMyArchivesBack() {
        backTitleEl.textContent = "MyArchives";
        backSubEl.textContent =
          "Your archived Doubt it lines. Double-click for details.";

        matchupsListEl.innerHTML = "";

        const archived = Object.values(store.itemsByKey)
          .filter((x) => x.status === "archived")
          .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));

        if (archived.length === 0) {
          const empty = document.createElement("div");
          empty.className = "matchup-card";
          empty.innerHTML = `
            <div class="matchup-label">Nothing archived</div>
            <div class="matchup-line">From MyBias, swipe left (Doubt it) to archive a line.</div>
          `;
          matchupsListEl.appendChild(empty);
          return;
        }

        archived.forEach((it) => {
          const card = document.createElement("div");
          card.className = "matchup-card";
          card.style.cursor = "pointer";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = it.label;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = `${it.matchupName} ‚Ä¢ ${it.sportId.toUpperCase()} ‚Ä¢ Archived`;

          left.appendChild(label);
          left.appendChild(line);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = it.book || "Best Available";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);

          card.addEventListener("dblclick", (e) => {
            e.stopPropagation();
            openLineDetails({
              sportId: it.sportId,
              sportName: it.sportId.toUpperCase(),
              matchupName: it.matchupName,
              label: it.label,
              book: it.book,
            });
          });

          matchupsListEl.appendChild(card);
        });
      }

      function findLineObject(it) {
        const sport = SPORTS.find((s) => s.id === it.sportId);
        if (!sport) return null;
        const matchup = sport.matchups.find((m) => m.name === it.matchupName);
        if (!matchup) return null;
        const line = matchup.lines.find((l) => l.label === it.label && (l.book || "") === (it.book || ""));
        return line || null;
      }

      /************************************************************
       * 10) SCREEN ROUTER
       ************************************************************/
      function renderScreen() {
        // directions by mode
        if (mode === "sports") {
          titleEl.textContent = "Select Your Sport";
          subtitleEl.textContent = "Tap center to flip into matchups.";
          directionsEl.innerHTML =
            `Tap <strong>center</strong> to flip. Tap <strong>right edge</strong> / <strong>left edge</strong> to change sport. <strong>Double-click</strong> a matchup to open All Lines.`;
          backToSportsBtn.style.display = "none";
          renderSportsFront();
          renderSportsBack();
        } else if (mode === "matchups") {
          const sport = currentSport();
          titleEl.textContent = `${sport.name} Matchups`;
          subtitleEl.textContent = "Tap center to flip into top lines.";
          directionsEl.innerHTML =
            `Tap <strong>edges</strong> to change matchup. Tap <strong>center</strong> to flip. <strong>Double-click center</strong> to open All Lines.`;
          backToSportsBtn.style.display = "inline-flex";
          renderMatchupsFront();
          renderMatchupsBack();
        } else if (mode === "allLines") {
          const sport = currentSport();
          const matchup = currentMatchup();
          titleEl.textContent = `${sport.name} ‚Äì All Lines`;
          subtitleEl.textContent = matchup.name;
          directionsEl.innerHTML =
            `In All Lines: <strong>single click center</strong> changes game (no flip). <strong>Double-click center</strong> flips to lines. Swipe lines to save to MyBias.`;
          backToSportsBtn.style.display = "inline-flex";
          renderMatchupsFront();
          renderAllLinesBack();
        } else if (mode === "lineDetails") {
          titleEl.textContent = "Line Details";
          subtitleEl.textContent = currentLineDetailMeta?.matchupName || "";
          directionsEl.innerHTML =
            `Double-click center to go back. Placeholder stats for now.`;
          backToSportsBtn.style.display = "inline-flex";
          renderLineDetailsFront();
          renderLineDetailsBack();
        } else if (mode === "mybias") {
          titleEl.textContent = "MyBias";
          subtitleEl.textContent = "Your saved lines";
          directionsEl.innerHTML =
            `Swipe right (Confident) to lock. Swipe left (Doubt it) to archive. Hold to flip your bias for a single line.`;
          backToSportsBtn.style.display = "inline-flex";
          renderMyBiasFront();
          renderMyBiasBack();
          flipped = true;
        } else if (mode === "mylocks") {
          titleEl.textContent = "MyLocks";
          subtitleEl.textContent = "Grouped by sportsbook";
          directionsEl.innerHTML =
            `Hold a lock to remove it. Tap PLACE BET button for affiliate flow (coming soon).`;
          backToSportsBtn.style.display = "inline-flex";
          renderMyLocksFront();
          renderMyLocksBack();
          flipped = true;
        } else if (mode === "myarchives") {
          titleEl.textContent = "MyArchives";
          subtitleEl.textContent = "Your Doubt it lines";
          directionsEl.innerHTML =
            `Double-click a line for details.`;
          backToSportsBtn.style.display = "inline-flex";
          renderMyArchivesFront();
          renderMyArchivesBack();
          flipped = true;
        }

        renderCardFlipState();
        buildSportsMenu();
        buildUserDropdown();
      }

      /************************************************************
       * 11) CARD CLICK LOGIC
       *    IMPORTANT: do not auto-flip back after swipes.
       ************************************************************/
      function handleGlobalBack() {
        if (mode === "lineDetails" && previousModeBeforeLineDetails) {
          mode = previousModeBeforeLineDetails;
          flipped = true;
        } else if (mode === "allLines") {
          mode = "matchups";
          flipped = false;
        } else if (mode === "matchups") {
          mode = "sports";
          flipped = false;
        } else if (mode === "mybias" || mode === "mylocks" || mode === "myarchives") {
          mode = "sports";
          flipped = false;
        } else {
          return;
        }
        renderScreen();
      }

      backToSportsBtn.addEventListener("click", () => handleGlobalBack());

      function handleSingleClick(e) {
        const rect = cardClickArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const zone = x / rect.width;

        // In hub modes: center flips only
        if (mode === "mybias" || mode === "mylocks" || mode === "myarchives") {
          if (zone >= 0.2 && zone <= 0.8) {
            flipped = !flipped;
            renderCardFlipState();
          }
          return;
        }

        // in lineDetails: center back
        if (mode === "lineDetails") {
          if (zone >= 0.2 && zone <= 0.8) handleGlobalBack();
          return;
        }

        // Edges: change sport or matchup
        if (zone < 0.2) {
          if (mode === "sports") currentSportIndex = getPrevIndex(SPORTS.length, currentSportIndex);
          else if (mode === "matchups" || mode === "allLines") currentMatchupIndex = getPrevIndex(currentSport().matchups.length, currentMatchupIndex);
          // do not auto-flip to back
          flipped = false;
          renderScreen();
          return;
        }

        if (zone > 0.8) {
          if (mode === "sports") currentSportIndex = getNextIndex(SPORTS.length, currentSportIndex);
          else if (mode === "matchups" || mode === "allLines") currentMatchupIndex = getNextIndex(currentSport().matchups.length, currentMatchupIndex);
          flipped = false;
          renderScreen();
          return;
        }

        // Center zone
        if (mode === "allLines") {
          // REQUIRED: single click center changes game (next) WITHOUT flipping
          currentMatchupIndex = getNextIndex(currentSport().matchups.length, currentMatchupIndex);
          flipped = false; // keep on front until double-click
          renderScreen();
          return;
        }

        // default: toggle flip
        flipped = !flipped;
        renderCardFlipState();
      }

      function handleDoubleClick(e) {
        const rect = cardClickArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const zone = x / rect.width;

        if (mode === "lineDetails") {
          handleGlobalBack();
          return;
        }

        if (mode === "mybias" || mode === "mylocks" || mode === "myarchives") {
          flipped = !flipped;
          renderCardFlipState();
          return;
        }

        // sports center: go to matchups
        if (mode === "sports" && zone >= 0.2 && zone <= 0.8) {
          mode = "matchups";
          currentMatchupIndex = 0;
          flipped = false;
          renderScreen();
          return;
        }

        // matchups center: go to allLines (but keep flipped false until user double-clicks again)
        if (mode === "matchups" && zone >= 0.2 && zone <= 0.8) {
          mode = "allLines";
          flipped = false;
          renderScreen();
          return;
        }

        // allLines center: flip to show lines
        if (mode === "allLines" && zone >= 0.2 && zone <= 0.8) {
          flipped = !flipped;
          renderCardFlipState();
          return;
        }

        handleSingleClick(e);
      }

      cardClickArea.addEventListener("click", (e) => {
        if (clickTimeout) {
          clearTimeout(clickTimeout);
          clickTimeout = null;
          handleDoubleClick(e);
        } else {
          clickTimeout = setTimeout(() => {
            handleSingleClick(e);
            clickTimeout = null;
          }, DOUBLE_CLICK_DELAY);
        }
      });

      /************************************************************
       * 12) MENUS
       ************************************************************/
      function buildSportsMenu() {
        sportsMenuEl.innerHTML = "";
        SPORTS.forEach((sport, sIndex) => {
          const sportItem = document.createElement("div");
          sportItem.className = "sports-menu-item";

          const title = document.createElement("div");
          title.className = "sports-menu-item-title";
          title.textContent = sport.name;
          sportItem.appendChild(title);

          const gamesSub = document.createElement("div");
          gamesSub.className = "sports-games-submenu";

          sport.matchups.forEach((matchup, mIndex) => {
            const gameItem = document.createElement("div");
            gameItem.className = "game-item";
            gameItem.textContent = matchup.name;
            gameItem.addEventListener("click", (e) => {
              e.stopPropagation();
              currentSportIndex = sIndex;
              currentMatchupIndex = mIndex;
              mode = "allLines";
              flipped = true;
              sportsMenuEl.classList.remove("open");
              renderScreen();
            });
            gamesSub.appendChild(gameItem);
          });

          sportItem.appendChild(gamesSub);
          sportsMenuEl.appendChild(sportItem);
        });
      }

      appLogoButton.addEventListener("click", (e) => {
        e.stopPropagation();
        const isOpen = sportsMenuEl.classList.contains("open");
        sportsMenuEl.classList.toggle("open", !isOpen);
      });

      function buildUserDropdown() {
        userDropdown.innerHTML = "";

        // theme toggle
        const themeItem = document.createElement("div");
        themeItem.className = "user-dropdown-item";
        const currentTheme = document.documentElement.getAttribute("data-theme") || "light";
        themeItem.innerHTML = `<span>Theme</span><span>${currentTheme === "light" ? "Light ‚úÖ" : "Dark ‚úÖ"}</span>`;
        themeItem.addEventListener("click", () => {
          const now = document.documentElement.getAttribute("data-theme") || "light";
          setTheme(now === "light" ? "dark" : "light");
          buildUserDropdown();
        });
        userDropdown.appendChild(themeItem);

        const sep0 = document.createElement("div");
        sep0.className = "user-dropdown-separator";
        userDropdown.appendChild(sep0);

        const biasItem = document.createElement("div");
        biasItem.className = "user-dropdown-item";
        biasItem.innerHTML = `<span>MyBias</span><span>‚Ä∫</span>`;
        biasItem.addEventListener("click", async () => {
          if (!requireAuthOrPrompt()) return;
          mode = "mybias";
          flipped = true;
          userDropdown.classList.remove("open");
          renderScreen();
        });
        userDropdown.appendChild(biasItem);

        const locksItem = document.createElement("div");
        locksItem.className = "user-dropdown-item";
        locksItem.innerHTML = `<span>MyLocks</span><span>‚Ä∫</span>`;
        locksItem.addEventListener("click", async () => {
          if (!requireAuthOrPrompt()) return;
          mode = "mylocks";
          flipped = true;
          userDropdown.classList.remove("open");
          renderScreen();
        });
        userDropdown.appendChild(locksItem);

        const archItem = document.createElement("div");
        archItem.className = "user-dropdown-item";
        archItem.innerHTML = `<span>MyArchives</span><span>‚Ä∫</span>`;
        archItem.addEventListener("click", async () => {
          if (!requireAuthOrPrompt()) return;
          mode = "myarchives";
          flipped = true;
          userDropdown.classList.remove("open");
          renderScreen();
        });
        userDropdown.appendChild(archItem);

        const sep = document.createElement("div");
        sep.className = "user-dropdown-separator";
        userDropdown.appendChild(sep);

        const authItem = document.createElement("div");
        authItem.className = "user-dropdown-item";
        authItem.innerHTML = `<span>${sessionUser ? "Sign out" : "Sign in"}</span><span>‚Ä∫</span>`;
        authItem.addEventListener("click", async () => {
          userDropdown.classList.remove("open");
          if (sessionUser) {
            await window.supabase.auth.signOut();
            sessionUser = null;
            viewOnly = false;
            store.itemsByKey = {};
            totalUserSwipes = 0;
            showToast("Signed out");
            authOverlay.classList.remove("hidden");
            renderScreen();
          } else {
            authOverlay.classList.remove("hidden");
          }
        });
        userDropdown.appendChild(authItem);
      }

      userMenuButton.addEventListener("click", (e) => {
        e.stopPropagation();
        const isOpen = userDropdown.classList.contains("open");
        userDropdown.classList.toggle("open", !isOpen);
      });

      function updateUserMenuLabel() {
        userMenuLabel.textContent = "My Hub";
      }

      /************************************************************
       * 13) GLOBAL CLICK (close menus + bottom-left back)
       ************************************************************/
      document.addEventListener("click", (e) => {
        const target = e.target;

        const clickedCard = cardClickArea.contains(target);
        const clickedBack = backToSportsBtn.contains(target);
        const clickedUserMenu = userMenuWrapper.contains(target);
        const clickedLogoMenu = logoGroup.contains(target);
        const clickedAuth = authOverlay.contains(target);
        const clickedModal = modalEl.contains(target);

        if (!clickedLogoMenu) sportsMenuEl.classList.remove("open");
        if (!clickedUserMenu) userDropdown.classList.remove("open");

        if (clickedCard || clickedBack || clickedUserMenu || clickedLogoMenu || clickedAuth || clickedModal) return;

        const vw = window.innerWidth;
        const vh = window.innerHeight;
        const x = e.clientX;
        const y = e.clientY;

        if (x < vw * 0.25 && y > vh * 0.75) handleGlobalBack();
      });

      /************************************************************
       * 14) AUTH FLOW
       ************************************************************/
      function exitAuthOverlay() {
        authOverlay.classList.add("hidden");
      }

      authSkipBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        viewOnly = true;
        exitAuthOverlay();
        showToast("View Only mode");
        renderScreen();
      });

      authContinueBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        e.stopPropagation();
        // Continue requires session if not viewOnly
        if (!sessionUser) {
          openModal({
            title: "Sign in required",
            body: "Please sign in first to continue (so your locks persist across devices).",
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
          return;
        }
        exitAuthOverlay();
        renderScreen();
      });

      async function handleSignIn() {
        const email = (document.getElementById("email")?.value || "").trim();
        const password = document.getElementById("password")?.value || "";
        if (!email || !password) {
          openModal({ title: "Missing info", body: "Enter email and password.", actions: [{ label: "OK", variant: "primary", onClick: () => {} }] });
          return;
        }

        const { data, error } = await window.supabase.auth.signInWithPassword({ email, password });
        if (error) {
          openModal({
            title: "Sign in failed",
            body: error.message,
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
          return;
        }

        sessionUser = data.user;
        viewOnly = false;
        await loadProfileFromDb();
        exitAuthOverlay();
        showToast("Signed in");
        renderScreen();
      }

      async function handleSignUp() {
        const email = (document.getElementById("email")?.value || "").trim();
        const password = document.getElementById("password")?.value || "";
        if (!email || !password) {
          openModal({ title: "Missing info", body: "Enter email and password.", actions: [{ label: "OK", variant: "primary", onClick: () => {} }] });
          return;
        }

        const { data, error } = await window.supabase.auth.signUp({ email, password });

        if (error) {
          openModal({
            title: "Sign up failed",
            body: error.message,
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
          return;
        }

        // If email confirmation is required, user may not be signed in yet.
        // Supabase often returns data.user but no session.
        openModal({
          title: "Account created",
          body: "If your project requires email confirmation, confirm the email first, then sign in. If you don‚Äôt get a confirmation email, disable confirmations in Supabase Auth settings or use an already confirmed account.",
          actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
        });
      }

      signInBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        handleSignIn();
      });

      signUpBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        handleSignUp();
      });

      // Keep session in sync
      window.supabase.auth.onAuthStateChange(async (_event, session) => {
        sessionUser = session?.user || null;
        if (sessionUser) {
          viewOnly = false;
          await loadProfileFromDb();
          exitAuthOverlay();
        } else {
          authOverlay.classList.remove("hidden");
        }
        renderScreen();
      });

      /************************************************************
       * 15) INIT
       ************************************************************/
      async function init() {
        initTheme();
        updateUserMenuLabel();
        buildUserDropdown();

        // attempt load session
        const sess = await window.supabase.auth.getSession();
        sessionUser = sess.data?.session?.user || null;

        if (sessionUser) {
          await loadProfileFromDb();
          exitAuthOverlay();
        } else {
          authOverlay.classList.remove("hidden");
        }

        // restore fallback store if exists
        const local = JSON.parse(localStorage.getItem("btb_local_store") || "{}");
        if (!sessionUser && local.itemsByKey) {
          store.itemsByKey = local.itemsByKey;
          totalUserSwipes = Number(local.totalUserSwipes || 0);
        }

        renderScreen();
      }

      init();
    </script>
  </body>
</html>
